<!DOCTYPE html>
<html lang="ja">
<head>
  <script data-ad-client="ca-pub-6511020045004282" async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6511020045004282",
      enable_page_level_ads: true
    });
  </script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>クラスとイベントとマルチプロセス並列処理｜VBA技術解説</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="エクセルVBAではマルチスレッドによる並列処理はサポートされていません、つまり通常は順序良く直列に処理していくしかありません。しかし処理時間が多大にかかるような処理も現実には存在しているため、エクセルVBAで並列処理したいという要望も出てきます。">
  <meta name="keywords" content="技術解説,エクセル,Excel,マクロ,VBA">
  <link rel="icon" type="image/x-icon" href="../images/favicon_excel.png">
  <link rel="stylesheet" href="../css/style.css-20210304.css" tppabs="https://excel-ubara.com/css/style.css?20210304">
  <link rel="stylesheet" href="../css/slide.css-20210304.css" tppabs="https://excel-ubara.com/css/slide.css?20210304">
  <link rel="canonical" href="https://excel-ubara.com/vba_class/VBA_CLASS_06.html" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="クラスとイベントとマルチプロセス並列処理｜VBA技術解説" />
  <meta property="og:description" content="エクセルVBAではマルチスレッドによる並列処理はサポートされていません、つまり通常は順序良く直列に処理していくしかありません。しかし処理時間が多大にかかるような処理も現実には存在しているため、エクセルVBAで並列処理したいという要望も出てきます。" />
  <meta property="og:image" content="https://excel-ubara.com/vba_class/image166.jpg" />
  <meta property="og:url" content="https://excel-ubara.com/vba_class/VBA_CLASS_06.html" />
  <meta property="og:site_name" content="エクセルの神髄" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="クラスとイベントとマルチプロセス並列処理｜VBA技術解説" />
  <meta name="twitter:description" content="エクセルVBAではマルチスレッドによる並列処理はサポートされていません、つまり通常は順序良く直列に処理していくしかありません。しかし処理時間が多大にかかるような処理も現実には存在しているため、エクセルVBAで並列処理したいという要望も出てきます。" />
  <meta name="twitter:image" content="https://excel-ubara.com/vba_class/image166.jpg" />
  <meta name="twitter:site" content="@yamaoka_ss" />
  <script src="../../code.jquery.com/jquery-3.3.1.min.js" tppabs="https://code.jquery.com/jquery-3.3.1.min.js" async></script>
  <script type="text/javascript" src="../js/fix.js" tppabs="https://excel-ubara.com/js/fix.js" async></script>
  <script type="text/javascript" src="../js/fixmenu_pagetop.js-20210304" tppabs="https://excel-ubara.com/js/fixmenu_pagetop.js?20210304" async></script>
  <script type="text/javascript" src="../js/CopyDisp.js-20210304" tppabs="https://excel-ubara.com/js/CopyDisp.js?20210304" async></script>
</head>

<body class="c2">
  <header>
    <div class="inner">
      <p id="logo"><a href="../index.htm" tppabs="https://excel-ubara.com/"><img src="../images/logo.png" tppabs="https://excel-ubara.com/images/logo.png" alt="エクセルの神髄"></a></p>
      <div id="contact">
        <h1>VBA技術解説<br>クラスとイベントとマルチプロセス並列処理</h1>ExcelマクロVBAの問題点と解決策、VBAの技術的解説
      </div>
    </div>
  </header>

  <!--PC用（801px以上端末）メニュー-->
  <nav id="dropmenu">
    <ul class="inner">
      <li><a href="../excel_index.html" tppabs="https://excel-ubara.com/excel_index.html">Excel全般<span>Excel</span></a>
        <ul>
          <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
          <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
          <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
          <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
          <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
          <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
        </ul>
      </li>
      <li><a href="../excel_vba1.html" tppabs="https://excel-ubara.com/excel_vba1.html">マクロVBA入門編<span>VBA Beginner</span></a>
        <ul>
          <li><a href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</a></li>
          <li><a href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</a></li>
          <li><a href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</a></li>
          <li><a href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</a></li>
          <li><a href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</a></li>
          <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
          <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
        </ul>
      </li>
      <li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編<span>VBA Advanced</span></a>
        <ul>
          <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
          <li><A href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
          <li><A href="../excelvba5/index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
          <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
          <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
          <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
        </ul>
      </li>
      <li><a href="../excel_other.html" tppabs="https://excel-ubara.com/excel_other.html">その他（Excel以外）<span>Other than Excel</span></a>
        <ul>
          <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">Python入門</A></li>
          <li><A href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">SQL入門</A></li>
          <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">スプレッドシート入門</A></li>
          <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">GAS入門</A></li>
        </ul>
      </li>
      <li><a href="../siteguide.html" tppabs="https://excel-ubara.com/siteguide.html">サイト案内<span>site map</span></a>
        <ul>
          <li><A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧</A></li>
          <li><A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">アクセスランキング</A></li>
          <li><A href="../sitemap.html" tppabs="https://excel-ubara.com/sitemap.html">サイトマップ&nbsp;&nbsp;</A></li>
          <li><a href="../business/index.htm" tppabs="https://excel-ubara.com/business/">旧トップページ&nbsp;&nbsp;</a></li>
          <li><A href="../query.html" tppabs="https://excel-ubara.com/query.html">お問い合わせ&nbsp;&nbsp;</A></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="pan"><ul itemscope itemtype="http://schema.org/BreadcrumbList">
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="../index.htm" tppabs="https://excel-ubara.com/">
<span itemprop="name">ホーム</span></a>
<meta itemprop="position" content="1" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">
<span itemprop="name">マクロVBA応用編</span></a>
<meta itemprop="position" content="2" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="index.htm" tppabs="https://excel-ubara.com/vba_class/">
<span itemprop="name">VBAクラス入門</span></a>
<meta itemprop="position" content="3" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="VBA_CLASS_06.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_06.html">
<span itemprop="name">クラスとイベントとマルチプロセス並列処理</span></a>
<meta itemprop="position" content="4" />
</li>
</ul></div>
  <div class="ads1">
    <center>
    <script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- yama21 -->
    <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-6511020045004282"
        data-ad-slot="1104944574"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    </center>
  </div>

  <div id="contents" class="inner">
    <div id="contents-in">
      <div id="main">
        <section>
          <span style="line-height:20px;float:right" align="right">最終更新日：2020-03-27</span>
<h2 align="center">クラスとイベントとマルチプロセス並列処理</h2><br><a href="image166.jpg" tppabs="https://excel-ubara.com/vba_class/image166.jpg" target="_blank"><img src="image166.jpg" tppabs="https://excel-ubara.com/vba_class/image166.jpg" width="360" height="360" style="float:right;margin: 0px 10px 10px 10px;" border="0" alt="マクロ VBA マルチタスク"></a><p>エクセルVBAではマルチスレッドによる並列処理はサポートされていません、<br>つまり通常は順序良く直列に処理していくしかありません。<br>しかし処理時間が多大にかかるような処理も現実には存在しているため、<br>エクセルVBAで並列処理したいという要望も出てきます。<br><div class="br2"><br></div>
「VBA マルチスレッド」「VBA マルチプロセス」これらで検索すると<br>
VBAからVBScriptを起動して時間のかかる処理を行い、その結果をエクセルで取得するというようなものが多くヒットします。<br><div class="br2"><br></div>
そこに以下のブログが登場しました。<br>
<a href="javascript:if(confirm('https://www.excel-chunchun.com/entry/2019/03/27/005233  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://www.excel-chunchun.com/entry/2019/03/27/005233'" tppabs="https://www.excel-chunchun.com/entry/2019/03/27/005233" target="_blank">Excelブック単体でExcelVBAを疑似マルチスレッド化してみる</a><br>
※運営者さんはTwitterで知っていたのでプログ掲載を直ぐに知りました。<br><div class="br2"><br></div>
もともとVBAでは自身のアプリケーション内ではなく、別アプリケーション（別プロセス）でExcelを起動させてブックを開くことができます。<br>
これはOLEオートメーションと呼ばれていますが、複数のプロセスを起動できるのでマルチプロセスと言って良いものになります。<br>
つまりマルチプロセス自体はVBAとしてサポートされていると言えるのです。<br>
しかしながら別のプロセスとして起動しても常に連携されているため、別プロセスのエクセルに対して何らかの命令を行ったときは処理待ちとなってしまいます。<br>
つまり、そのままではマルチスレッドのような並列処理はできないということです。<br>
上記のブログでは、この問題を解決するため、<br>
Application.OnTimeを使うことで別起動したエクセルを切り離してしまおうという発想しています。<br><div class="br2"><br></div>
VBAをある程度やっている人なら、知っている人も多いでしょうが、<br>
Application.OnTimeはタイマー起動されるため、今動いているVBAとは全く別に動き出します。<br>
（ただし同時に並列動作はしません、実行中があればその後に実行されます。）<br>
しかしその起動自体は、元のOnTime実行したプロシージャーとは切り離されて実行予約されます。<br>
これを並列処理（マルチスレッド化）に利用しようというのが他にはない新しい発想になっています。<br><div class="br2"><br></div>
<strong>Application.OnTimeについて
</strong>
<div class="main-indent"><strong><a href="../excelvba1/EXCELVBA420.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA420.html">第120回．OnTimeメソッド</a></strong><div class="details">指定された時刻にマクロを実行させたい時、今から一定時間後にマクロVBAを実行させたい時、このような時に使うのが、OnTimeメソッドです。お昼になったらExcelが教えてくれたり、1時間経ったらExcelが教えてくれるといったことが、このOnTimeメソッドを使用するで実現出来ます。</div><br>
    <strong><a href="../excelvba4/EXCEL255.html" tppabs="https://excel-ubara.com/excelvba4/EXCEL255.html">文字列としてのプロシージャー名を起動する方法（Run,OnTime）</a></strong><div class="details">文字列変数の中にプロシージャー名が入っていて、そのプロシージャーを起動したい場合になります、実際には、そのような構造が良いとは思えませんが、知っていればプログラミングの幅が広がります。使うのは、OnTimeメソッドorRunメソッドになります。</div><br>
    <strong><a href="../excelvba5/EXCEL104.html" tppabs="https://excel-ubara.com/excelvba5/EXCEL104.html">時刻になったら音を鳴らして知らせる（OnTime）</a></strong><div class="details">エクセル作業に夢中になって、時間を忘れて大慌てって事ありませんか。えっ、無い、そうですか、ではさようなら… あると言う人は以下のプログラムをどうぞ。作成するシート まず、以下ようなシートを作ります。標準モジュールのVBAコード 標準モジュールに以下を追加します。</div><br>
OnTimeの動作を確認する場合は、「時刻になったら音を鳴らして知らせる」が良いでしょう。<br>
時刻になるまではExcelの作業は何の支障もなく普通に行えます。<br>
もちろんマクロも普通に実行できます。<br>
そして時刻が来ると、突然マクロが起動され音が鳴ります。</div><p><br>
<strong>マルチスレッド、マルチプロセス </strong><div class="main-indent">言葉の定義としては、本来これらは別のものになります。<br>
しかし、厳密に区分けすることなくどちらでも使われている場合が多いと思います。<br>
本記事では、マルチプロセスと言ったほうがより正しいかなと思い、タイトルはマルチスレッドではなくマルチプロセスとしています。<br>
ただし、そもそも別アプリケーション（別プロセス）でExcelを起動した時点でマルチプロセスであるのだから、<br>
先のブログの「疑似マルチスレッド化」という表現は、非常に内容をうまく表現していると思います。</div><p><br>
<strong>先に言っておきたい重要なこと</strong></p>
<div class="main-indent">先に申し上げておきますが、決してこのような方法を推奨しているわけではありません。<br>
あくまで技術的なサンプルとして方法論の一つとして紹介しているものです。<br>
むしろ、技術的な興味が優先されたVBAとなっていることを先にお断りしておきます。<br>
あくまで、こんな事できるかなーという試験的なVBAだとご理解ください。<br><div class="br2"><br></div>
そもそも論としては、並列処理しなければならない程の処理時間がかかるのら、<br>
その処理自体を見直していくべきものですし、<br>
昨今の事情でいえばPC自体はそんなに高価なものではなくなっていますので、<br>
1台の空きPCを用意して、そこで処理すれば済んでしまう場合も多いはずです。<br><div class="br2"><br></div>
今回掲載のVBAコードはかなり危険なものです。<br>
危険というのは、常に安定動作するかどうかと言うことです。<br>
コンピューター処理で最も注意すべきことは、その処理が正しく行われたかどうかということです。<br>
自動化されても、それが正しくなければ全く意味がないどころか害悪にしかなりません。<br>
業務のコンピューター処理では、安全確実かつ確認しやすいシステムを優先すべきだと思います。<br><div class="br2"><br></div>
</div>
<H3><strong>クラスとイベントとマルチプロセス並列処理の概要</strong></H3>
<div class="main-indent">OnTimeを全面的に使いながら、別プロセスとの間でデータのやり取りをしようと考えたものです。<br>
VBScriptを使用したマルチプロセスでは、結果の取得は別途出力したファイルを使うことになります。<br>
当然それで何も問題はないのですが、せっかく単体エクセルだけで並列処理化できるのなら、<br>
その単体エクセルの中だけで全て完結させてしまおうという発想になります。<br><div class="br2"><br></div>
全体の簡単（大雑把）な流れは以下になります。<br><div class="br2"><br></div><br>
<div class="ads1">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="6991829975"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div><br><div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>メインプロセス（親プロセス）</td>
      <td>&nbsp;</td>
      <td>サブプロセス（子プロセス）</td>
    </tr>
    <tr>
      <td valign="top">クラスのインスタンス作成<br>
      クラスの初期処理でNew Excel.Application<br>
      ↓<br>
      サブに対してブック読み込み<br>↓<br>
      サブのプロシージャ起動<br><div class="br2"><br></div>
      一旦終了し、OnTimeで次を起動<br>↓<br>
      －－－ここで一旦終了－－－<br><div class="br2"><br></div>
      OnTimeのプロシージャー起動<br>
      ↓↑<br>
      一定時間毎にサブ完了チェックし続ける<br><div class="br2"><br></div>
      クラスでブックCloseのイベント補足<br>
      ↓<br>
      サブのブックより結果情報を取得<br>↓<br>
      サブを破棄</td>
      <td valign="top" align="center"><br>
      →<br><div class="br2"><br></div>
→<br><div class="br2"><br></div>
      →<br><div class="br2"><br></div>
      ←<br><div class="br2"><br></div><br>
<div class="br2"><br></div><br>
<div class="br2"><br></div><br>
<div class="br2"><br></div>
      ←<br>
      </td>
      <td valign="top"><br>
      別プロセス開始<br><div class="br2"><br></div>
      クラス内でブックを読み込む<br><div class="br2"><br></div>
      起動直後にOnTimeで次を起動<br>↓<br>
      －－－ここで一旦終了－－－<br><div class="br2"><br></div>
      OnTimeのプロシージャー起動<br>↓<br>
      時間のかかる処理を行う<br>
      ↓<br>
      ↓<br>↓<br>
      ブックCloseでイベント発生<br><div class="br2"><br></div><br>
<div class="br2"><br></div>
      ブックが閉じられプロセス終了</td>
    </tr>
  </tbody>
</table></div><br>
上記処理を必要な処理数分繰り返すことになります。<br>
実際のVBAでは、同時最大プロセス数を管理しつつ、<br>
空きが出たら順次プロセスを開始するようにしています。<br><div class="br2"><br></div>
メイン（親）側の要点としては、<br>
起動プロシージャーは先に抜ける（一旦終了する）ようにして、終了前のOnTimeで次の処理を予約しておく。<br>
プロシージャー実行中はイベントを受け取れないので、プロシージャーを抜けて未実行状態にする必要があるためです。<br><div class="br2"><br></div>
サブ（子）側の要点としては、<br>
メインからプロシージャーが起動されたら、直ぐにOnTimeで次のプロシージャーを起動することでメインに制御を返します。<br>
OnTimeで次のプロシージャーを起動しないと、その処理が終わるまでメインが待ち状態になるためです。<br><div class="br2"><br></div>
</div>
<H3><strong>VBAの全コード </strong></H3>
<div class="main-indent">VBAコードの個別の解説はいたしません。<br>
それでも、VBA内の随所にコメントは入れてありますので参考にしてください。<br><div class="br2"><br></div>
<strong>標準モジュール</strong><br><div class="br2"><br></div>
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Declare PtrSafe Sub Sleep Lib &quot;kernel32&quot; (ByVal dwMilliseconds As Long)<br><div class="br2"><br></div>
<span style="color:#009900;">'テスト実行：最大待ち時間の有効等の切り替え</span><br>
Private Const isTest As Boolean = True<br>
<span style="color:#009900;">'結果出力のタイミング：全て一括かプロセス毎か</span><br>
Private Const isTransaction As Boolean = False<br><div class="br2"><br></div>
<span style="color:#009900;">'プロセス起動方法の設定</span><br>
Private Const AllProc As Integer = 10　 <span style="color:#009900;">'総プロセス数</span><br>
Private Const MaxProc As Integer = 4　　<span style="color:#009900;">'同時最大プロセス数</span><br>
Private Const MaxWait As Integer = 180　<span style="color:#009900;">'最大待ち分数</span><br>
Private Const iInterval As Integer = 1　<span style="color:#009900;">'進捗確認間隔秒</span><br><div class="br2"><br></div>
Private CLS() As clsASync　　　　　　　 <span style="color:#009900;">'並列処理させるクラス</span><br>
Private ActFlg() As Integer　　　　　　 <span style="color:#009900;">'プロセス稼働中判定</span><br>
Private mRtn As Collection　　　　　　　<span style="color:#009900;">'処理結果の一時格納</span><br>
Private wsRtn As Worksheet　　　　　　　<span style="color:#009900;">'結果シート</span><br>
Private isEnd As Boolean　　　　　　　　<span style="color:#009900;">'処理完了判定</span><br>
Private OnTime1Time As Date　　　　　　 <span style="color:#009900;">'進捗確認OnTime起動時刻</span><br>
Private OnTime2Time As Date　　　　　　 <span style="color:#009900;">'最大待ちOnTime起動時刻</span><br><div class="br2"><br></div>
<span style="color:#009900;">'これが起動メイン</span><br>
Public Sub StartMain()<br>
　　<span style="color:#009900;">'開発中のトラブル防止</span><br>
　　ThisWorkbook.Save<br>
　　<br>
　　<span style="color:#009900;">'モジュールレベル変数初期化・設定</span><br>
　　isEnd = False<br>
　　Erase ActFlg<br>
　　Set mRtn = New Collection<br>
　　ReDim CLS(1 To AllProc)<br>
　　ReDim ActFlg(1 To AllProc)<br>
　　<br>
　　<span style="color:#009900;">'先にこのプロシージャーが終わってしまうので、</span><br>
　　<span style="color:#009900;">'イベントによる終了待ちの間、実行中に見せかける</span><br>
　　Call SetRunning(True)<br>
　　<span style="color:#009900;">'結果シートの初期設定</span><br>
　　Set wsRtn = ThisWorkbook.Worksheets(&quot;結果&quot;)<br>
　　Call InitializeOutSheet<br>
　　<br>
　　<span style="color:#009900;">'プロセスを順次起動、最初なので最大数まで一気に</span><br>
　　Dim iProc As Integer<br>
　　For iProc = 1 To MaxProc<br>
　　　　Call StartProcess<br>
　　Next<br>
　　<br>
　　<span style="color:#009900;">'これ以降の動作はタイマーとイベント処理</span><br>
　　<span style="color:#009900;">'応答も含め長時間停止は基本的にダメ</span><br>
　　<br>
　　<span style="color:#009900;">'指定秒毎に進捗確認</span><br>
　　Call IntervalConfirm<br>
　　<span style="color:#009900;">'最大待ち時間で強制終了、テスト時の困った対策</span><br>
　　If isTest Then<br>
　　　　OnTime2Time = Now() + TimeSerial(0, MaxWait, 0)<br>
　　　　Application.OnTime OnTime2Time, &quot;TimeOverProc&quot;<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'終了時刻の表示</span><br>
　　wsRtn.Cells(3, 3) = Now()<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'指定間隔ごとにプロセス数の確認</span><br>
Private Sub IntervalConfirm(Optional ByVal ReStart As Boolean = True)<br>
　　<span style="color:#009900;">'あくまで念の為</span><br>
　　If Not CheckProcess Then<br>
　　　　Call TimeOverProc(&quot;プロセス間の通信が途切れました。&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　　　　　　　&quot;強制終了します。&quot;)<br>
　　　　Exit Sub<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'進捗状況の表示</span><br>
　　Dim cnt As Integer<br>
　　Dim iProc As Integer<br>
　　Dim sTemp As String<br>
　　cnt = GetProcessCount<br>
　　iProc = GetFreeProcess<br>
　　sTemp = cnt &amp; &quot; : &quot; &amp; IIf(iProc = 0, AllProc, iProc - 1) &amp; _<br>
　　　　　　　　　　　　　&quot;/&quot; &amp; AllProc<br>
　　If wsRtn.Range(&quot;B1&quot;).Value &lt;&gt; sTemp Then<br>
　　　　wsRtn.Range(&quot;B1&quot;).Value = sTemp<br>
　　　　Select Case cnt<br>
　　　　　　Case Is &gt; MaxProc<br>
　　　　　　　　wsRtn.Range(&quot;C1&quot;) = &quot;オーバー？&quot;<br>
　　　　　　Case Is = MaxProc<br>
　　　　　　　　wsRtn.Range(&quot;C1&quot;) = &quot;最大プロセス稼働中&quot;<br>
　　　　　　Case Else<br>
　　　　　　　　If cnt = 0 And iProc = 0 Then<br>
　　　　　　　　　　wsRtn.Range(&quot;C1&quot;) = &quot;完了&quot;<br>
　　　　　　　　ElseIf iProc = 0 Then<br>
　　　　　　　　　　wsRtn.Range(&quot;C1&quot;) = &quot;プロセス順次終了中&quot;<br>
　　　　　　　　Else<br>
　　　　　　　　　　wsRtn.Range(&quot;C1&quot;) = &quot;プロセス順次起動中&quot;<br>
　　　　　　　　　　Call ReDraw<br>
　　　　　　　　　　If iProc &gt; 0 Then Call StartProcess<br>
　　　　　　　　End If<br>
　　　　End Select<br>
　　　　Call ReDraw<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'次のOnTimeを実行</span><br>
　　If Not ReStart Then Exit Sub<br>
　　If isEnd Then Exit Sub<br>
　　If GetProcessCount = 0 And GetFreeProcess = 0 Then Exit Sub<br>
　　OnTime1Time = Now() + TimeSerial(0, 0, iInterval)<br>
　　Application.OnTime OnTime1Time, &quot;IntervalConfirm&quot;<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'空き番号を探してプロセスを開始する</span><br>
Private Function StartProcess() As Boolean<br>
　　If GetProcessCount &gt;= MaxProc Then Exit Function<br>
　　Dim iProc As Integer<br>
　　StartProcess = False<br>
　　iProc = GetFreeProcess<br>
　　If iProc = 0 Then Exit Function<br>
　　<br>
　　<span style="color:#009900;">'プロセス起動</span><br>
　　Set CLS(iProc) = New clsASync<br>
　　ActFlg(iProc) = 1<br>
　　CLS(iProc).Index = iProc<br>
　　CLS(iProc).OpenBook = ThisWorkbook.FullName<br>
　　CLS(iProc).AsyncProc = &quot;ChildProc&quot;<br>
　　CLS(iProc).BeforeCloseProc = &quot;BeforeCloseProc&quot;<br>
　　CLS(iProc).DeactivateProc = &quot;DeactivateProc&quot;<br>
　　Call IntervalConfirm(False)<br>
　　CLS(iProc).StartOnTime<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'ここが動いて本当の終わり</span><br>
Private Sub EndMain()<br>
　　On Error Resume Next<br>
　　<span style="color:#009900;">'待ち状態のOnTimeのをキャンセル</span><br>
　　Application.OnTime OnTime1Time, &quot;IntervalConfirm&quot;, , False<br>
　　If isTest Then Application.OnTime OnTime2Time, &quot;TimeOverProc&quot;, , False<br>
　　<br>
　　<span style="color:#009900;">'完了表示</span><br>
　　Call IntervalConfirm<br>
　　wsRtn.Cells(4, 3) = Now()<br>
　　Call SetRunning(False)<br>
　　MsgBox &quot;完了&quot;<br>
　　<br>
　　<span style="color:#009900;">'念の為、最後のダメ押しをやっておく</span><br>
　　On Error Resume Next<br>
　　Dim i As Integer<br>
　　For i = LBound(CLS) To UBound(CLS)<br>
　　　　Set CLS(i) = Nothing<br>
　　Next<br>
　　Erase CLS<br>
　　<br>
　　End <span style="color:#009900;">'色々な意味でリセットしておく</span><br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'結果出力シートの初期設定</span><br>
Private Sub InitializeOutSheet()<br>
　　With wsRtn<br>
　　　　.Select<br>
　　　　.Cells.Clear<br>
　　　　.Cells(2, 1) = &quot;メイン&quot;<br>
　　　　.Cells(2, 2) = &quot;開始&quot;<br>
　　　　.Cells(2, 3) = Now()<br>
　　　　.Cells(3, 1) = &quot;メイン&quot;<br>
　　　　.Cells(3, 2) = &quot;終了&quot;<br>
　　　　.Cells(4, 1) = &quot;全体&quot;<br>
　　　　.Cells(4, 2) = &quot;終了&quot;<br>
　　　　.Columns(3).NumberFormatLocal = &quot;yyyy/mm/dd/ hh:mm:ss&quot;<br>
　　　　.Range(&quot;A1&quot;) = &quot;プロセス数&quot;<br>
　　　　.Range(&quot;A1&quot;).Select<br>
　　　　Call ReDraw<br>
　　End With<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'結果シートに出力</span><br>
Private Sub OutputReturn()<br>
　　Dim varRtn As Variant<br>
　　Dim myRange As Range<br>
　　Dim varTmp As Variant<br>
　　Dim i As Long<br>
　　<br>
　　<span style="color:#009900;">'ここは格納方法が無限にあり得るので適宜変更してください。</span><br>
　　<span style="color:#009900;">'子プロセス側の格納に合わせて取り出す必要があります。</span><br>
　　<span style="color:#009900;">'ある程度汎用的に書いても全てを網羅することはできないので、</span><br>
　　<span style="color:#009900;">'以下ではサンプルとして単純なものにしています。</span><br>
　　For Each varRtn In mRtn<br>
　　　　<span style="color:#009900;">'最終行の一つ下</span><br>
　　　　Set myRange = wsRtn.Cells(wsRtn.Rows.Count, 1).End(xlUp).Offset(1)<br>
　　　　<span style="color:#009900;">'データタイプ別処理：Caseは適宜追加</span><br>
　　　　Select Case TypeName(varRtn)<br>
　　　　　　Case &quot;Variant()&quot;, &quot;String()&quot; <span style="color:#009900;">'配列：必要に応じて追加</span><br>
　　　　　　　　Select Case GetDimension(varRtn) <span style="color:#009900;">'次元数</span><br>
　　　　　　　　　　Case 1<br>
　　　　　　　　　　　　myRange.Resize(, UBound(varRtn)) = varRtn<br>
　　　　　　　　　　Case 2<br>
　　　　　　　　　　　　myRange.Resize(UBound(varRtn, 1), UBound(varRtn, 2)) = varRtn<br>
　　　　　　　　　　Case 3<br>
　　　　　　　　　　　　<span style="color:#009900;">'さすがに必要ないと思うけど</span><br>
　　　　　　　　End Select<br>
　　　　　　Case &quot;Collection&quot; <span style="color:#009900;">'コレクション</span><br>
　　　　　　　　i = 0<br>
　　　　　　　　For Each varTmp In varRtn<br>
　　　　　　　　　　myRange.Offset(, i) = varTmp<br>
　　　　　　　　　　i = i + 1<br>
　　　　　　　　Next<br>
　　　　　　Case &quot;Dictionary&quot; <span style="color:#009900;">'ディクショナリー</span><br>
　　　　　　　　i = 0<br>
　　　　　　　　For Each varTmp In varRtn.Keys<br>
　　　　　　　　　　If i &lt;= 1 Then<br>
　　　　　　　　　　　　myRange.Offset(, i) = varRtn.Item(varTmp)<br>
　　　　　　　　　　Else<br>
　　　　　　　　　　　　myRange.Offset(, i) = varTmp &amp; &quot;:&quot; &amp; varRtn.Item(varTmp)<br>
　　　　　　　　　　End If<br>
　　　　　　　　　　i = i + 1<br>
　　　　　　　　Next<br>
　　　　　　Case &quot;Nothing&quot;, &quot;Empty&quot;<br>
　　　　　　　　<span style="color:#009900;">'結果なしはそれなりの対応</span><br>
　　　　　　Case Else<br>
      　　　　　　　　<span style="color:#009900;">'必要なら適宜記載</span><br>
　　　　End Select<br>
　　Next<br>
　　<br>
　　<span style="color:#009900;">'結果保存のコレクションのクリア</span><br>
　　If isTransaction Then<br>
　　　　Set mRtn = Nothing<br>
　　Else<br>
　　　　Set mRtn = New Collection<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'配列の次元数取得</span><br>
Private Function GetDimension(ByRef argAry) As Integer<br>
　　Dim intDim As Integer<br>
　　Dim tmpDim As Integer<br>
　　intDim = 0<br>
　　On Error Resume Next<br>
　　Do While Err.Number = 0<br>
　　　　intDim = intDim + 1<br>
　　　　<span style="color:#009900;">'これがエラーになった時点で配列が終わり</span><br>
　　　　tmpDim = UBound(argAry, intDim)<br>
　　Loop<br>
　　Err.Clear<br>
　　On Error GoTo 0<br>
　　GetDimension = intDim - 1<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'空きプロセス番号取得</span><br>
Private Function GetFreeProcess() As Integer<br>
　　Dim i As Integer<br>
　　Dim iProc As Integer<br>
　　iProc = 0<br>
　　For i = LBound(ActFlg) To UBound(ActFlg)<br>
　　　　If ActFlg(i) = 0 Then<br>
　　　　　　iProc = i<br>
　　　　　　Exit For<br>
　　　　End If<br>
　　Next<br>
　　GetFreeProcess = iProc<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'稼働プロセス数取得</span><br>
Private Function GetProcessCount() As Integer<br>
　　GetProcessCount = 0<br>
　　If isEnd Then Exit Function<br>
　　Dim i As Integer<br>
　　For i = LBound(ActFlg) To UBound(ActFlg)<br>
　　　　If ActFlg(i) &gt;= 1 And ActFlg(i) &lt; 999 Then<br>
　　　　　　GetProcessCount = GetProcessCount + 1<br>
　　　　End If<br>
　　Next<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'プロセス間通信が正しいかの確認</span><br>
<span style="color:#009900;">'無難に進めば必要ないのでトラブル対応の意味として</span><br>
Private Function CheckProcess() As Boolean<br>
　　Dim i As Integer<br>
　　For i = LBound(ActFlg) To UBound(ActFlg)<br>
　　　　Select Case ActFlg(i)<br>
　　　　　　Case 0 <span style="color:#009900;">'未実行</span><br>
　　　　　　Case 999 <span style="color:#009900;">'正常終了</span><br>
　　　　　　Case 1, 2, 3, 4, 5, 6, 7, 8, 9 <span style="color:#009900;">'実行中</span><br>
　　　　　　　　<span style="color:#009900;">'1は正常、2～9は猶予</span><br>
　　　　　　　　If CLS(i) Is Nothing Then<br>
　　　　　　　　　　ActFlg(i) = ActFlg(i) + 1<br>
　　　　　　　　ElseIf CLS(i).xlApp Is Nothing Then<br>
　　　　　　　　　　ActFlg(i) = ActFlg(i) + 1<br>
　　　　　　　　ElseIf CLS(i).WorkBooksCount = 0 Then<br>
　　　　　　　　　　ActFlg(i) = ActFlg(i) + 1<br>
　　　　　　　　End If<br>
　　　　　　Case Else <span style="color:#009900;">'異常判定</span><br>
　　　　　　　　ActFlg(i) = -1<br>
　　　　　　　　CheckProcess = False<br>
　　　　　　　　Exit Function<br>
　　　　End Select<br>
　　Next<br>
　　CheckProcess = True<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'実行中状態の設定</span><br>
Private Sub SetRunning(ByVal isRunning As Boolean)<br>
　　If isRunning Then<br>
　　　　Application.Cursor = xlWait<br>
　　　　Application.EnableEvents = False<br>
　　　　<span style="color:#009900;">'テスト時はInteractive止めると面倒なので</span><br>
　　　　If Not isTest Then Application.Interactive = False<br>
　　Else<br>
　　　　Application.Cursor = xlDefault<br>
　　　　Application.EnableEvents = True<br>
　　　　Application.Interactive = True<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'強制的に再描画させる</span><br>
Private Sub ReDraw()<br>
　　Application.ScreenUpdating = True<br>
　　DoEvents<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'テスト時に万一終わらないときの用心</span><br>
Private Sub TimeOverProc(Optional ByVal argMsg As String = &quot;&quot;)<br>
　　On Error Resume Next<br>
　　isEnd = True<br>
　　Call OutputReturn<br>
　　Call SetRunning(False)<br>
　　Application.OnTime OnTime1Time, &quot;IntervalConfirm&quot;, , False<br>
　　If isTest Then Application.OnTime OnTime2Time, &quot;TimeOverProc&quot;, , False<br>
　　Dim i As Integer<br>
　　For i = LBound(CLS) To UBound(CLS)<br>
　　　　Set CLS(i) = Nothing<br>
　　Next<br>
　　Erase CLS<br>
　　If argMsg = &quot;&quot; Then<br>
　　　　argMsg = &quot;要確認：タイムオーバー（&quot; &amp; MaxWait &amp; &quot;分）&quot;<br>
　　End If<br>
　　MsgBox argMsg, vbOKOnly + vbExclamation, &quot;TimeOverProc&quot;<br>
　　End<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'***** 以下は、子プロセスのイベント発生で呼ばれる *****</span><br><div class="br2"><br></div>
<span style="color:#009900;">'子プロセスのブック・シートにアクセスして情報取得</span><br>
Public Sub BeforeCloseProc(ByVal iProc As Integer)<br>
　　If isEnd Then Exit Sub<br>
　　With CLS(iProc).wb<br>
　　　　<span style="color:#009900;">'子プロセスのシートを直接参照</span><br>
　　　　mRtn.Add .Worksheets(1).UsedRange.Value<br>
　　　　<span style="color:#009900;">'子プロセスより1次元配列を受け取る</span><br>
　　　　mRtn.Add CLS(iProc).GetArray<br>
　　　　<span style="color:#009900;">'子プロセスよりコレクションを受け取る</span><br>
　　　　mRtn.Add CLS(iProc).GetCollection<br>
　　　　<span style="color:#009900;">'子プロセスよりディクショナリーを受け取る</span><br>
　　　　mRtn.Add CLS(iProc).GetDictionary<br>
　　End With<br>
　　<span style="color:#009900;">'結果シートに出力</span><br>
　　If Not isTransaction Then Call OutputReturn<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'BeforeCloseで出力情報は取得したので終わらせる</span><br>
Public Sub DeactivateProc(ByVal iProc As Integer)<br>
　　<span style="color:#009900;">'最後のブックの時だけ、実際は最後しか入ってこないはず</span><br>
　　If CLS(iProc).WorkBooksCount &lt;= 1 Then<br>
　　　　<span style="color:#009900;">'クラスの解放はOnTimeの後で</span><br>
　　　　Application.OnTime Now(), &quot;'EventTerminate&quot;&quot;&quot; &amp; iProc &amp; &quot;&quot;&quot;'&quot;<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'クラスを確実に解放するためここで行う</span><br>
Public Sub EventTerminate(ByVal iProc As Integer)<br>
　　Sleep 100 <span style="color:#009900;">'待たせる必要があるのか、、、</span><br>
　　CLS(iProc).xlApp.Quit<br>
　　Set CLS(iProc).xlApp = Nothing<br>
　　Set CLS(iProc) = Nothing<br>
　　ActFlg(iProc) = 999<br>
　　If GetProcessCount = 0 And GetFreeProcess = 0 Then<br>
　　　　If isEnd Then Exit Sub<br>
　　　　isEnd = True<br>
　　　　Call OutputReturn<br>
　　　　Call EndMain<br>
　　End If<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br><div class="br2"><br></div>
<div class="ads1">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="7467492230"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div><br><form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private RtnArray As Variant　　 <span style="color:#009900;">'1次元配列用</span><br>
Private RtnCollection As Object <span style="color:#009900;">'コレクション用</span><br>
Private RtnDictionary As Object <span style="color:#009900;">'ディクショナリー用</span><br><div class="br2"><br></div>
<span style="color:#009900;">'1次元配列を戻す</span><br>
Public Function PassArray(ByVal arg As Variant) As Variant<br>
　　PassArray = RtnArray<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'コレクションを戻す</span><br>
Public Function PassCollection(ByVal arg As Variant) As Object<br>
　　Set PassCollection = RtnCollection<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'ディクショナリーを戻す</span><br>
Public Function PassDictionary(ByVal arg As Variant) As Object<br>
　　Set PassDictionary = RtnDictionary<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'別プロセス（子ブック）の入り口</span><br>
Public Sub ChildProc(ByVal iProc As Integer)<br>
　　<span style="color:#009900;">'いかなる応答も基本的にはダメ</span><br>
　　<span style="color:#009900;">'メッセージ等を出さないようにVBAを書くように</span><br>
　　Application.DisplayAlerts = False<br>
　　<br>
　　<span style="color:#009900;">'開始時刻保存</span><br>
　　Dim startTime As Date<br>
　　startTime = Now()<br>
　　<br>
　　<span style="color:#009900;">'DuumyProcがいきなり重い処理の場合を考慮して少し待ち</span><br>
　　DoEvents: Sleep 100: DoEvents<br>
　　<br>
　　<span style="color:#009900;">'テスト用の適当な処理</span><br>
　　Call DuumyProc(iProc)<br>
　　<br>
　　<span style="color:#009900;">'結果を戻すシートを作成、内容はテスト確認用</span><br>
　　With ThisWorkbook<br>
　　　　<span style="color:#009900;">'とりあえず先頭シートに決め打ち</span><br>
　　　　With .Worksheets.Add(Before:=.Worksheets(1))<br>
　　　　　　.Name = &quot;プロセス&quot; &amp; iProc<br>
　　　　　　.Cells(1, 1) = &quot;プロセス&quot; &amp; iProc<br>
　　　　　　.Cells(1, 2) = &quot;開始&quot;<br>
　　　　　　.Cells(1, 3) = startTime<br>
　　　　　　.Cells(2, 1) = &quot;プロセス&quot; &amp; iProc<br>
　　　　　　.Cells(2, 2) = &quot;終了&quot;<br>
　　　　　　.Cells(2, 3) = Now()<br>
　　　　End With<br>
　　End With<br>
　　<br>
　　<span style="color:#009900;">'処理が終わったのでブックを閉じてイベント発生させる</span><br>
　　Application.DisplayAlerts = False<br>
　　Application.EnableEvents = False<br>
　　Dim wb As Workbook<br>
　　For Each wb In Application.Workbooks<br>
　　　　If wb.Name &lt;&gt; ThisWorkbook.Name Then<br>
　　　　　　wb.Close SaveChanges:=False<br>
　　　　End If<br>
　　Next<br>
　　Application.EnableEvents = True<br>
　　ThisWorkbook.Close SaveChanges:=False<br>
　　On Error Resume Next <span style="color:#009900;">'念の為</span><br>
　　ThisWorkbook.Saved = True<br>
　　Application.Quit<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'テスト用なので適当な処理をいろいろと</span><br>
Private Sub DuumyProc(ByVal iProc As Integer)<br>
　　<span style="color:#009900;">'出力フォルダ作成</span><br>
　　Dim strDir As String<br>
　　strDir = ThisWorkbook.Path &amp; &quot;\Result&quot;<br>
　　If Dir(strDir, vbDirectory) = &quot;&quot; Then MkDir strDir<br>
　　strDir = strDir &amp; &quot;\&quot; &amp; iProc<br>
　　If Dir(strDir, vbDirectory) = &quot;&quot; Then MkDir strDir<br>
　　<br>
　　<span style="color:#009900;">'出力フォルダ内のファイルを削除</span><br>
　　Dim objFSO As Object<br>
　　Dim objFile As Object<br>
　　Set objFSO = CreateObject(&quot;Scripting.FileSystemObject&quot;)<br>
　　For Each objFile In objFSO.GetFolder(strDir).Files<br>
　　　　objFile.Delete<br>
　　Next<br>
　　<br>
　　<span style="color:#009900;">'テスト用にわざと処理時間がかかる処理です</span><br>
　　<span style="color:#009900;">'他への影響軽減のためと、</span><br>
　　<span style="color:#009900;">'「別のプログラムでのOLEの操作が完了するまで待機します」」</span><br>
　　<span style="color:#009900;">'この対策としてDoEventsを適宜（多めに）入れてください。</span><br>
　　<span style="color:#009900;">'テストなので処理時間をバラけさせるためにRndを使用</span><br>
　　Dim wb As Workbook<br>
　　Dim ws As Worksheet<br>
　　Dim i As Long, ix As Long<br>
　　Randomize<br>
　　For ix = 1 To (5 + Int(Rnd * 5))<br>
　　　　<span style="color:#009900;">'新規ブック作成</span><br>
　　　　Set wb = Workbooks.Add<br>
　　　　Set ws = wb.Worksheets(1)<br>
　　　　<span style="color:#009900;">'適当に重い計算、ちょっと重すぎかも</span><br>
　　　　With ws<br>
　　　　　　.Name = iProc &amp; &quot;_&quot; &amp; ix<br>
　　　　　　For i = 1 To 10000<br>
　　　　　　　　.Cells(i, 1) = &quot;A&quot; &amp; i<br>
　　　　　　　　.Cells(i, 2) = &quot;B&quot; &amp; i<br>
　　　　　　　　.Cells(i, 3) = i<br>
　　　　　　　　.Cells(i, 4) = 10000 - i<br>
　　　　　　　　.Cells(i, 5) = &quot;A&quot; &amp; i<br>
　　　　　　　　.Cells(i, 6) = &quot;B&quot; &amp; i<br>
　　　　　　　　.Cells(i, 7) = &quot;RC[-4}*RC[-3]&quot;<br>
　　　　　　Next<br>
　　　　　　DoEvents<br>
　　　　　　Randomize<br>
　　　　　　For i = 1 To (1000 + Int(Rnd * 9000))<br>
　　　　　　　　.Cells(i, 7).FormulaArray = _<br>
　　　　　　　　　　&quot;=SUMPRODUCT((R1C[-6]:R10000C[-6]=RC[-2])*(R1C[-5]:R10000C[-5]=RC[-1]),R1C[-4]:R10000C[-4]*R1C[-3]:R10000C[-3])&quot;<br>
　　　　　　　　DoEvents<br>
　　　　　　Next<br>
　　　　End With<br>
　　　　<span style="color:#009900;">'Excel保存</span><br>
　　　　Randomize<br>
　　　　For i = 1 To (1 + Int(Rnd * 50))<br>
　　　　　　wb.SaveAs strDir &amp; &quot;\test&quot; &amp; _<br>
　　　　　　　　Format(ix, &quot;000&quot;) &amp; &quot;_&quot; &amp; Format(i, &quot;000&quot;) &amp; &quot;.xlsx&quot;<br>
　　　　　　DoEvents<br>
　　　　Next<br>
　　　　wb.Close SaveChanges:=True<br>
　　　　DoEvents<br>
　　　　<span style="color:#009900;">'適当に待ち</span><br>
　　　　Randomize<br>
　　　　For i = 1 To (1 + Int(Rnd * 30))<br>
　　　　　　Randomize<br>
　　　　　　Application.Wait Now() + TimeSerial(0, 0, 1 + Int(Rnd * 1))<br>
　　　　　　DoEvents<br>
　　　　Next<br>
      　　Next<br>　　<br>
　　<span style="color:#009900;">'1次元配列で戻す場合のサンプル</span><br>
　　ReDim RtnArray(1 To 2)<br>
　　RtnArray(1) = &quot;プロセス&quot; &amp; iProc<br>
　　RtnArray(2) = &quot;Array&quot;<br>
　　For i = 1 To 3<br>
　　　　ReDim Preserve RtnArray(1 To UBound(RtnArray) + 1)<br>
　　　　RtnArray(UBound(RtnArray)) = &quot;A&quot; &amp; Rnd<br>
      　　Next<br>　　<br>
　　<span style="color:#009900;">'コレクションで戻す場合のサンプル</span><br>
　　Set RtnCollection = New Collection<br>
　　RtnCollection.Add &quot;プロセス&quot; &amp; iProc<br>
　　RtnCollection.Add &quot;Collection&quot;<br>
　　For i = 1 To 3<br>
　　　　RtnCollection.Add &quot;C&quot; &amp; Rnd<br>
      　　Next<br>　　<br>
　　<span style="color:#009900;">'ディクショナリーで戻す場合のサンプル</span><br>
　　Set RtnDictionary = CreateObject(&quot;Scripting.Dictionary&quot;)<br>
　　RtnDictionary.Add &quot;Key1&quot;, &quot;プロセス&quot; &amp; iProc<br>
　　RtnDictionary.Add &quot;Key2&quot;, &quot;Dictionary&quot;<br>
　　For i = 3 To 5<br>
　　　　RtnDictionary.Add &quot;Key&quot; &amp; i, &quot;Value&quot; &amp; i<br>
　　Next<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
上記2つは同一モジュールでも構いませんが、<br>
管理しやすさを考えたら、別モジュールにした方が良さそうに思います。<br>
モジュール名は何でも構いません。<br><div class="br2"><br></div>
<strong>クラス(clsASync)</strong><br><div class="br2"><br></div>
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Public WithEvents xlApp As Excel.Application<br><div class="br2"><br></div>
Private iProc As Integer　　　　<span style="color:#009900;">'配列のインデックス</span><br>
Private mOpenBook As String　　 <span style="color:#009900;">'開くブックのフルパス</span><br>
Private mAsyncProc As String　　<span style="color:#009900;">'並列処理するProc</span><br>
Private mBeforeClose As String　<span style="color:#009900;">'プロシージャー名</span><br>
Private mDeactivate As String　 <span style="color:#009900;">'WorkbookDeactivate</span><br>
Private mWb As Workbook　　　　 <span style="color:#009900;">'子プロセスに読み込んだブック</span><br><div class="br2"><br></div>
<span style="color:#009900;">'公開プロパティ</span><br>
Public Property Let Index(ByVal arg As Integer)<br>
　　iProc = arg<br>
End Property<br>
Public Property Let OpenBook(ByVal arg As String)<br>
　　mOpenBook = arg<br>
End Property<br>
Public Property Let AsyncProc(ByVal arg As String)<br>
　　mAsyncProc = arg<br>
End Property<br>
Public Property Let BeforeCloseProc(ByVal arg As String)<br>
　　mBeforeClose = arg<br>
End Property<br>
Public Property Let DeactivateProc(ByVal arg As String)<br>
　　mDeactivate = arg<br>
End Property<br>
Public Property Get wb() As Workbook<br>
　　Set wb = mWb<br>
End Property<br>
Public Property Get WorkBooksCount() As Integer<br>
　　If xlApp Is Nothing Then<br>
　　　　WorkBooksCount = 0<br>
　　　　Exit Property<br>
　　End If<br>
　　WorkBooksCount = xlApp.Workbooks.Count<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'公開メソッド</span><br>
<span style="color:#009900;">'ブックを別プロセスに読み込みOnTime起動</span><br>
Public Sub StartOnTime()<br>
　　Set mWb = xlApp.Workbooks.Open(Filename:=mOpenBook, ReadOnly:=True)<br>
　　<span style="color:#009900;">'OnTimeではクラス内は呼び出せないので標準モジュールを</span><br>
　　xlApp.OnTime Now(), &quot;'&quot; &amp; mAsyncProc &amp; &quot;&quot;&quot;&quot; &amp; iProc &amp; &quot;&quot;&quot;'&quot;<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'子プロセスから1次元配列を取得</span><br>
Public Function GetArray() As Variant<br>
　　GetArray = xlApp.Run(&quot;'&quot; &amp; mWb.FullName &amp; &quot;'!PassArray&quot;, &quot;引数予備&quot;)<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'子プロセスからコレクションを取得</span><br>
Public Function GetCollection() As Object<br>
　　Set GetCollection = xlApp.Run(&quot;'&quot; &amp; mWb.FullName &amp; &quot;'!PassCollection&quot;, &quot;引数予備&quot;)<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'子プロセスからコレクションを取得</span><br>
Public Function GetDictionary() As Object<br>
　　Set GetDictionary = xlApp.Run(&quot;'&quot; &amp; mWb.FullName &amp; &quot;'!PassDictionary&quot;, &quot;引数予備&quot;)<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'クラス初期処理</span><br>
Private Sub Class_Initialize()<br>
　　Set xlApp = New Excel.Application<br>
　　xlApp.Visible = False <span style="color:#009900;">'すぐに切り替えられるように</span><br>
　　xlApp.EnableEvents = False <span style="color:#009900;">'これはケースバイケース</span><br>
End Sub<br>
<span style="color:#009900;">'クラス終了処理</span><br>
Private Sub Class_Terminate()<br>
　　<span style="color:#009900;">'正常時には解放済だが、トラブル対応</span><br>
　　On Error Resume Next<br>
　　xlApp.DisplayAlerts = False<br>
　　mWb.Close SaveChanges:=False<br>
　　xlApp.Quit<br>
　　Set xlApp = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'Applicationのイベント</span><br>
<span style="color:#009900;">'先にイベント発生</span><br>
Private Sub xlApp_WorkbookBeforeClose(ByVal wb As Workbook, Cancel As Boolean)<br>
　　Application.Run mBeforeClose, iProc <span style="color:#009900;">'標準モジュールで処理する</span><br>
End Sub<br>
<span style="color:#009900;">'後にイベント発生</span><br>
Private Sub xlApp_WorkbookDeactivate(ByVal wb As Workbook)<br>
　　Application.Run mDeactivate, iProc <span style="color:#009900;">'標準モジュールで処理する</span><br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
全体の中で、以下が使われています。<br><div class="br2"><br></div>
・クラス<br>
・イベント<br>
・コールバック<br>
・配列<br>
・ディクショナリー<br>
・コレクション<br>
・コールバック<br><div class="br2"><br></div>
イベントとコールバックについては、あまりやったことがない人には参考になるのではないでしょうか。<br>
ただしコールバックについては、本来はあまり多用すべきではないと思っているのですが、<br>
さすがに、今回のような場合は代替え手段がありませんので当然使うことになります。<br>
便利な機能ではありますが、デバッグが面倒になってしまう事が多くなります。<br><div class="br2"><br></div>
<strong>動作確認する場合</strong></div>
<div class="main-indent">
<div class="main-indent">「結果」シートだけ必要になります。<br>
VBA内で「Worksheets(&quot;結果&quot;)」これで最初に指定しています。<br><div class="br2"><br></div>
テスト実行やプロセス起動方法の設定はConstで定義しています。<br>
テスト方法に合わせて適宜変更してください。<br><div class="br2"><br></div>
最初はDuumyProcの内容を軽めなものにして、<br>
総プロセス数(AllProc)も少ない数に変更して試してください。<br><div class="br2"><br></div>
掲載コードのままでは動作確認するには時間がかかりすぎてしまいます。<br>
30分くらいはかかるとものとお考え下さい。<br><div class="br2"><br></div>
VBAコードを変更してテストする場合は、<br>
最大プロセス数を1にして実行すればブレークポイント等で止めたりしても大きな問題になりません。<br>
バックグラウンドのExcelが残っても、タスクマネージャーで1つ「タスクの終了」すれば済みます。<br><div class="br2"><br></div>
<img src="image167.jpg" tppabs="https://excel-ubara.com/vba_class/image167.jpg" width="664" height="206" border="0" alt="マクロ VBA マルチタスク"><br><div class="br2"><br></div>
</div>
</div></p>
<h3>まとめと感想</h3>
<div class="main-indent">実際に使用するとしたら、設計および細部の調整がかなり大変になってくるでしょう。<br><div class="br2"><br></div>
今回のように処理内容が同じブックを使う場合は、<br>
結局お互いが資源の取り合い状態になってしまい、速度面では期待したほどの効果は得られないことになります。<br>
今回のテストケースで言えば、PC性能にもよりますがプロセス数は4個くらいまでが限界ではないでしょうか。<br>
それ以上増やしても速度効果はあまりない、というよりむしろ遅くなってしまう場合も出てくるはずです。<br>
つまり、稼働プロセス全てで重い計算を同時に行うとか、同時に同じディスクにIOに行くとか、<br>
このような場合は、当然のことながら速度効果は少なくなります。<br>
今回のテストでは重い計算を入れたので、プロセス数が多くなるとここでCPUが振り切ってしまいます。<br>
つまり広い意味でのリソースの競合を考慮しなければ劇的な速度アップは望めないということです。<br>
少なくとも、単に並列処理したからと言ってなんでも簡単に速くなるわけではないということをご理解ください。<br><div class="br2"><br></div>
子プロセスが長く応答しない状態になると、<br>
「別のプログラムでのOLEの操作が完了するまで待機します」<br>
このメッセージが出てしまいます。<br>
この応答で一旦停止してしまう為、本マクロは正しく処理を続行できません。<br>
従ってそのような状況にならないように適宜DoEventsを入れる必要があります。<br>
これについての確実な対策はほぼ無いと認識しています。<br>
DoEventsで解決しない場合は余計なアプリは停止する等の対策も必要になるかもしれません。<br>
ただし大抵の場合は適宜DoEventsを入れることで対応できる場合が多いはずです。<br><div class="br2"><br></div>
今回の試みでは、VBAコードを書くことの大変さもありましたが何より実行テストに苦労しました。<br>
処理時間がかかるものでテストしなければ検証にならないのですが、<br>
そんなに時間のかかるものを、そうそう何回も実行していられないということです。<br>
1時間かかる実行を、ただじっと見ていられるわけがありません。<br>
別の作業をしながら、「あっエラーが出た・・・」<br>
そして今やっている作業を終えてからソース確認して修正してまたテスト実行。<br>
1日に何回もテストできるものではありません。<br>
従って掲載VBAにおいては、<br>
実行環境・実行方法によってはエラーや正しくない結果が出ることが十分にありえることはご承知おきください。<br><div class="br2"><br></div>
<strong>テストした環境</strong></div>
<div class="main-indent">
<div class="main-indent">Windows8.1(64bit) + Excel2010(32bit)<br>Windows8.1(64bit) + Excel2016(32bit)<br>
Windows10(64bit) + Excel2010(32bit)<br>
Windows10(64bit) + Excel2019(64bit)<br><div class="br2"><br></div>
作成過程のテストでは総プロセス数20くらいまでは実行テストしてみました。<br>
</div>
</div>
<div class="main-indent">本件についてのバグ指摘や改善提案は、<br>
ヘッダーメニューの「お問い合わせ」より頂ければ幸いです。<br><div class="br2"><br></div>
</div>
<h3>最後に</h3>
<div class="main-indent"><font color="#ff0000"><strong>※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※<br><div class="br2"><br></div>
　ここに掲載しているVBAについては実験・検証とお考え下さい。<br>
　実務で使う為には細部の作りこみをしっかりやる必要があります。<br>
　ただし細部を作りこむには多大な労力が必要となるでしょう。<br>
　何よりデバッグが困難です、OnTimeとイベントの組み合わせなので、<br>
　ステップインでのデバッグは普通にはできないものとお考え下さい。<br>
　言うまでもないと思いますが、使用は自己責任でお願いします。<br><div class="br2"><br></div>
※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※</strong></font><br><div class="br2"><br></div>
</div>

          
<HR>
<div class="ads1">
<center>
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yama3 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="8239480723"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="6847508570"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</center>
</div>
          <section>
<br><A name="same"><h3>同じテーマ「<a href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</a>」の記事</h3><p>
<A href="VBA_CLASS_03.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_03.html">VBAクラスの作り方：列名の入力支援と列移動対応</A><br>
<A href="VBA_CLASS_04.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_04.html">VBAクラスの作り方：列名のプロパティを自動作成する</A><br>
<A href="VBA_CLASS_05.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_05.html">VBAクラスの作り方：独自Rangeっぽいものを作ってみた</A><br>
<span class="strrev">クラスとイベントとマルチプロセス並列処理</span><br>
<A href="VBA_CLASS_07.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_07.html">クラスとCallByNameとポリモーフィズム(多態性)</A><br>
<A href="VBA_CLASS_08.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_08.html">オートフィルターを退避回復するVBAクラス</A><br>
<A href="VBA_CLASS_09.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_09.html">オートフィルター退避回復クラスを複数シート対応させるVBAクラス</A><br>
<A href="VBA_CLASS_10.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_10.html">コレクション（Collection）の並べ替え（Sort）に対応するクラス</A><br>
<A href="VBA_CLASS_11.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_11.html">VBAクラスのAttributeについて（既定メンバーとFor Each）</A><br>
<A href="VBA_CLASS_12.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_12.html">VBAクラスを使ったイベント作成（Event,RaiseEvent,WithEvents）</A><br>
<A href="VBA_CLASS_11.html" tppabs="https://excel-ubara.com/vba_class/VBA_CLASS_11.html">VBAクラスのAttributeについて（既定メンバーとFor Each）</A><br></p>
</A>
          </section>
          <section id="new">
<br><h3><A name="new">新着記事<span class="newicon">NEW</span> </a>・・・<A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧を見る</A></h3><p><A href="../vba100/VBA100_100.html" tppabs="https://excel-ubara.com/vba100/VBA100_100.html">VBA100本ノック 100本目：WEBから100本ノックのリストを取得｜VBA練習問題</A>（3月3日）<br>
<A href="../vba100/VBA100_099.html" tppabs="https://excel-ubara.com/vba100/VBA100_099.html">VBA100本ノック 99本目：自動席替え（行列と前後左右が全て違うように）｜VBA練習問題</A>（3月2日）<br>
<A href="../vba100/VBA100_098.html" tppabs="https://excel-ubara.com/vba100/VBA100_098.html">VBA100本ノック 98本目：席替えルールが守られているか確認｜VBA練習問題</A>（3月1日）<br>
<A href="../vba100/VBA100_097.html" tppabs="https://excel-ubara.com/vba100/VBA100_097.html">VBA100本ノック 97本目：Accessデータを取得（グループ集計）｜VBA練習問題</A>（2月27日）<br>
<A href="../vba100/VBA100_096.html" tppabs="https://excel-ubara.com/vba100/VBA100_096.html">VBA100本ノック 96本目：Accessデータを取得（マスタ結合&amp;抽出）｜VBA練習問題</A>（2月26日）<br>
<A href="../vba100/VBA100_095.html" tppabs="https://excel-ubara.com/vba100/VBA100_095.html">VBA100本ノック 95本目：図形のテキストを検索するフォーム作成｜VBA練習問題</A>（2月24日）<br>
<A href="../vba100/VBA100_094.html" tppabs="https://excel-ubara.com/vba100/VBA100_094.html">VBA100本ノック 94本目：表範囲からHTMLのtableタグを作成｜VBA練習問題</A>（2月23日）<br>
<A href="../vba100/VBA100_093.html" tppabs="https://excel-ubara.com/vba100/VBA100_093.html">VBA100本ノック 93本目：複数ブックを連結して再分割｜VBA練習問題</A>（2月22日）<br>
<A href="../vba100/VBA100_092.html" tppabs="https://excel-ubara.com/vba100/VBA100_092.html">VBA100本ノック 92本目：セルの色を16進で返す関数｜VBA練習問題</A>（2月20日）<br>
<A href="../vba100/VBA100_091.html" tppabs="https://excel-ubara.com/vba100/VBA100_091.html">VBA100本ノック 91本目：時間計算（残業時間の月間合計）｜VBA練習問題</A>（2月19日）<br></p>

          </section>
          <section id="rank">
<br><h3><A name="rank">アクセスランキング </a>・・・ <A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">ランキング一覧を見る</A></h3><p>1.<A href="../excelvba1/EXCELVBA318.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA318.html">最終行の取得（End,Rows.Count）｜VBA入門</A><br>2.<A href="../excelvba1/EXCELVBA311.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA311.html">RangeとCellsの使い方｜VBA入門</A><br>3.<A href="../excelvba1/EXCELVBA312.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA312.html">変数宣言のDimとデータ型｜VBA入門</A><br>4.<A href="../excelvba1/EXCELVBA301.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA301.html">マクロって何？VBAって何？｜VBA入門</A><br>5.<A href="../excelvba1/EXCELVBA310.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA310.html">Range以外の指定方法（Cells,Rows,Columns）｜VBA入門</A><br>6.<A href="../excelvba1/EXCELVBA341.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA341.html">セルのコピー&amp;値の貼り付け（PasteSpecial）｜VBA入門</A><br>7.<A href="../excelvba1/EXCELVBA316.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA316.html">繰り返し処理（For Next)｜VBA入門</A><br>8.<A href="../excelvba1/EXCELVBA308.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA308.html">セルに文字を入れるとは（Range,Value）｜VBA入門</A><br>9.<A href="../excelvba1/EXCELVBA304.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA304.html">マクロはどこに書くの（VBEの起動）｜VBA入門</A><br>10.<A href="../excelvba1/EXCELVBA306.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA306.html">とにかく書いてみよう（Sub,End Sub）｜VBA入門</A><br></p>
          </section>
<br>
          <HR>
          <div><ul>
<li><a href="../index.htm" tppabs="https://excel-ubara.com/">ホーム</a></li>
<li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編</a></li>
<li><a href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</a></li>
<li><span class="strrev2"><strong>クラスとイベントとマルチプロセス並列処理</strong></span></li>
</ul></div><br>
          <strong>このサイトがお役に立ちましたら「シェア」「Bookmark」をお願いいたします。</strong><br>
          <div class="ninja_onebutton">
            <script type="text/javascript">
              //<![CDATA[
              (function(d){
              if(typeof(window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2)=='undefined'){
                  document.write("<sc"+"ript type='text\/javascript' src='\/\/omt.shinobi.jp\/b\/dbb4ddbe09aac6bed0b2564afb27c6f2'><\/sc"+"ript>");
              }else{
                  window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2.ONETAGButton_Load();}
              })(document);
              //]]>
            </script><span class="ninja_onebutton_hidden" style="display:none;"></span><span style="display:none;" class="ninja_onebutton_hidden"></span>
          </div>
<br>
          <script>
            (function() {
              var cx = 'partner-pub-6511020045004282:1071452572';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:searchbox-only></gcse:searchbox-only>
<br>
          記述には細心の注意をしたつもりですが、<br>
          間違いやご指摘がありましたら、<A href="../query.html" tppabs="https://excel-ubara.com/query.html" target="_blank">「お問い合わせ」</A>からお知らせいただけると幸いです。<br>
          掲載のVBAコードは動作を保証するものではなく、あくまでVBA学習のサンプルとして掲載しています。<br>
          掲載のVBAコードは自己責任でご使用ください。万一データ破損等の損害が発生しても責任は負いません。
        </section>
      </div> <!--/#main-->

      <div id="sub">
        <nav>
          <h2>エクセル全般</h2>
          <ul class="submenu">
            <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
            <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
            <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
            <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
            <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
            <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
          </ul>
          <h2>マクロVBA入門編</h2>
          <ul class="submenu">
            <li><A href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</A></li>
            <li><A href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</A></li>
            <li><A href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</A></li>
            <li><A href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</A></li>
            <li><A href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</A></li>
            <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
            <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
          </ul>
          <h2>マクロVBA応用編</h2>
          <ul class="submenu">
            <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
            <li><A href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
            <li><A href="../excelvba5/index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
            <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
            <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
            <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
          </ul>
          <h2>その他（Excel以外）</h2>
          <ul class="submenu">
            <li><a href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">SQL入門</a></li>
            <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">スプレッドシート入門</A></li>
            <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">GAS入門</A></li>
            <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">Python入門</A></li>
          </ul>
          <h2>サイト案内</h2>
          <ul class="submenu">
            <li><A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧</A></li>
            <li><A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">アクセスランキング</A></li>
            <li><A href="../sitemap.html" tppabs="https://excel-ubara.com/sitemap.html">サイトマップ</A></li>
            <li><a href="../business/index.htm" tppabs="https://excel-ubara.com/business/">事業案内</a></li>
            <li><A href="../query.html" tppabs="https://excel-ubara.com/query.html">お問い合わせ&nbsp&nbsp</A></li>
          </ul>
        </nav>

        <section>
          
<HR>
<div class="ads1">
<CENTER>
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yama22 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="9686142173"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</CENTER>
</div>
          

          

          <HR>
          <div><ul>
<li><a href="../index.htm" tppabs="https://excel-ubara.com/">ホーム</a></li>
<li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編</a></li>
<li><a href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</a></li>
<li><span class="strrev2"><strong>クラスとイベントとマルチプロセス並列処理</strong></span></li>
</ul></div><br>
          このサイトがお役に立ちましたら「シェア」「Bookmark」をお願いいたします。<br>

          <div class="ninja_onebutton">
            <script type="text/javascript">
              //<![CDATA[
              (function(d){
              if(typeof(window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2)=='undefined'){
                  document.write("<sc"+"ript type='text\/javascript' src='\/\/omt.shinobi.jp\/b\/dbb4ddbe09aac6bed0b2564afb27c6f2'><\/sc"+"ript>");
              }else{
                  window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2.ONETAGButton_Load();}
              })(document);
              //]]>
            </script><span class="ninja_onebutton_hidden" style="display:none;"></span><span style="display:none;" class="ninja_onebutton_hidden"></span>
          </div>
          本文下部へ<br>
          <div class="main-indent">
            <strong><A href="#same">同じテーマの記事</A></strong><br>
            <strong><A href="#new">新着記事</A></strong><br>
            <strong><A href="#rank">アクセスランク</A></strong><br>
          </div>
          <div class="ads2">
            <script>
              (function() {
                var cx = 'partner-pub-6511020045004282:1071452572';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:searchbox-only></gcse:searchbox-only>
          </div>
<br><nav><h2>おすすめ関連記事</h2><ul class="submenu"><li><a href="../excelvba1/EXCELVBA420.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA420.html">第120回．OnTimeメソッド</a></li><li><a href="../excelvba4/EXCEL255.html" tppabs="https://excel-ubara.com/excelvba4/EXCEL255.html">文字列としてのプロシージャー名を起動する方法<br></a></li><li><a href="../excelvba5/EXCEL104.html" tppabs="https://excel-ubara.com/excelvba5/EXCEL104.html">時刻になったら音を鳴らして知らせる<br>(OnTime)</a></li></ul></nav>
          

          
<HR>
<div class="ads2">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 新サイド下 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="1968934163"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div><br>
        </section>
      </div> <!--/#sub-->
    </div> <!--/#contents-in-->
  </div> <!--/#contents-->

  <footer>
    <div id="footermenu" class="inner">
      <ul>
        <li><a href="../excel_index.html" tppabs="https://excel-ubara.com/excel_index.html">■Excel全般</a></li>
        <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
        <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
        <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
        <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
        <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
        <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
      </ul>
      <ul>
        <li><a href="../excel_vba1.html" tppabs="https://excel-ubara.com/excel_vba1.html">■マクロVBA入門編</a></li>
        <li><A href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</A></li>
        <li><A href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</A></li>
        <li><A href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</A></li>
        <li><A href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</A></li>
        <li><A href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</A></li>
        <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
        <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
      </ul>
      <ul>
        <li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">■マクロVBA応用編</a></li>
        <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
        <li><A href="index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
        <li><A href="../excelvba5/index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
        <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
        <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
        <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
      </ul>
      <ul>
        <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">■Python入門</A></li>
        <li><a href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">■SQL入門</a></li>
        <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">■スプレッドシート入門</A></li>
        <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">■Google Apps Script入門</A></li>
        <li><A href="../excel_course/index.htm" tppabs="https://excel-ubara.com/excel_course/">■エクセル講座セミナー</A></li>
        <li><A href="../business/index.htm" tppabs="https://excel-ubara.com/business/">■事業案内</A></li>
        <li><A href="../business/sitemap.html" tppabs="https://excel-ubara.com/business/sitemap.html">■サイトマップ</A></li>
      </ul>
    </div> <!--/footermenu-->
    <div id="copyright">
      <small>エクセルの神髄 ｜ Copyright&copy; 2010 <A href="../index.htm" tppabs="https://excel-ubara.com/">鵜原パソコンソフト研究所</A></small>
    </div>
  </footer>

  <p class="nav-fix-pos-pagetop"><a href="#">↑</a></p>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37178461-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
<!--License20150309TPg-->
</body>
</html>
