<!DOCTYPE html>
<html lang="ja">
<head>
  <script data-ad-client="ca-pub-6511020045004282" async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6511020045004282",
      enable_page_level_ads: true
    });
  </script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Excel将棋：ひとまず完成、これまでとこれから(№18)｜VBAサンプル集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。前回でひとまず当初目標の人vs人で動かしてゲームとして成立するところまでできました。連載の途中で、急遽棋譜の出力と読み込んで自動再生も作成しました。">
  <meta name="keywords" content="Excel,将棋,ひとまず完成,これまでとこれから,№18,サンプル集,エクセル,マクロ,VBA">
  <link rel="icon" type="image/x-icon" href="../images/favicon_excel.png">
  <link rel="stylesheet" href="../css/style.css-20210304.css" tppabs="https://excel-ubara.com/css/style.css?20210304">
  <link rel="stylesheet" href="../css/slide.css-20210304.css" tppabs="https://excel-ubara.com/css/slide.css?20210304">
  <link rel="canonical" href="https://excel-ubara.com/excelvba5/EXCELVBA282_18.html" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Excel将棋：ひとまず完成、これまでとこれから(№18)｜VBAサンプル集" />
  <meta property="og:description" content="Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。前回でひとまず当初目標の人vs人で動かしてゲームとして成立するところまでできました。連載の途中で、急遽棋譜の出力と読み込んで自動再生も作成しました。" />
  <meta property="og:image" content="https://excel-ubara.com/excelvba5/image133.jpg" />
  <meta property="og:url" content="https://excel-ubara.com/excelvba5/EXCELVBA282_18.html" />
  <meta property="og:site_name" content="エクセルの神髄" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Excel将棋：ひとまず完成、これまでとこれから(№18)｜VBAサンプル集" />
  <meta name="twitter:description" content="Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。前回でひとまず当初目標の人vs人で動かしてゲームとして成立するところまでできました。連載の途中で、急遽棋譜の出力と読み込んで自動再生も作成しました。" />
  <meta name="twitter:image" content="https://excel-ubara.com/excelvba5/image133.jpg" />
  <meta name="twitter:site" content="@yamaoka_ss" />
  <script src="../../code.jquery.com/jquery-3.3.1.min.js" tppabs="https://code.jquery.com/jquery-3.3.1.min.js" async></script>
  <script type="text/javascript" src="../js/fix.js" tppabs="https://excel-ubara.com/js/fix.js" async></script>
  <script type="text/javascript" src="../js/fixmenu_pagetop.js-20210304" tppabs="https://excel-ubara.com/js/fixmenu_pagetop.js?20210304" async></script>
  <script type="text/javascript" src="../js/CopyDisp.js-20210304" tppabs="https://excel-ubara.com/js/CopyDisp.js?20210304" async></script>
</head>

<body class="c2">
  <header>
    <div class="inner">
      <p id="logo"><a href="../index.htm" tppabs="https://excel-ubara.com/"><img src="../images/logo.png" tppabs="https://excel-ubara.com/images/logo.png" alt="エクセルの神髄"></a></p>
      <div id="contact">
        <h1>VBAサンプル集<br>Excel将棋：ひとまず完成、これまでとこれから(№18)</h1>ExcelマクロVBAの実用サンプル、エクセルVBA集と解説
      </div>
    </div>
  </header>

  <!--PC用（801px以上端末）メニュー-->
  <nav id="dropmenu">
    <ul class="inner">
      <li><a href="../excel_index.html" tppabs="https://excel-ubara.com/excel_index.html">Excel全般<span>Excel</span></a>
        <ul>
          <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
          <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
          <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
          <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
          <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
          <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
        </ul>
      </li>
      <li><a href="../excel_vba1.html" tppabs="https://excel-ubara.com/excel_vba1.html">マクロVBA入門編<span>VBA Beginner</span></a>
        <ul>
          <li><a href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</a></li>
          <li><a href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</a></li>
          <li><a href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</a></li>
          <li><a href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</a></li>
          <li><a href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</a></li>
          <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
          <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
        </ul>
      </li>
      <li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編<span>VBA Advanced</span></a>
        <ul>
          <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
          <li><A href="../vba_class/index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
          <li><A href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
          <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
          <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
          <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
        </ul>
      </li>
      <li><a href="../excel_other.html" tppabs="https://excel-ubara.com/excel_other.html">その他（Excel以外）<span>Other than Excel</span></a>
        <ul>
          <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">Python入門</A></li>
          <li><A href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">SQL入門</A></li>
          <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">スプレッドシート入門</A></li>
          <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">GAS入門</A></li>
        </ul>
      </li>
      <li><a href="../siteguide.html" tppabs="https://excel-ubara.com/siteguide.html">サイト案内<span>site map</span></a>
        <ul>
          <li><A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧</A></li>
          <li><A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">アクセスランキング</A></li>
          <li><A href="../sitemap.html" tppabs="https://excel-ubara.com/sitemap.html">サイトマップ&nbsp;&nbsp;</A></li>
          <li><a href="../business/index.htm" tppabs="https://excel-ubara.com/business/">旧トップページ&nbsp;&nbsp;</a></li>
          <li><A href="../query.html" tppabs="https://excel-ubara.com/query.html">お問い合わせ&nbsp;&nbsp;</A></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="pan"><ul itemscope itemtype="http://schema.org/BreadcrumbList">
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="../index.htm" tppabs="https://excel-ubara.com/">
<span itemprop="name">ホーム</span></a>
<meta itemprop="position" content="1" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">
<span itemprop="name">マクロVBA応用編</span></a>
<meta itemprop="position" content="2" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">
<span itemprop="name">マクロVBAサンプル集</span></a>
<meta itemprop="position" content="3" />
</li>
<li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="item" href="EXCELVBA282_18.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_18.html">
<span itemprop="name">Excel将棋：ひとまず完成、これまでとこれから(№18)</span></a>
<meta itemprop="position" content="4" />
</li>
</ul></div>
  <div class="ads1">
    <center>
    <script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- yama21 -->
    <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-6511020045004282"
        data-ad-slot="1104944574"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    </center>
  </div>

  <div id="contents" class="inner">
    <div id="contents-in">
      <div id="main">
        <section>
          <span style="line-height:20px;float:right" align="right">最終更新日：2020-08-31</span>
<h2 align="center">Excel将棋：ひとまず完成、これまでとこれから(№18)</h2><br><a href="image133.jpg" tppabs="https://excel-ubara.com/excelvba5/image133.jpg" target="_blank"><img src="image133.jpg" tppabs="https://excel-ubara.com/excelvba5/image133.jpg" width="360" height="313" style="float:right;margin: 0px 10px 10px 10px;" border="0" alt="VBA マクロ Excel将棋"></a><p>Excelで将棋を作ってみましょう。<br>人vs人で動かしてゲームとして成立するところまでが当面の目標です。<br><div class="br2"><br></div>前回でひとまず当初目標の人vs人で動かしてゲームとして成立するところまでできました。<br>
連載の途中で、急遽棋譜の出力と読み込んで自動再生も作成しました。<br>
これでこの連載はひとまず完了とします。<br><div class="br2"><br></div>
最終回として、これまでの整理として、<br>・連載の目次<br>
・Excel将棋のダウンロード<br>
・当初のクラス設計<br>
・全体構成図<br>
・全プロシージャー・プロパティの一覧<br>
・全VBAコード<br>
これらを掲載しておきます。<br><div class="br2"><br></div>
※クラス名、プロシージャー名、変数名に日本語を使用しています。<br><div class="br2"><br></div></p>
<h3>Excel将棋のこれから</h3>
<div class="main-indent">ひとまず完了と言っても完ぺきに完成したというものではありません。<br>
位置づけとしては<strong>ベータ版</strong>のようなものです。<br>
不具合もあるしょう。<br>
ここはこうしたほうが良いといった意見も出てくるでしょう。<br>自分としても、まだまだ組み込みたい機能は沢山ありますが、それはおいおい時間の取れた時にしようと思います。<br>
もし、これを使ってみて、バグ報告・ご要望があれば、<br><div class="br2"><br></div>
<a href="../query.html" tppabs="https://excel-ubara.com/query.html" target="_blank">「お問い合わせ」</a> または、<a href="javascript:if(confirm('https://twitter.com/yamaoka_ss  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://twitter.com/yamaoka_ss'" tppabs="https://twitter.com/yamaoka_ss" target="_blank">ツイッター</a>でリプライいただければ検討いたします。<br><div class="br2"><br></div>
何より、AI思考エンジンを何とかしたいという思いもありますが、さすがに独自では無理そうです、、、<br>
有名な将棋ソフトが思考エンジンのDLLを公開していたりするので、これらが使えるものなの、この辺りの情報次第では考えてみたいと思っています。<br><div class="br2"><br></div>
</div>
<div class="main-indent">
<div class="ads1">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="6991829975"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></div><h3>Excel将棋の目次</h3>
<div class="main-indent"><strong><a href="EXCELVBA282.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282.html">№1. Excel将棋：マクロVBAの学習用</a></strong><div class="details">Excelで将棋を作ってみましょう。今やコンピューター将棋はプロをしのぐ強さです。しかし、Excelでそのようなソフトを作ろうと言うのではありません。と言いますか、残念ながら私には作れません、、、ExcelマクロVBAの学習素材として将棋を作ってみましょう。</div>
<strong><a href="EXCELVBA282_2.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_2.html">№2. Excel将棋：クラスの設計</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、VBAクラスの設計になります。設計といっても、どのようなプロパティ・メソッドをもたせるかといった概要だけです。</div>
<strong><a href="EXCELVBA282_3.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_3.html">№3. Excel将棋：駒クラスの作成</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、駒クラスの作成になります。駒クラスに必要な部品クラスとして、位置クラスと移動クラスを先に作成してから駒クラスの作成に進みます。</div>
<strong><a href="EXCELVBA282_4.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_4.html">№4. Excel将棋：駒クラスの単体テスト</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、前回の№3.Excel将棋：駒クラスの作成、この単体テストになります。駒クラスは、今後作成していく駒台クラス、将棋盤クラスで使用するものです。</div>
<strong><a href="EXCELVBA282_5.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_5.html">№5. Excel将棋：駒台クラスの作成&amp;単体テスト</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、駒台クラスの作成と単体テストになります。作成するクラス全体の設計は、№2.Excel将棋：クラスの設計、こちらを参照してください。</div>
<strong><a href="EXCELVBA282_6.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_6.html">№6. Excel将棋：位置クラスをデフォルトインスタンスに変更</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、前に作った位置クラスをデフォルトインスタンスに変更します。作成するクラス全体の設計は、№2.Excel将棋：クラスの設計、こちらを参照してください。</div>
<strong><a href="EXCELVBA282_7.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_7.html">№7. Excel将棋：将棋盤クラスの作成&amp;単体テスト</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、いよいよ将棋盤クラスを作成します。駒クラスを2次元配列(1To9,1To9)に入れて将棋盤全体を管理します。</div>
<strong><a href="EXCELVBA282_8.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_8.html">№8. Excel将棋：将棋進行クラスの作成</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、シートとやり取りする将棋進行クラスを作成します。ここまでは、作成したクラスのテスト実行用のVBAを別途作成し、結果をイミディエイトウィンドウに表示して確認していました。</div>
<strong><a href="EXCELVBA282_9.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_9.html">№9. Excel将棋：駒を動かす</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、駒を動かします。駒を動かせるように将棋進行クラスを拡張します。将棋進行クラスの完成はまだまだこれからですが、駒を動かせるようになるとゲームらしくなってきます。</div>
<strong><a href="EXCELVBA282_10.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_10.html">№10. Excel将棋：相手の駒を取る、持ち駒を打つ</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、相手の駒を取ったり、持駒を打ったりできるようにします。取った駒は駒台へ移し、駒台から駒を選んで打てるようにします。</div>
<strong><a href="EXCELVBA282_11.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_11.html">№11. Excel将棋：駒を成る</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、駒を成れるようにします。ただし、将棋では成らない選択も出来ますので、成れるタイミングで成るか成らないかを選択できるようにします。</div>
<strong><a href="EXCELVBA282_12.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_12.html">№12. Excel将棋：棋譜をユーザーフォームに表示する</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、ユーザーフォームを作成し、初手からの棋譜を表示できるようにします。シート操作ができるように、ユーザーフォームはモードレスで表示します。</div>
<strong><a href="EXCELVBA282_13.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_13.html">№13. Excel将棋：棋譜選択でその時点の盤面に戻す</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、棋譜フォームの棋譜を選択することで、その時点の盤面に戻す機能を実装します。さらに、その時点から指し継ぐこともできるようにします。</div>
<strong><a href="EXCELVBA282_14.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_14.html">№14. Excel将棋：棋譜ファイルの出力と読込自動再生</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、KIF形式の棋譜ファイルの出力と、KIF形式の棋譜ファイルを読み込んで初手から終局までを自動再生させます。</div>
<strong><a href="EXCELVBA282_15.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_15.html">№15. Excel将棋：反則（禁じ手）判定</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、反則（禁じ手）の判定を入れます。禁じ手は指し手そのものが出来ないようにします。※クラス名、プロシージャー名、変数名に日本語を使用しています。</div>
<strong><a href="EXCELVBA282_16.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_16.html">№16. Excel将棋：終局（詰み）判定と打ち歩詰め</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、前回の反則（禁じ手）の続きで「打ち歩詰め」を実装します。打ち歩詰めを判定するには、そもそも「詰み」の判定が必要です。</div>
<strong><a href="EXCELVBA282_17.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_17.html">№17. Excel将棋：千日手と連続王手の千日手</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、千日手と反則の「連続王手の千日手」を実装します。千日手は、他とは違ってある局面だけでは判定できません。</div>
<strong><a href="EXCELVBA282_18.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_18.html">№18 Excel将棋：ひとまず完成、これまでとこれから</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。前回でひとまず当初目標の人vs人で動かしてゲームとして成立するところまでできました。連載の途中で、急遽棋譜の出力と読み込んで自動再生も作成しました。</div>
<strong><a href="EXCELVBA282_19.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_19.html">№19 Excel将棋：棋譜ファイルから対局一覧作成</a></strong><div class="details">Excelで将棋を作るシリーズの当初目標の、人vs人で動かしてゲームとして成立するところまでは完成しました。今回は機能拡張として、棋譜ファイルを読み込み対局一覧を作成します。複数の棋譜ファイルも一度に処理できるようにしています。</div><br>
</div>
<h3>Excel将棋のダウンロード</h3>
<div class="main-indent">№9. Excel将棋：駒を動かす</div>
<div class="main-indent">
<div class="main-indent"><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_09.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_09.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_09.zip" target="_blank">shogi_09.zip</a>　<a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_09.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_09.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_09.xlsm" target="_blank">shogi_09.xlsm</a>
</div>
</div>
<div class="main-indent">№10. Excel将棋：相手の駒を取る、持ち駒を打つ </div>
<div class="main-indent">
<div class="main-indent"><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_10.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_10.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_10.zip" target="_blank">shogi_10.zip</a>　<a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_10.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_10.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_10.xlsm" target="_blank">shogi_10.xlsm</a>
</div>
</div>
<div class="main-indent">№11. Excel将棋：駒を成る </div>
<div class="main-indent">
<div class="main-indent"><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_11.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_11.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_11.zip" target="_blank">shogi_11.zip</a>　<a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_11.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_11.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_11.xlsm" target="_blank">shogi_11.xlsm</a>
</div>
</div>
<div class="main-indent">№12. Excel将棋：棋譜をユーザーフォームに表示する </div>
<div class="main-indent">
<div class="main-indent"><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_12.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_12.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_12.zip" target="_blank">shogi_12.zip</a>　<a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_12.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_12.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_12.xlsm" target="_blank">shogi_12.xlsm</a>
</div>
</div>
<div class="main-indent">№13. Excel将棋：棋譜選択でその時点の盤面に戻す </div>
<div class="main-indent">
<div class="main-indent"><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_13.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_13.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_13.zip" target="_blank">shogi_13.zip</a>　<a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_13.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_13.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_13.xlsm" target="_blank">shogi_13.xlsm</a>
</div>
</div>
<div class="main-indent">№14. Excel将棋：棋譜ファイルの出力と読込自動再生 </div>
<div class="main-indent">
<div class="main-indent"><a href="../excelsample/shogi_14.zip" tppabs="https://excel-ubara.com/excelsample/shogi_14.zip" target="_blank">shogi_14.zip</a>　<a href="../excelsample/shogi_14.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_14.xlsm" target="_blank">shogi_14.xlsm</a>
</div>
</div>
<div class="main-indent">№15.Excel将棋：反則（禁じ手）判定 </div>
<div class="main-indent">
<div class="main-indent"><a href="../excelsample/shogi_15.zip" tppabs="https://excel-ubara.com/excelsample/shogi_15.zip" target="_blank">shogi_15.zip</a>　<a href="../excelsample/shogi_15.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_15.xlsm" target="_blank">shogi_15.xlsm</a>
</div>
</div>
<div class="main-indent">№16.Excel将棋：終局（詰み）判定と打ち歩詰め </div>
<div class="main-indent">
<div class="main-indent"><a href="../excelsample/shogi_16.zip" tppabs="https://excel-ubara.com/excelsample/shogi_16.zip" target="_blank">shogi_16.zip</a>　<a href="../excelsample/shogi_16.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_16.xlsm" target="_blank">shogi_16.xlsm</a>
</div>
</div>
<div class="main-indent">№17.Excel将棋：千日手と連続王手の千日手 </div>
<div class="main-indent">
<div class="main-indent"><a href="../excelsample/shogi_17.zip" tppabs="https://excel-ubara.com/excelsample/shogi_17.zip" target="_blank">shogi_17.zip</a>　<a href="../excelsample/shogi_17.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_17.xlsm" target="_blank">shogi_17.xlsm</a><br></div>
</div>
<div class="main-indent">№19.Excel将棋：棋譜ファイルから対局一覧作成</div>
<div class="main-indent">
<div class="main-indent"><a href="../excelsample/shogi_19.zip" tppabs="https://excel-ubara.com/excelsample/shogi_19.zip" target="_blank">shogi_19.zip</a>　<a href="../excelsample/shogi_19.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_19.xlsm" target="_blank">shogi_19.xlsm</a> ・・・ 現在の最終版</div>
</div>
<div class="main-indent"><br>
他のゲーム（数独やオセロ）も含めたダウンロード一覧は以下になります。</div>
<div class="main-indent">
<div class="main-indent"><a href="../excel_download.html" tppabs="https://excel-ubara.com/excel_download.html" target="_blank">エクセルのサンプルダウンロード</a><br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent">
<div class="ads1">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="7467492230"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></div><h3>当初のクラス設計</h3>
<div class="main-indent">以下は作成を始めるにあたって書いたものです。<br>
あえてその後の修正は反映せず、作成過程の資料として掲載しておきます。<br><div class="br2"><br></div>
</div>
<div class="main-indent">
<h4>作成するクラスの役割と作成順</h4>
</div>
<div class="main-indent">
<div class="main-indent"><strong>将棋進行クラス
</strong></div>
<div class="main-indent">
<div class="main-indent">ゲーム全体を管理します。<br>
主な役割としては、<br>
・シートと他のクラスの受け渡し<br>
・ルール制御<br>
・消費時間管理<br><div class="br2"><br></div>
以下のオブジェクトを保持する。<br>
・将棋盤オブジェクト<br>
・先手駒台オブジェクト<br>
・後手駒台オブジェクト<br><div class="br2"><br></div>
WithEventsを使い、任意のシートでゲーム可能にする。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>将棋盤クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">将棋盤を管理します。<br>
2次元配列に駒クラスのオブジェクトを入れる。<br>
シートとは完全に切り離して作成。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>駒台クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">駒台の駒を管理するのみ。<br>
駒の種類と数だけ管理できれば良い。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>駒クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">駒1つを1つのオブジェクトとして作成<br>
駒の種類、駒の移動、駒の位置等、駒ごとの情報を保持<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>位置クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">将棋盤の2次元配列内の位置情報として使用。<br>
・行<br>
・列<br>
この情報だけを持たせる<br>
ユーザー定義型では制限が多いためクラスを使用<br><div class="br2"><br></div>
※後に、<strong><a href="EXCELVBA282_6.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_6.html" target="_blank">位置クラスをデフォルトインスタンスに変更</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、前に作った位置クラスをデフォルトインスタンスに変更します。作成するクラス全体の設計は、№2.Excel将棋：クラスの設計、こちらを参照してください。</div><br>
</div>
</div>
<div class="main-indent"><strong>移動クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">将棋盤の2次元配列内で駒が移動できる位置情報として使用。<br>
・行<br>
・列<br>
・回数<br>
この情報だけを持たせる<br>
ユーザー定義型では制限が多いためクラスを使用<br><div class="br2"><br></div>
現在位置からのオフセットとその繰り返し最大数<br>
前に1つだけ進める場合は、-1,0,1<br>
前に突き当たるまで進めるなら、-1,0,8、盤は9*9なので回数は最大で8<br><div class="br2"><br></div>
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>-1,-1</td>
      <td align="right">-1,0</td>
      <td align="right">-1,1</td>
    </tr>
    <tr>
      <td>0,-1</td>
      <td>現在</td>
      <td align="right">0,1</td>
    </tr>
    <tr>
      <td>1,-1</td>
      <td align="right">1,0</td>
      <td align="right">1,1</td>
    </tr>
  </tbody>
</table></div><br>
</div>
</div>
<div class="main-indent"><strong>クラスの作成順</strong>
</div>
<div class="main-indent">
<div class="main-indent">・駒クラス、位置クラス、移動クラス<br>
・駒台クラス<br>
・将棋盤クラス<br>
・将棋進行クラス<br>
この順で作成していく予定です。<br>
細かい部品から作成していく感じになります。<br>
したがって、下に行くほど設計がずれていく可能性があります。<br><div class="br2"><br></div>
</div>
</div>
<h3>作成するクラスのメンバー一覧</h3>
<div class="main-indent">以下は作成予定の各クラスのPublicメンバーのみになります。<br>
現時点での予定なので、実装段階で変更は発生すると思います。<br>
※各クラス作成時の変更は、極力このページに反映しておきます。<br>
また、Privateメンバーは適宜作成していきます。<br><div class="br2"><br></div>
</div>
<div class="main-indent"><strong>将棋進行クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>将棋盤</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>先手持駒</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>後手持駒</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>先手消費時間</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>後手消費時間</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>手数</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>棋譜</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>将棋盤色</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>駒選択色</td>
      <td>シートのRange</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>駒配置</td>
      <td>駒を並べる<br>
      「大橋流」でアニメーションさせたい</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>駒選択</td>
      <td>選択駒の移動可能セルの協調表示<br>
      既に選択されている場合は解除</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>着手</td>
      <td>引数(元位置, 先位置, 駒名)<br>
      元位置：-1,-1は初期配置<br>
      元位置：0,0は駒台から<br>
      反則（禁じ手）等の判定を行い、禁じ手の場合はFalseを返す<br>
      相手の駒を取る場合は駒台へ追加<br>
      駒台から打った場合は駒台から削除<br>
      シート全体の更新</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>盤面表示</td>
      <td>盤面の2次元配列をシートに表示する<br>
      2次元配列はcls将棋盤の現在盤面で取得する</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>終局判定</td>
      <td>これは結構難しい・・・<br>
      持駒を含めた全ての駒を使って受けがないかの判定</td>
    </tr>
  </tbody>
</table></div><br>
</div>
</div>
<div class="main-indent"><strong>将棋盤クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>現在盤面</td>
      <td>駒オブジェクトが入っている2次元配列から表示名の2次元配列を作成する</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>盤面履歴</td>
      <td>現在盤面をCollection</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>手数</td>
      <td>現在手数を戻す</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>棋譜</td>
      <td>1手ずつCollectionに追加<br>
      棋譜は、Ki2形式とします。<br>
      ▲５ニ銀右上成<br>
      ・先手▲後手△<br>
      ・到達地点の筋<br>
      ・到達地点の段<br>
      ・駒の種類<br>
      ・駒の相対位置（複数ある場合）<br>
      ・駒の動作（複数ある場合）<br>
      ・成・不成・打</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>棋譜履歴</td>
      <td>最終手をCollection</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>先手</td>
      <td>先手True、後手False</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>着手</td>
      <td>引数(元位置, 先位置, 駒名, Optional 手番)<br>
      元位置：-1,-1は初期配置<br>
      元位置：0,0は駒台から<br>
      手番省略時は、プロパティ手番に従う<br>
      以下を更新する。<br>
      最終手、2次元配列、盤面履歴、棋譜履歴</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>終局判定</td>
      <td>これはかなり難しい・・・<br>
      持駒を含めた全ての駒を使って受けがないかの判定が必要</td>
    </tr>
  </tbody>
</table></div><br>
2次元配列(1 To 9, 1 To 9)の各要素に駒オブジェクト（駒クラスのインスタンス）を入れて管理します。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>駒台クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>駒台一覧</td>
      <td>金,1;歩,3</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>駒追加</td>
      <td>オブジェクトで追加</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>駒削除</td>
      <td>名称で削除</td>
    </tr>
  </tbody>
</table></div><br>
</div>
</div>
<div class="main-indent"><strong>駒クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>正式名称</td>
      <td>飛車、角行、金将、銀将、桂馬、香車、歩兵</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>表示名称</td>
      <td>飛、角、金、銀、桂、香、歩</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>成駒名称</td>
      <td>龍、馬、金、成銀、成桂、成香、と</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>表示順</td>
      <td>駒台の表示順</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>先手</td>
      <td>先手True、後手False</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>成り</td>
      <td>先りTrue、未成りFalse</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>駒位置</td>
      <td>縦横（行列）で取得・設定</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>駒移動</td>
      <td>別表参照</td>
    </tr>
    <tr>
      <td>プロパティ</td>
      <td>成駒移動</td>
      <td>別表参照</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>駒作成</td>
      <td>駒の正式名称を受け取って、その駒特有の情報を設定する</td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td><s>駒位置設定</s></td>
      <td><s>駒位置プロパティの設定を行・列で行う</s></td>
    </tr>
    <tr>
      <td>メソッド</td>
      <td>移動可能位置</td>
      <td>駒が移動できる位置をcls位置（行、列）のCollectionで返す</td>
    </tr>
  </tbody>
</table></div><br>
</div>
</div>
<div class="main-indent"><strong>位置クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>変数</td>
      <td>行</td>
      <td>1～9</td>
    </tr>
    <tr>
      <td>変数</td>
      <td>列</td>
      <td>1～9</td>
    </tr>
  </tbody>
</table></div><br>
将棋では筋、段と言い、筋は右から1,2,…となります。<br>
しかし、ここでは配列の位置としての行・列の数値で管理します。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent"><strong>移動クラス</strong>
</div>
<div class="main-indent">
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
  <tbody>
    <tr>
      <td>種別</td>
      <td>名称</td>
      <td>説明</td>
    </tr>
    <tr>
      <td>変数</td>
      <td>行</td>
      <td>1～9</td>
    </tr>
    <tr>
      <td>変数</td>
      <td>列</td>
      <td>1～9</td>
    </tr>
    <tr>
      <td>変数</td>
      <td>回数</td>
      <td>1～8</td>
    </tr>
  </tbody>
</table></div><br>
将棋では筋、段と言い、筋は右から1,2,…となります。<br>
しかし、ここでは配列の位置としての行・列の数値で管理します。<br><div class="br2"><br></div>
</div>
</div>
</div>
<div class="main-indent">
<div class="ads1">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="5140526405"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></div><h3>全体構成図</h3>
<div class="main-indent"><img src="image137.jpg" tppabs="https://excel-ubara.com/excelvba5/image137.jpg" width="585" height="580" border="0" alt="VBA マクロ Excel将棋"><br><div class="br2"><br></div>
当初のクラス設計は生かされていますが、一番大きな変更点は、棋譜クラスと棋譜フォームが追加されたことです。<br>
当初はそこまで考えておらず、駒が動かせればよいくらいに考えていました。<br>
しかし、作っていくと、いろいろと欲が出てくるもので、<br>
・棋譜を見やすく表示したい<br>
・棋譜で盤面を戻したい<br>
・棋譜ファイルを出力したい<br>
・棋譜ファイルを読み込みたい<br>
このような欲求が次々に出てきて順次実装していきました。<br><div class="br2"><br></div>
</div>
<h3>全プロシージャー・プロパティの一覧</h3>
<div class="main-indent">
<div class="table-scroll"><table border="1" cellpadding="5">
<tbody>
  <tr>
    <td>モジュール</td>
    <td>プロシージャー</td>
    <td>スコープ</td>
    <td>種別</td>
    <td>行位置</td>
    <td>ソース</td>
    <td>コメント</td>
  </tr>
  <tr>
    <td>modゲーム開始</td>
    <td>ゲーム開始</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">5</td>
    <td>Sub ゲーム開始()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>Class_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">74</td>
    <td>Private Sub Class_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>Name</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">84</td>
    <td>Public Property Get Name() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>正式名称</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">88</td>
    <td>Public Property Let 正式名称(ByVal Value As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>表示名称</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">95</td>
    <td>Public Property Let 表示名称(ByVal Value As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>通常名称</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">101</td>
    <td>Public Property Get 通常名称() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>成駒名称</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">105</td>
    <td>Public Property Let 成駒名称(ByVal Value As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>表示順</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">112</td>
    <td>Public Property Let 表示順(ByVal Value As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>駒移動</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">119</td>
    <td>Public Property Let 駒移動(ByRef arg移動() As cls移動)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>成駒移動</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">126</td>
    <td>Public Property Let 成駒移動(ByRef arg移動() As cls移動)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>先手</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">133</td>
    <td>Public Property Let 先手(ByVal Value As Boolean)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>成り</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">140</td>
    <td>Public Property Let 成り(ByVal Value As Boolean)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>駒位置</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">147</td>
    <td>Public Property Set 駒位置(ByVal arg駒位置 As g位置)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒</td>
    <td>Clone</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">159</td>
    <td>Public Function Clone() As cls駒</td>
    <td>'自身を複製する</td>
  </tr>
  <tr>
    <td>cls駒</td>
    <td>駒作成</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">175</td>
    <td>Public Function 駒作成(ByVal arg名称 As String, ByVal arg先手 As Boolean, Optional ByVal arg位置 As g位置 = Nothing ) As cls駒</td>
    <td>'駒の正式名称を受け取って、その駒特有の情報を設定する</td>
  </tr>
  <tr>
    <td>cls駒</td>
    <td>駒移動可能位置</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">233</td>
    <td>Public Function 駒移動可能位置(ByRef ary盤面() As cls駒) As Collection</td>
    <td>'駒が移動できる位置をg位置（行、列）のCollectionで返す</td>
  </tr>
  <tr>
    <td>cls駒</td>
    <td>駒移動設定</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">272</td>
    <td>Private Function 駒移動設定(ByVal arg動き As String) As cls移動()</td>
    <td>'駒の動きを定義したConstより配列を作成する</td>
  </tr>
  <tr>
    <td>cls駒台</td>
    <td>Name</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">18</td>
    <td>Public Property Get Name() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>Parent</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">22</td>
    <td>Public Property Set Parent(ByVal argParent As Object)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>手数</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">29</td>
    <td>Public Property Get 手数() As Long</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>先手</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">33</td>
    <td>Public Property Get 先手() As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>Class_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">41</td>
    <td>Private Sub Class_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>Class_Terminate</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">45</td>
    <td>Private Sub Class_Terminate()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>駒追加</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">54</td>
    <td>Public Sub 駒追加(ByVal arg駒 As cls駒)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>駒削除</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">68</td>
    <td>Public Sub 駒削除(ByVal arg駒 As Variant)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>履歴追加</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">89</td>
    <td>Public Sub 履歴追加()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>駒台一覧</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">94</td>
    <td>Public Function 駒台一覧(Optional ByVal arg手数 As Long) As String()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls駒台</td>
    <td>特定局面再現</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">107</td>
    <td>Public Sub 特定局面再現(ByVal arg手数 As Long)</td>
    <td>'静的配列のpAry駒への代入が出来ない為、一つずつ入れています。</td>
  </tr>
  <tr>
    <td>cls駒台</td>
    <td>千日手</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">127</td>
    <td>Public Function 千日手(Optional ByVal arg手数 As Long) As Boolean</td>
    <td>'指定手数の位置と同一局面が4回存在していたらTrueを返す</td>
  </tr>
  <tr>
    <td>cls駒台</td>
    <td>ArrayCompress</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">153</td>
    <td>Private Function ArrayCompress(ByRef argAry() As t駒台) As String()</td>
    <td>'駒台の配列(1 To 7)の使っていない要素を圧縮します</td>
  </tr>
  <tr>
    <td>cls駒台</td>
    <td>盤面履歴手数戻し</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">167</td>
    <td>Private Sub 盤面履歴手数戻し()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>Name</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">14</td>
    <td>Public Property Get Name() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>Parent</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">18</td>
    <td>Public Property Set Parent(ByVal argParent As Object)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>手数</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">25</td>
    <td>Public Property Get 手数() As Long</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>先手</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">29</td>
    <td>Public Property Get 先手() As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>現在盤面</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">37</td>
    <td>Public Property Get 現在盤面(Optional ByVal arg手数 As Long) As String()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>盤面履歴</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">68</td>
    <td>Public Property Get 盤面履歴() As Collection</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>棋譜履歴</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">72</td>
    <td>Public Property Get 棋譜履歴() As Collection</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>棋譜</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">76</td>
    <td>Public Property Get 棋譜(Optional ByVal arg手数 As Long) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>棋譜最終</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">80</td>
    <td>Public Property Get 棋譜最終() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>消費時間</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">84</td>
    <td>Public Property Get 消費時間(Optional ByVal arg手数 As Long) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>開始時刻</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">88</td>
    <td>Public Property Get 開始時刻() As Date</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>最終時刻</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">92</td>
    <td>Public Property Get 最終時刻() As Date</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>駒</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">96</td>
    <td>Public Property Set 駒(ByVal arg位置 As g位置, ByVal arg駒 As cls駒)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>駒配列</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">103</td>
    <td>Public Property Get 駒配列(Optional ByVal arg手数 As Long) As cls駒()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>Class_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">127</td>
    <td>Private Sub Class_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>Class_Terminate</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">133</td>
    <td>Private Sub Class_Terminate()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>駒移動可能位置</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">144</td>
    <td>Public Function 駒移動可能位置(ByVal arg位置 As g位置) As Collection</td>
    <td>'駒が移動できる位置をg位置（行、列）のCollectionで返す</td>
  </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>着手</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">149</td>
    <td>Public Sub 着手(ByVal arg駒名 As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg先手 As Boolean, Optional ByVal arg成 As Variant, Optional ByVal arg時間1手 As Date, Optional ByVal arg時間累計 As Date)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>特定局面再現</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">201</td>
    <td>Public Sub 特定局面再現(ByVal arg手数 As Long)</td>
    <td>'静的配列のpAry駒への代入が出来ない為、一つずつ入れています。</td>
  </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>棋譜終局追加</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">213</td>
    <td>Public Sub 棋譜終局追加(ByVal arg文字 As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>千日手</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">218</td>
    <td>Public Function 千日手(ByRef arg千日手開始手数 As Long, Optional ByVal arg手数 As Long) As Boolean</td>
    <td>'指定手数の位置と同一局面が4回存在していたらTrueを返す</td>
  </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>成り判定</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">245</td>
    <td>Private Function 成り判定(ByRef arg元位置 As g位置, ByVal arg先位置 As g位置, ByRef arg成り As Boolean) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋盤</td>
    <td>盤面履歴手数戻し</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">292</td>
    <td>Private Sub 盤面履歴手数戻し()</td>
  <td></td>
    </tr>
  <tr>
    <td>g位置</td>
    <td>NewPos</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">14</td>
    <td>Function NewPos(Optional ByVal arg行 As Variant, Optional ByVal arg列 As Variant) As g位置</td>
    <td>'コンストラクタとして使用</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>Name</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">49</td>
    <td>Public Property Get Name() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>Application</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">53</td>
    <td>Public Property Get Application() As Excel.Application</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>手数</td>
    <td>Public</td>
    <td>Property Let</td>
    <td align="right">57</td>
    <td>Public Property Let 手数(ByVal Value As Long)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>先手</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">64</td>
    <td>Public Property Get 先手() As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>Class_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">72</td>
    <td>Private Sub Class_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>Class_Terminate</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">84</td>
    <td>Private Sub Class_Terminate()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>xlApp_SheetSelectionChange</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">92</td>
    <td>Private Sub xlApp_SheetSelectionChange(ByVal Sh As Object, ByVal Target As Range)</td>
    <td>'WithEventsのxlAppのイベント</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>xlApp_SheetBeforeDoubleClick</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">116</td>
    <td>Private Sub xlApp_SheetBeforeDoubleClick(ByVal Sh As Object, ByVal Target As Range, Cancel As Boolean)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>ゲーム開始</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">124</td>
    <td>Public Function ゲーム開始(Optional ByVal arg手合い As String = &quot;&quot;, Optional ByVal arg大橋流 As Boolean = False) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>ゲーム終了</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">178</td>
    <td>Public Sub ゲーム終了()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>特定局面再現</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">182</td>
    <td>Public Sub 特定局面再現(ByVal arg手数 As Long)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>自動着手</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">192</td>
    <td>Public Sub 自動着手(ByVal arg駒 As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg成 As String, ByVal arg時間1手 As Date, ByVal arg時間累計 As Date, Optional ByVal argWait As Long = 100)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>棋譜位置</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">228</td>
    <td>Public Function 棋譜位置(ByVal arg筋 As Integer, ByVal arg段 As Integer) As g位置</td>
    <td>'棋譜の筋・段を配列の行・列に変換</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>配列180度回転</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">234</td>
    <td>Public Function 配列180度回転(ByRef argAry) As Variant</td>
    <td>'2次元配列を180度回転させる：実引数はRangeを想定</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>Join2DimArray</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">248</td>
    <td>Public Function Join2DimArray(ByRef argAry() As String) As String</td>
    <td>'2次元配列をJOINします</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>CompProperty</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">259</td>
    <td>Public Function CompProperty(ByVal argObj As Object, ByVal argProperty As String, ByVal argValue As Variant, Optional ByVal argOperator As String = &quot;=&quot;) As Boolean</td>
    <td>'棋譜の筋・段を配列の行・列に変換</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>駒配置</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">291</td>
    <td>Private Sub 駒配置(ByVal arg手合い As String, ByVal arg大橋流 As Boolean)</td>
    <td>'大橋流でゆっくり駒を並べます。</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>駒選択将棋盤</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">391</td>
    <td>Private Sub 駒選択将棋盤()</td>
    <td>'盤内を選択した時に駒選択と移動可能位置の色設定を行う<br>'移動可能位置をクリックした場合は着手し駒を移動する</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>駒選択駒台</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">433</td>
    <td>Private Sub 駒選択駒台()</td>
    <td>'駒台を選択した時に選択した駒の色を変更</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>着手</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">467</td>
    <td>Private Sub 着手(ByVal arg元選択 As Range, ByVal arg先選択 As Range, Optional ByVal arg成 As Variant, Optional ByVal arg時間1手 As Date, Optional ByVal arg時間累計 As Date)</td>
    <td>'駒選択後に移動可能位置を選択したら着手します</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>盤面表示</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">537</td>
    <td>Private Sub 盤面表示(Optional arg手数 As Long)</td>
    <td>'盤面配列をシートに表示する</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>選択解除</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">622</td>
    <td>Private Sub 選択解除()</td>
    <td>'前回選択と今回選択を消去して選択状態を解除</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>選択セルを手番に移動</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">628</td>
    <td>Private Sub 選択セルを手番に移動()</td>
    <td>'次のSheetSelectionChangeが効くように先手後手の位置へ選択セルを移動させる</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>駒移動可能位置色変更</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">635</td>
    <td>Private Sub 駒移動可能位置色変更(ByVal argCol As Collection)</td>
    <td>'駒を選択した時に駒の移動可能位置の色設定を行う</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>駒移動可能</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">648</td>
    <td>Private Function 駒移動可能(ByVal arg元選択 As Range, ByVal arg先選択 As Range) As Boolean</td>
    <td>'駒選択後の次のクリックが移動可能場所かの判定</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>セル2位置</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">664</td>
    <td>Private Function セル2位置(ByVal argRng As Range) As g位置</td>
    <td>'セル選択位置を配列の位置に変換</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>移動可能範囲</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">672</td>
    <td>Private Function 移動可能範囲(ByVal arg元位置 As g位置, ByVal arg先位置 As g位置) As Boolean</td>
    <td>'移動可能範囲を判定してTrue/Falseで返す</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>選択場所</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">686</td>
    <td>Private Function 選択場所(ByVal argRange As Range) As e場所</td>
    <td>'選択場所をEnumで返す</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>反則</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">706</td>
    <td>Private Function 反則(ByVal arg元選択 As Range, ByVal arg先選択 As Range) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>反則二歩</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">750</td>
    <td>Private Function 反則二歩(ByRef arg駒配列, ByRef arg盤面() As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg駒名 As String, ByVal arg先手 As Boolean, Optional ByVal argMsg As Boolean = True) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>反則不動駒</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">771</td>
    <td>Private Function 反則不動駒(ByRef arg駒配列, ByRef arg盤面() As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg駒名 As String, ByVal arg先手 As Boolean, Optional ByVal argMsg As Boolean = True) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>反則王手放置</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">799</td>
    <td>Private Function 反則王手放置(ByRef arg駒配列, ByRef arg盤面() As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg駒名 As String, ByVal arg先手 As Boolean) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>反則打歩詰め</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">816</td>
    <td>Private Function 反則打歩詰め(ByRef arg駒配列, ByRef arg盤面() As String, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg駒名 As String, ByVal arg先手 As Boolean) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>詰み</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">838</td>
    <td>Private Function 詰み(ByRef arg駒配列() As cls駒, ByVal arg先手) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>詰み駒移動回避</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">859</td>
    <td>Private Function 詰み駒移動回避(ByRef arg駒配列() As cls駒, ByVal arg先手) As Boolean</td>
    <td>'盤上の駒（玉を含む）を移動して王手を回避できるか</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>詰み駒打ち回避</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">887</td>
    <td>Private Function 詰み駒打ち回避(ByRef arg駒配列() As cls駒, ByVal arg先手) As Boolean</td>
    <td>'持駒を打つことで王手を回避できるか</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>着手後盤面</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">938</td>
    <td>Private Function 着手後盤面(ByRef arg駒配列, ByVal arg元位置 As g位置, ByVal arg先位置 As g位置, ByVal arg駒名 As String, ByVal arg先手 As Boolean) As cls駒()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>王手</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">956</td>
    <td>Private Function 王手(ByRef ary駒() As cls駒, ByVal arg先手 As Boolean) As Boolean</td>
    <td>'arg先手=Trueなら先手に王手がかかっているか判定</td>
  </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>千日手</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">983</td>
    <td>Private Function 千日手(ByRef arg千日手開始手数 As Long) As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>連続王手の千日手</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">993</td>
    <td>Private Function 連続王手の千日手(ByVal arg千日手開始手数 As Long) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>新規シート作成</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">1024</td>
    <td>Private Sub 新規シート作成(ByVal ws As Worksheet)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>シート消去</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">1034</td>
    <td>Private Sub シート消去()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>シート名前定義</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">1048</td>
    <td>Private Sub シート名前定義()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls将棋進行</td>
    <td>シート書式設定</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">1071</td>
    <td>Private Sub シート書式設定()</td>
  <td></td>
    </tr>
  <tr>
    <td>Module1</td>
    <td>delBuiltinDocumentProperties</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">3</td>
    <td>Sub delBuiltinDocumentProperties()</td>
  <td></td>
    </tr>
  <tr>
    <td>Module1</td>
    <td>かいとか</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">27</td>
    <td>Sub かいとか()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>Name</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">16</td>
    <td>Public Property Get Name() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>Parent</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">20</td>
    <td>Public Property Set Parent(ByVal argParent As Object)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>手数</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">27</td>
    <td>Public Property Get 手数() As Long</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>先手</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">31</td>
    <td>Public Property Get 先手() As Boolean</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜履歴</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">39</td>
    <td>Public Property Get 棋譜履歴() As Collection</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">43</td>
    <td>Public Property Get 棋譜(Optional ByVal arg手数 As Long) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜最終</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">52</td>
    <td>Public Property Get 棋譜最終() As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>消費時間</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">57</td>
    <td>Public Property Get 消費時間(Optional ByVal arg手数 As Long) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>開始時刻</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">67</td>
    <td>Public Property Get 開始時刻() As Date</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>最終時刻</td>
    <td>Public</td>
    <td>Property Get</td>
    <td align="right">71</td>
    <td>Public Property Get 最終時刻() As Date</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>Class_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">79</td>
    <td>Private Sub Class_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>Class_Terminate</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">87</td>
    <td>Private Sub Class_Terminate()</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜作成</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">98</td>
    <td>Public Function 棋譜作成(ByVal arg元位置 As g位置, ByVal arg駒先 As cls駒, ByRef arg成り As Boolean, Optional ByVal arg時間1手 As Date, Optional ByVal arg時間累計 As Date) As String</td>
    <td>'棋譜はKIF形式で作成<br>'###1 ５ニ銀成(43) (mm:ss/hh:mm:ss)</td>
  </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜終局追加</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">151</td>
    <td>Public Sub 棋譜終局追加(ByVal arg文字 As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>KIF駒名変換</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">161</td>
    <td>Private Function KIF駒名変換(ByVal arg駒先 As cls駒, ByRef arg成り As Boolean) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>cls棋譜</td>
    <td>棋譜履歴手数戻し</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">179</td>
    <td>Private Sub 棋譜履歴手数戻し()</td>
    <td>'棋譜履歴：手数戻しに対応</td>
  </tr>
  <tr>
    <td>frm棋譜</td>
    <td>Parent</td>
    <td>Public</td>
    <td>Property Set</td>
    <td align="right">25</td>
    <td>Public Property Set Parent(ByVal argParent As Object)</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>btn棋譜出力_Click</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">37</td>
    <td>Private Sub btn棋譜出力_Click()</td>
    <td>'拡張子".kif"のShift-JISで出力</td>
  </tr>
  <tr>
    <td>frm棋譜</td>
    <td>btn棋譜読込_Click</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">70</td>
    <td>Private Sub btn棋譜読込_Click()</td>
    <td>'拡張子".kif"のShift-JISのみ対応</td>
  </tr>
  <tr>
    <td>frm棋譜</td>
    <td>KIF棋譜読込</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">88</td>
    <td>Public Function KIF棋譜読込(ByRef aryKif() As String) As Boolean</td>
    <td>'KIF形式ファイルからの棋譜の配列を読み盤面を再現する</td>
  </tr>
  <tr>
    <td>frm棋譜</td>
    <td>KIF棋譜再現</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">135</td>
    <td>Private Sub KIF棋譜再現(ByRef ary棋譜() As tKif)</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>parseKif</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">165</td>
    <td>Private Function parseKif(ByVal argKif As String) As tKif</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>mmss2hhmmss</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">212</td>
    <td>Private Function mmss2hhmmss(ByVal mmss As String) As Date</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>readKif</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">223</td>
    <td>Private Function readKif(ByVal argFile As String, Optional ByVal CharSet As String = &quot;SHIFT-JIS&quot;) As String()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>readStream</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">237</td>
    <td>Private Function readStream(ByVal argFile As String, ByVal CharSet As String) As String</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>ControlsEnable</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">249</td>
    <td>Private Sub ControlsEnable(ByVal argEnabled As Boolean)</td>
    <td>'Me.Enabledでは、VBA終了時にフォームが戻らない場合があったので対応</td>
  </tr>
  <tr>
    <td>frm棋譜</td>
    <td>UserForm_Initialize</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">260</td>
    <td>Private Sub UserForm_Initialize()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>UserForm_QueryClose</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">279</td>
    <td>Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>UserForm_Terminate</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">286</td>
    <td>Private Sub UserForm_Terminate()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>btn対局開始_Click</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">291</td>
    <td>Private Sub btn対局開始_Click()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>lst棋譜_Change</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">298</td>
    <td>Private Sub lst棋譜_Change()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>棋譜追加</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">316</td>
    <td>Public Sub 棋譜追加(ByVal arg棋譜 As String)</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>棋譜表示</td>
    <td>Public</td>
    <td>Sub Function</td>
    <td align="right">328</td>
    <td>Public Sub 棋譜表示(ByVal arg棋譜 As Collection, ByVal arg開始時刻 As Date, ByVal arg最終時刻)</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>先手後手表示</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">346</td>
    <td>Private Sub 先手後手表示()</td>
  <td></td>
    </tr>
  <tr>
    <td>frm棋譜</td>
    <td>親オブジェク喪失</td>
    <td>Private</td>
    <td>Sub Function</td>
    <td align="right">350</td>
    <td>Private Function 親オブジェク喪失() As Boolean</td>
  <td></td>
    </tr>
</tbody>
</table></div><br>
この一覧は以下で紹介しているVBAを使用し自動作成したものです。
<div class="main-indent"><strong><a href="EXCELVBA269.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA269.html" target="_blank">VBAコードの全プロシージャー・プロパティ一覧を取得</a></strong><div class="details">VBAの開発規模がある程度大きくなってくると、VBAソース管理の必要性を感じることもあると思います。モジュールの数も増えてきて、プロシージャー・プロパティが膨大になってきます。以下は、指定ブックの全モジュールの全プロシージャー・プロパティを一覧にするVBAサンプルです。</div><br>
</div>
</div>
<h3>全VBAコード</h3>
<div class="main-indent">
<h4>標準モジュール</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
      Private obj将棋 As cls将棋進行<br><div class="br2"><br></div>
Sub ゲーム開始()<br>
　　Set obj将棋 = New cls将棋進行<br>
　　obj将棋.ゲーム開始<br>
End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
obj将棋はモジュールレベル変数にせず、プロシージャーレベルとして、<br>
Dim obj将棋 As cls将棋進行<br>
これをSubの中で定義しても動きます。<br>
この辺りは、使い方次第です。<br><div class="br2"><br></div>
</div>
</div>
<div class="main-indent">
<h4>将棋進行クラスケ：cls将棋進行</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
<span style="color:#009900;">'API</span><br>
Private Declare PtrSafe Sub Sleep Lib &quot;kernel32&quot; (ByVal dwMilliseconds As Long)<br><div class="br2"><br></div>
<span style="color:#009900;">'盤面配色定数：自由に設定可</span><br>
Private Const cnsFont As String = &quot;AR教科書体M&quot;<br>
Private Const cns将棋盤色 As Long = &amp;H75DEFF <span style="color:#009900;">'RGB(255, 222, 117)</span><br>
Private Const cns駒選択色 As Long = &amp;HD9E4FC <span style="color:#009900;">'RGB(252, 228, 217)</span><br><div class="br2"><br></div>
<span style="color:#009900;">'イベント用</span><br>
Private WithEvents xlApp As Excel.Application<br>
Private RunAuto As Boolean<br><div class="br2"><br></div>
<span style="color:#009900;">'Excel将棋の各オブジェクト</span><br>
Private obj将棋盤 As cls将棋盤<br>
Private obj先手駒台 As cls駒台<br>
Private obj後手駒台 As cls駒台<br><div class="br2"><br></div>
<span style="color:#009900;">'シートおよび名前定義の設定</span><br>
Private pWs As Worksheet<br>
Private pR前回選択 As Range<br>
Private pR今回選択 As Range<br>
Private pR開始位置 As Range<br>
Private pR将棋盤 As Range<br>
Private pR先手持駒 As Range<br>
Private pR後手持駒 As Range<br>
Private pR先手時間 As Range<br>
Private pR後手時間 As Range<br>
Private pR手数 As Range<br>
Private pR棋譜 As Range<br>
Private pR将棋盤色 As Range<br>
Private pR駒選択色 As Range<br><div class="br2"><br></div>
<span style="color:#009900;">'手数を管理する：先手後手はこの数値の奇数偶数で判断</span><br>
Private p手数 As Long<br><div class="br2"><br></div>
<span style="color:#009900;">'選択場所の判定</span><br>
Private Enum e場所<br>
　　将棋盤<br>
　　先手持駒<br>
　　後手持駒<br>
End Enum<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開プロパティ</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get Name() As String<br>
　　Name = TypeName(Me)<br>
End Property<br><div class="br2"><br></div>
Public Property Get Application() As Excel.Application<br>
　　Set Application = xlApp<br>
End Property<br><div class="br2"><br></div>
Public Property Let 手数(ByVal Value As Long)<br>
　　p手数 = Value<br>
End Property<br>
Public Property Get 手数() As Long<br>
　　手数 = p手数<br>
End Property<br><div class="br2"><br></div>
Public Property Get 先手() As Boolean<br>
　　先手 = CBool(Me.手数 Mod 2 = 1)<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' イベント</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub Class_Initialize()<br>
　　Set obj将棋盤 = New cls将棋盤<br>
　　Set obj先手駒台 = New cls駒台<br>
　　Set obj後手駒台 = New cls駒台<br>
　　<br>
　　Set obj将棋盤.Parent = Me<br>
　　Set obj先手駒台.Parent = Me<br>
　　Set obj後手駒台.Parent = Me<br>
　　<br>
　　Me.手数 = 1 <span style="color:#009900;">'次の手数</span><br>
End Sub<br><div class="br2"><br></div>
Private Sub Class_Terminate()<br>
　　Set xlApp = Nothing<br>
　　Set obj将棋盤 = Nothing<br>
　　Set obj先手駒台 = Nothing<br>
　　Set obj後手駒台 = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'WithEventsのxlAppのイベント</span><br>
Private Sub xlApp_SheetSelectionChange(ByVal Sh As Object, ByVal Target As Range)<br>
　　If RunAuto Then Exit Sub<br>
　　If pR将棋盤 Is Nothing Then Exit Sub<br>
　　If Not Sh Is pR将棋盤.Worksheet Then Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'いったん盤全体と駒台を既定色に</span><br>
　　pR将棋盤.Interior.Color = pR将棋盤色.Interior.Color<br>
　　pR先手持駒.Interior.Color = pR将棋盤色.Interior.Color<br>
　　pR後手持駒.Interior.Color = pR将棋盤色.Interior.Color<br>
　　<br>
　　Call 選択セルを手番に移動<br>
　　Set pR前回選択 = pR今回選択<br>
　　Set pR今回選択 = Target.Item(1)<br>
　　<br>
　　Select Case 選択場所(Target.Item(1))<br>
　　　　Case e場所.将棋盤<br>
　　　　　　Call 駒選択将棋盤<br>
　　　　Case e場所.先手持駒, e場所.後手持駒<br>
　　　　　　Call 駒選択駒台<br>
　　　　Case Else<br>
　　　　　　Call 選択解除<br>
　　End Select<br>
End Sub<br><div class="br2"><br></div>
Private Sub xlApp_SheetBeforeDoubleClick(ByVal Sh As Object, ByVal Target As Range, Cancel As Boolean)<br>
　　Cancel = True<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Function ゲーム開始(Optional ByVal arg手合い As String = &quot;&quot;, _<br>
　　　　　　　　　　　　　 Optional ByVal arg大橋流 As Boolean = False) As Boolean<br>
　　<span style="color:#009900;">'標準モジュールから呼ばれた場合、フォームが表示されていたらは処理しない</span><br>
　　If arg手合い = &quot;&quot; Then<br>
　　　　If frm棋譜.Visible Then Exit Function<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'シート選択</span><br>
　　Dim flgNew As Boolean<br>
　　On Error Resume Next<br>
　　Set pR開始位置 = ActiveSheet.Range(&quot;開始駒位置&quot;)<br>
　　If Err Then<br>
　　　　Err.Clear<br>
　　　　Set pR開始位置 = Excel.Application.InputBox( _<br>
　　　　　　　　　　　　prompt:=&quot;将棋盤を作成するシートの作成開始左上をクリックしてください。&quot; &amp; vbLf &amp; _<br>
　　　　　　　　　　　　&quot;※シートは全消去されます。&quot;, _<br>
　　　　　　　　　　　　Title:=&quot;作成シート選択&quot;, _<br>
　　　　　　　　　　　　Type:=8)<br>
　　　　If Err Then<br>
　　　　　　ゲーム開始 = False<br>
　　　　　　Exit Function<br>
　　　　End If<br>
　　　　flgNew = True<br>
　　Else<br>
　　　　flgNew = False<br>
　　End If<br>
　　On Error GoTo 0<br>
　　<br>
　　Set pWs = pR開始位置.Worksheet<br>
　　Set xlApp = pR開始位置.Application<br>
　　xlApp.GoTo pR開始位置<br>
　　xlApp.EnableEvents = False<br>
　　xlApp.Cursor = xlWait<br>
　　<br>
　　xlApp.ScreenUpdating = False<br>
　　Call シート名前定義<br>
　　If flgNew Then Call 新規シート作成(pWs)<br>
　　Call シート消去<br>
　　xlApp.ScreenUpdating = True<br>
　　<br>
　　Call Class_Initialize<br>
　　Call 駒配置(arg手合い, arg大橋流)<br>
　　<br>
　　With frm棋譜<br>
　　　　If .Visible = False Then .Show vbModeless<br>
　　　　Set .Parent = Me<br>
　　End With<br>
　　<br>
　　xlApp.Cursor = xlDefault<br>
　　xlApp.GoTo pR先手時間.Offset(, -1)<br>
　　xlApp.EnableEvents = True<br>
　　ゲーム開始 = True<br>
End Function<br><div class="br2"><br></div>
Public Sub ゲーム終了()<br>
　　End<br>
End Sub<br><div class="br2"><br></div>
Public Sub 特定局面再現(ByVal arg手数 As Long)<br>
　　If arg手数 &lt;= 0 Then Exit Sub<br>
　　<br>
　　Me.手数 = arg手数 + 1<br>
　　Call obj将棋盤.特定局面再現(arg手数)<br>
　　Call obj先手駒台.特定局面再現(arg手数)<br>
　　Call obj後手駒台.特定局面再現(arg手数)<br>
　　Call 盤面表示(arg手数)<br>
End Sub<br><div class="br2"><br></div>
Public Sub 自動着手(ByVal arg駒 As String, _<br>
　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　ByVal arg成 As String, _<br>
　　　　　　　　　　ByVal arg時間1手 As Date, _<br>
　　　　　　　　　　ByVal arg時間累計 As Date, _<br>
　　　　　　　　　　Optional ByVal argWait As Long = 100)<br>
　　RunAuto = True<br>
　　xlApp.Cursor = xlWait<br>
　　<br>
　　Dim rng元 As Range<br>
　　Dim rng先 As Range<br>
　　<br>
　　If arg元位置.行 = 0 Then<br>
　　　　If Me.先手 Then<br>
　　　　　　Set rng元 = pR先手持駒.Find(arg駒)<br>
　　　　Else<br>
　　　　　　Set rng元 = pR後手持駒.Find(arg駒)<br>
　　　　End If<br>
　　Else<br>
　　　　Set rng元 = pR将棋盤.Cells(arg元位置.行, arg元位置.列)<br>
　　End If<br>
　　Set rng先 = pR将棋盤.Cells(arg先位置.行, arg先位置.列)<br>
　　<br>
　　Call 着手(rng元, rng先, arg成, arg時間1手, arg時間累計)<br>
　　Sleep argWait<br>
　　<br>
　　xlApp.Cursor = xlDefault<br>
　　RunAuto = False<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド：汎用関数</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'棋譜の筋・段を配列の行・列に変換</span><br>
Public Function 棋譜位置(ByVal arg筋 As Integer, _<br>
　　　　　　　　　　　　 ByVal arg段 As Integer) As g位置<br>
　　Set 棋譜位置 = g位置(arg段, 10 - arg筋)<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'2次元配列を180度回転させる：実引数はRangeを想定</span><br>
Public Function 配列180度回転(ByRef argAry) As Variant<br>
　　Dim inAry, outAry<br>
　　inAry = argAry<br>
　　ReDim outAry(LBound(inAry, 1) To UBound(inAry, 1), LBound(inAry, 2) To UBound(inAry, 2))<br>
　　Dim i As Long, j As Long<br>
　　For i = LBound(inAry, 1) To UBound(inAry, 1)<br>
　　　　For j = LBound(inAry, 2) To UBound(inAry, 2)<br>
　　　　　　outAry(UBound(inAry, 1) - i + LBound(inAry, 1), UBound(inAry, 2) - j + LBound(inAry, 2)) = inAry(i, j)<br>
　　　　Next<br>
　　Next<br>
　　配列180度回転 = outAry<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'2次元配列をJOINします</span><br>
Public Function Join2DimArray(ByRef argAry() As String) As String<br>
　　Join2DimArray = &quot;&quot;<br>
　　Dim i As Long, j As Long<br>
　　For i = LBound(argAry, 1) To UBound(argAry, 1)<br>
　　　　For j = LBound(argAry, 2) To UBound(argAry, 2)<br>
　　　　　　Join2DimArray = Join2DimArray &amp; argAry(i, j)<br>
　　　　Next<br>
　　Next<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'棋譜の筋・段を配列の行・列に変換</span><br>
Public Function CompProperty(ByVal argObj As Object, _<br>
　　　　　　　　　　　　　　　　ByVal argProperty As String, _<br>
　　　　　　　　　　　　　　　　ByVal argValue As Variant, _<br>
　　　　　　　　　　　　　　　　Optional ByVal argOperator As String = &quot;=&quot;) As Boolean<br>
　　CompProperty = False<br>
　　If argObj Is Nothing Then Exit Function<br>
　　<br>
　　Dim v As Variant<br>
　　v = CallByName(argObj, argProperty, VbGet)<br>
　　Select Case argOperator<br>
　　　　Case &quot;=&quot;<br>
　　　　　　If v = argValue Then CompProperty = True<br>
　　　　Case &quot;&gt;&quot;<br>
　　　　　　If v &gt; argValue Then CompProperty = True<br>
　　　　Case &quot;&lt;&quot;<br>
　　　　　　If v &lt; argValue Then CompProperty = True<br>
　　　　Case &quot;&gt;=&quot;<br>
　　　　　　If v &gt;= argValue Then CompProperty = True<br>
　　　　Case &quot;&lt;=&quot;<br>
　　　　　　If v &lt;= argValue Then CompProperty = True<br>
　　　　Case &quot;&lt;&gt;&quot;<br>
　　　　　　If v &lt;&gt; argValue Then CompProperty = True<br>
　　　　Case &quot;Is&quot;<br>
　　　　　　If v Is argValue Then CompProperty = True<br>
　　End Select<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：ゲーム開始で駒を並べる</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'大橋流でゆっくり駒を並べます。</span><br>
Private Sub 駒配置(ByVal arg手合い As String, _<br>
　　　　　　　　　 ByVal arg大橋流 As Boolean)<br>
　　<span style="color:#009900;">'先手後手の定数</span><br>
　　Const c先手 As Boolean = True<br>
　　Const c後手 As Boolean = False<br>
　　<br>
　　If arg手合い = &quot;&quot; Then Exit Sub<br>
　　Dim ary駒配置<br>
　　ary駒配置 = Array( _<br>
　　　　　　　　Array(5, 9, &quot;玉&quot;, c先手), Array(5, 1, &quot;玉&quot;, c後手), _<br>
　　　　　　　　Array(6, 9, &quot;金&quot;, c先手), Array(4, 1, &quot;金&quot;, c後手), _<br>
　　　　　　　　Array(4, 9, &quot;金&quot;, c先手), Array(6, 1, &quot;金&quot;, c後手), _<br>
　　　　　　　　Array(7, 9, &quot;銀&quot;, c先手), Array(3, 1, &quot;銀&quot;, c後手), _<br>
　　　　　　　　Array(3, 9, &quot;銀&quot;, c先手), Array(7, 1, &quot;銀&quot;, c後手), _<br>
　　　　　　　　Array(8, 9, &quot;桂&quot;, c先手), Array(2, 1, &quot;桂&quot;, c後手), _<br>
　　　　　　　　Array(2, 9, &quot;桂&quot;, c先手), Array(8, 1, &quot;桂&quot;, c後手), _<br>
　　　　　　　　Array(9, 9, &quot;香&quot;, c先手), Array(1, 1, &quot;香&quot;, c後手), _<br>
　　　　　　　　Array(1, 9, &quot;香&quot;, c先手), Array(9, 1, &quot;香&quot;, c後手), _<br>
　　　　　　　　Array(8, 8, &quot;角&quot;, c先手), Array(2, 2, &quot;角&quot;, c後手), _<br>
　　　　　　　　Array(2, 8, &quot;飛&quot;, c先手), Array(8, 2, &quot;飛&quot;, c後手), _<br>
　　　　　　　　Array(5, 7, &quot;歩&quot;, c先手), Array(5, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(6, 7, &quot;歩&quot;, c先手), Array(4, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(4, 7, &quot;歩&quot;, c先手), Array(6, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(7, 7, &quot;歩&quot;, c先手), Array(3, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(3, 7, &quot;歩&quot;, c先手), Array(7, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(8, 7, &quot;歩&quot;, c先手), Array(2, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(2, 7, &quot;歩&quot;, c先手), Array(8, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(9, 7, &quot;歩&quot;, c先手), Array(1, 3, &quot;歩&quot;, c後手), _<br>
　　　　　　　　Array(1, 7, &quot;歩&quot;, c先手), Array(9, 3, &quot;歩&quot;, c後手))<br>
　　Select Case arg手合い<br>
　　　　Case &quot;香落ち&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　Case &quot;角落ち&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　Case &quot;飛車落ち&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;飛車香落ち&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;二枚落ち&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;四枚落ち&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(16)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;六枚落ち&quot;<br>
　　　　　　ary駒配置(10)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(12)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(16)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;八枚落ち&quot;<br>
　　　　　　ary駒配置(6)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(8)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(10)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(12)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(16)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　　　Case &quot;十枚落ち&quot;<br>
　　　　　　ary駒配置(2)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(4)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(6)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(8)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(10)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(12)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(14)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(16)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(18)(2) = &quot;&quot;<br>
　　　　　　ary駒配置(20)(2) = &quot;&quot;<br>
　　End Select<br>
　　DoEvents<br>
　　If arg大橋流 Then Sleep 300<br>
　　<br>
　　Dim i As Long, j As Long<br>
　　With obj将棋盤<br>
　　　　For i = LBound(ary駒配置) To UBound(ary駒配置)<br>
　　　　　　If ary駒配置(i)(2) &lt;&gt; &quot;&quot; Then<br>
　　　　　　　　.着手 ary駒配置(i)(2), Nothing, 棋譜位置(ary駒配置(i)(0), ary駒配置(i)(1)), ary駒配置(i)(3)<br>
　　　　　　　　If arg大橋流 Then<br>
　　　　　　　　　　Call 盤面表示<br>
　　　　　　　　　　Sleep 100<br>
　　　　　　　　End If<br>
　　　　　　End If<br>
　　　　Next<br>
　　End With<br>
　　<br>
　　If Not arg大橋流 Then Call 盤面表示<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：SheetSelectionChangeから直接呼ばれるプロシージャー</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'盤内を選択した時に駒選択と移動可能位置の色設定を行う</span><br>
<span style="color:#009900;">'移動可能位置をクリックした場合は着手し駒を移動する</span><br>
Private Sub 駒選択将棋盤()<br>
　　If pR今回選択 Is Nothing Then: Stop: Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'同じ駒を選択したときは解除</span><br>
　　If Not pR前回選択 Is Nothing Then<br>
　　　　If pR前回選択.Address = pR今回選択.Address Then<br>
　　　　　　Call 選択解除<br>
　　　　　　Exit Sub<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'着手して駒を移動、反則（禁じ手）は選択解除する</span><br>
　　If Not pR前回選択 Is Nothing Then<br>
　　　　If 駒移動可能(pR前回選択, pR今回選択) Then<br>
　　　　　　If Not 反則(pR前回選択, pR今回選択) Then<br>
　　　　　　　　Call 着手(pR前回選択, pR今回選択)<br>
　　　　　　End If<br>
　　　　　　Call 選択解除<br>
　　　　　　Exit Sub<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'最初の選択は手番の駒以外（相手の駒）は選択できない</span><br>
　　If pR今回選択.Value &lt;&gt; &quot;&quot; Then<br>
　　　　If obj将棋盤.駒(セル2位置(pR今回選択)).先手 &lt;&gt; Me.先手 Then<br>
　　　　　　Call 選択解除<br>
　　　　　　Exit Sub<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'駒のない場所の選択は無視</span><br>
　　If pR今回選択.Value = &quot;&quot; Then<br>
　　　　Call 選択解除<br>
　　　　Exit Sub<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'選択駒と移動可能位置の色変更</span><br>
　　pR今回選択.Interior.Color = pR駒選択色.Interior.Color<br>
　　Call 駒移動可能位置色変更(obj将棋盤.駒移動可能位置(セル2位置(pR今回選択)))<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'駒台を選択した時に選択した駒の色を変更</span><br>
Private Sub 駒選択駒台()<br>
　　Dim tmp駒台 As cls駒台<br>
　　Set tmp駒台 = IIf(Me.先手, obj先手駒台, obj後手駒台)<br>
　　Dim tmp持駒 As Range<br>
　　Set tmp持駒 = IIf(Me.先手, pR先手持駒, pR後手持駒)<br>
　　<br>
　　<span style="color:#009900;">'いったん持駒を既定色に</span><br>
　　tmp持駒.Interior.Color = pR将棋盤色.Interior.Color<br>
　　<br>
　　If pR今回選択 Is Nothing Then: Stop: Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'同じ駒を選択したときは解除</span><br>
　　If Not pR前回選択 Is Nothing Then<br>
　　　　If pR前回選択.Address = pR今回選択.Address Then<br>
　　　　　　Call 選択解除<br>
　　　　　　Exit Sub<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'駒のない場所の選択は無視</span><br>
　　If pR今回選択.Value = &quot;&quot; Then<br>
　　　　Call 選択解除<br>
　　　　Exit Sub<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'選択駒の色変更</span><br>
　　pR今回選択.Interior.Color = pR駒選択色.Interior.Color<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：着手と場面表示（将棋進行の中核プロシージャー）</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'駒選択後に移動可能位置を選択したら着手します</span><br>
Private Sub 着手(ByVal arg元選択 As Range, _<br>
　　　　　　　　ByVal arg先選択 As Range, _<br>
　　　　　　　　Optional ByVal arg成 As Variant, _<br>
　　　　　　　　Optional ByVal arg時間1手 As Date, _<br>
　　　　　　　　Optional ByVal arg時間累計 As Date)<br>
　　<span style="color:#009900;">'着手してシートを更新</span><br>
　　Dim tmp駒台 As cls駒台<br>
　　Set tmp駒台 = IIf(Me.先手, obj先手駒台, obj後手駒台)<br>
　　If arg先選択.Value &lt;&gt; &quot;&quot; Then<br>
　　　　<span style="color:#009900;">'駒台へ</span><br>
　　　　Call tmp駒台.駒追加(obj将棋盤.駒(セル2位置(arg先選択)))<br>
　　　　<span style="color:#009900;">'盤から削除</span><br>
　　　　Call obj将棋盤.着手(arg先選択.Value, セル2位置(arg先選択), g位置(0, 0), _<br>
　　　　　　　　　　　　　　Me.先手, arg成, arg時間1手, arg時間累計)<br>
　　End If<br>
　　If 選択場所(arg元選択) = e場所.将棋盤 Then<br>
　　　　<span style="color:#009900;">'盤上で駒移動</span><br>
　　　　Call obj将棋盤.着手(arg元選択.Value, セル2位置(arg元選択), セル2位置(arg先選択), _<br>
　　　　　　　　　　　　　　Me.先手, arg成, arg時間1手, arg時間累計)<br>
　　Else<br>
　　　　<span style="color:#009900;">'盤上へ駒を打つ</span><br>
　　　　Call obj将棋盤.着手(arg元選択.Value, g位置(0, 0), セル2位置(arg先選択), _<br>
　　　　　　　　　　　　　　Me.先手, arg成, arg時間1手, arg時間累計)<br>
　　　　<span style="color:#009900;">'駒台から削除</span><br>
　　　　Call tmp駒台.駒削除(arg元選択.Value)<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'駒台の履歴作成</span><br>
　　Call obj先手駒台.履歴追加<br>
　　Call obj後手駒台.履歴追加<br>
　　<br>
　　<span style="color:#009900;">'シートの表示</span><br>
　　Call 盤面表示<br>
　　Call 選択セルを手番に移動<br>
　　Call frm棋譜.棋譜表示(obj将棋盤.棋譜履歴, obj将棋盤.開始時刻, obj将棋盤.最終時刻)<br>
　　<br>
　　<span style="color:#009900;">'各種オブジェクトの手数を進める</span><br>
　　Me.手数 = Me.手数 + 1<br>
　　<br>
　　<span style="color:#009900;">'自動実行時は詰みや千日手は確認不要</span><br>
　　If RunAuto Then Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'詰んでいたら終局</span><br>
　　If 詰み(obj将棋盤.駒配列, Me.先手) Then<br>
　　　　Call obj将棋盤.棋譜終局追加(&quot;詰み&quot;)<br>
　　　　Call frm棋譜.棋譜表示(obj将棋盤.棋譜履歴, obj将棋盤.開始時刻, obj将棋盤.最終時刻)<br>
　　　　MsgBox &quot;アタタタタタタタ！！&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　 &quot;お前はもう詰んでいる&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　 IIf(Me.先手, &quot;後手&quot;, &quot;先手&quot;) &amp; &quot;の勝ちです。&quot;<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'千日手：連続王手の千日手は半策として負けにします。</span><br>
　　Dim 千日手開始手数 As Long, 反則勝ち As String<br>
　　If 千日手(千日手開始手数) Then<br>
　　　　反則勝ち = 連続王手の千日手(千日手開始手数)<br>
　　　　If 反則勝ち &lt;&gt; &quot;&quot; Then<br>
　　　　　　Call obj将棋盤.棋譜終局追加(&quot;連続王手の千日手&quot;)<br>
　　　　　　Call frm棋譜.棋譜表示(obj将棋盤.棋譜履歴, obj将棋盤.開始時刻, obj将棋盤.最終時刻)<br>
　　　　　　MsgBox &quot;連続王手の千日手で反則です。&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　　　 反則勝ち &amp; &quot;の勝ちです。&quot;<br>
　　　　Else<br>
　　　　　　Call obj将棋盤.棋譜終局追加(&quot;千日手&quot;)<br>
　　　　　　Call frm棋譜.棋譜表示(obj将棋盤.棋譜履歴, obj将棋盤.開始時刻, obj将棋盤.最終時刻)<br>
　　　　　　MsgBox &quot;このままじゃ決着がつかん・・・&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　　　 &quot;千日手が成立しました。&quot;<br>
　　　　End If<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'盤面配列をシートに表示する</span><br>
Private Sub 盤面表示(Optional arg手数 As Long)<br>
　　xlApp.ScreenUpdating = False<br>
　　Dim saveCalc As Integer<br>
　　saveCalc = Application.Calculation<br>
　　Application.Calculation = xlCalculationManual<br>
　　<br>
　　Dim ary盤面() As String<br>
　　ary盤面 = obj将棋盤.現在盤面(arg手数)<br>
　　<br>
　　<span style="color:#009900;">'将棋盤</span><br>
　　Dim i As Long, j As Long<br>
　　For i = 1 To 9<br>
　　　　For j = 1 To 9<br>
　　　　　　With pR将棋盤(i, j)<br>
　　　　　　　　If Right(ary盤面(i, j), 1) = &quot;↑&quot; Then<br>
　　　　　　　　　　<span style="color:#009900;">'先手書式</span><br>
　　　　　　　　　　If .Font.Name &lt;&gt; cnsFont Then<br>
　　　　　　　　　　　　.Font.Name = cnsFont<br>
　　　　　　　　　　End If<br>
　　　　　　　　　　If .Orientation &lt;&gt; xlHorizontal Then<br>
　　　　　　　　　　　　.Orientation = xlHorizontal<br>
　　　　　　　　　　End If<br>
　　　　　　　　ElseIf Right(ary盤面(i, j), 1) = &quot;↓&quot; Then<br>
　　　　　　　　　　<span style="color:#009900;">'後手書式</span><br>
　　　　　　　　　　If .Font.Name &lt;&gt; &quot;@&quot; &amp; cnsFont Then<br>
　　　　　　　　　　　　.Font.Name = &quot;@&quot; &amp; cnsFont<br>
　　　　　　　　　　End If<br>
　　　　　　　　　　If .Orientation &lt;&gt; xlUpward Then<br>
　　　　　　　　　　　　.Orientation = xlUpward<br>
　　　　　　　　　　End If<br>
　　　　　　　　End If<br>
　　　　　　　　<span style="color:#009900;">'表示文字</span><br>
　　　　　　　　If .Value &lt;&gt; Trim(Left(ary盤面(i, j), 1)) Then<br>
　　　　　　　　　　.Value = Trim(Left(ary盤面(i, j), 1))<br>
　　　　　　　　End If<br>
　　　　　　　　<span style="color:#009900;">'成金</span><br>
　　　　　　　　Select Case .Value<br>
　　　　　　　　　　Case &quot;龍&quot;, &quot;馬&quot;, &quot;全&quot;, &quot;圭&quot;, &quot;杏&quot;, &quot;と&quot;<br>
　　　　　　　　　　　　.Font.Color = vbRed<br>
　　　　　　　　　　Case Else<br>
　　　　　　　　　　　　If .Font.Color = vbRed Then<br>
　　　　　　　　　　　　　　.Font.Color = vbBlack<br>
　　　　　　　　　　　　End If<br>
　　　　　　　　End Select<br>
　　　　　　End With<br>
　　　　Next<br>
　　Next<br>
　　<br>
　　<span style="color:#009900;">'先手持駒</span><br>
　　pR先手持駒.Value = obj先手駒台.駒台一覧(arg手数)<br>
　　<br>
　　<span style="color:#009900;">'後手持駒</span><br>
　　pR後手持駒.Value = 配列180度回転(obj後手駒台.駒台一覧(arg手数))<br>
　　<br>
　　<span style="color:#009900;">'棋譜・手数表示</span><br>
　　Dim rng時間1 As Range, rng時間2 As Range<br>
　　If obj将棋盤.棋譜 &lt;&gt; &quot;&quot; Then<br>
　　　　pR手数.Value = IIf(arg手数 = 0, obj将棋盤.手数, arg手数)<br>
　　　　pR棋譜.Value = obj将棋盤.棋譜(arg手数)<br>
　　　　<span style="color:#009900;">'着手した後なので先後が入れかわっている</span><br>
　　　　If Me.先手 Then<br>
　　　　　　Set rng時間1 = pR先手時間<br>
　　　　　　Set rng時間2 = pR後手時間<br>
　　　　Else<br>
　　　　　　Set rng時間2 = pR先手時間<br>
　　　　　　Set rng時間1 = pR後手時間<br>
　　　　End If<br>
　　　　rng時間2.Value = obj将棋盤.消費時間(arg手数)<br>
　　　　If obj将棋盤.手数 &lt;= 1 Then<br>
　　　　　　rng時間1.Value = 0<br>
　　　　Else<br>
　　　　　　rng時間1.Value = obj将棋盤.消費時間(obj将棋盤.手数 - 1)<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　Application.Calculation = saveCalc<br>
　　xlApp.ScreenUpdating = True<br>
　　DoEvents<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：シートに関する単一機能のSubプロシージャー</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'前回選択と今回選択を消去して選択状態を解除</span><br>
Private Sub 選択解除()<br>
　　Set pR前回選択 = Nothing<br>
　　Set pR今回選択 = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'次のSheetSelectionChangeが効くように先手後手の位置へ選択セルを移動させる</span><br>
Private Sub 選択セルを手番に移動()<br>
　　xlApp.EnableEvents = False<br>
　　xlApp.GoTo IIf(Me.先手, pR先手時間.Offset(, -1), pR後手時間.Offset(, -1))<br>
　　xlApp.EnableEvents = True<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'駒を選択した時に駒の移動可能位置の色設定を行う</span><br>
Private Sub 駒移動可能位置色変更(ByVal argCol As Collection)<br>
　　If argCol Is Nothing Then Exit Sub<br>
　　Dim tmp位置 As g位置<br>
　　For Each tmp位置 In argCol<br>
　　　　pR将棋盤.Resize(1, 1).Offset(tmp位置.行 - 1, tmp位置.列 - 1).Interior.Color = pR駒選択色.Interior.Color<br>
　　Next<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：汎用関数（引数はRange、配列、g位置）</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'駒選択後の次のクリックが移動可能場所かの判定</span><br>
Private Function 駒移動可能(ByVal arg元選択 As Range, _<br>
　　　　　　　　　　　　　　ByVal arg先選択 As Range) As Boolean<br>
　　駒移動可能 = False<br>
　　Dim flg移動 As Boolean: flg移動 = False<br>
　　If 選択場所(arg先選択) = e場所.将棋盤 Then<br>
　　　　If 選択場所(arg元選択) = e場所.将棋盤 Then<br>
　　　　　　駒移動可能 = 移動可能範囲(セル2位置(arg元選択), セル2位置(arg先選択))<br>
　　　　Else<br>
　　　　　　If arg先選択.Value = &quot;&quot; Then<br>
　　　　　　　　駒移動可能 = True<br>
　　　　　　End If<br>
　　　　End If<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'セル選択位置を配列の位置に変換</span><br>
Private Function セル2位置(ByVal argRng As Range) As g位置<br>
　　Dim r As Long, c As Long<br>
　　r = argRng.Row - pR将棋盤.Row + 1<br>
　　c = argRng.Column - pR将棋盤.Column + 1<br>
　　Set セル2位置 = g位置(r, c)<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'移動可能範囲を判定してTrue/Falseで返す</span><br>
Private Function 移動可能範囲(ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　　　ByVal arg先位置 As g位置) As Boolean<br>
　　Dim tmp可能位置 As g位置<br>
　　For Each tmp可能位置 In obj将棋盤.駒移動可能位置(arg元位置)<br>
　　　　If tmp可能位置.行 = arg先位置.行 And _<br>
　　　　　 tmp可能位置.列 = arg先位置.列 Then<br>
　　　　　　移動可能範囲 = True<br>
　　　　　　Exit Function<br>
　　　　End If<br>
　　Next<br>
　　移動可能範囲 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'選択場所をEnumで返す</span><br>
Private Function 選択場所(ByVal argRange As Range) As e場所<br>
　　選択場所 = -1<br>
　　Select Case False<br>
　　　　Case Intersect(pR将棋盤, argRange) Is Nothing<br>
　　　　　　選択場所 = e場所.将棋盤<br>
　　　　Case Intersect(pR先手持駒.Resize(, 1), argRange) Is Nothing<br>
　　　　　　If Me.先手 Then<br>
　　　　　　　　選択場所 = e場所.先手持駒<br>
　　　　　　End If<br>
　　　　Case Intersect(pR後手持駒.Offset(, 1).Resize(, 1), argRange) Is Nothing<br>
　　　　　　If Not Me.先手 Then<br>
　　　　　　　　選択場所 = e場所.後手持駒<br>
　　　　　　End If<br>
　　End Select<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 反則（禁じ手）の判定：連続王手の千日手は別途</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function 反則(ByVal arg元選択 As Range, _<br>
　　　　　　　　　　 ByVal arg先選択 As Range) As Boolean<br>
　　反則 = True<br>
　　If RunAuto Then Exit Function<br>
　　<br>
　　Dim ary駒配列() As cls駒<br>
　　Dim ary盤面() As String<br>
　　Dim tmp駒名 As String<br>
　　Dim tmp元位置 As g位置<br>
　　Dim tmp先位置 As g位置<br>
　　<br>
　　<span style="color:#009900;">'個別反則判定プロシージャーへ引き渡す情報を作成</span><br>
　　ary駒配列 = obj将棋盤.駒配列(Me.手数 - 1)<br>
　　ary盤面 = obj将棋盤.現在盤面(Me.手数 - 1)<br>
　　tmp駒名 = arg元選択.Value<br>
　　Set tmp元位置 = セル2位置(arg元選択)<br>
　　Set tmp先位置 = セル2位置(arg先選択)<br>
　　If 選択場所(arg元選択) = e場所.先手持駒 Or 選択場所(arg元選択) = e場所.後手持駒 Then<br>
　　　　Set tmp元位置 = g位置(0, 0)<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'3.二歩：歩を打つ時に同列にすでに歩が存在する場合</span><br>
　　If 反則二歩(ary駒配列, ary盤面, tmp元位置, tmp先位置, tmp駒名, Me.先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'Trueが反則</span><br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'4.身動きの取れない駒を打つ：香と歩は1段、桂は2段に打てない：Trueが反則</span><br>
　　If 反則不動駒(ary駒配列, ary盤面, tmp元位置, tmp先位置, tmp駒名, Me.先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'Trueが反則</span><br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'5.王手放置：王将が取られる状態を回避しない場合：Trueが反則</span><br>
　　If 反則王手放置(ary駒配列, ary盤面, tmp元位置, tmp先位置, tmp駒名, Me.先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'Trueが反則</span><br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'6.打ち歩詰め打ち歩詰め</span><br>
　　If 反則打歩詰め(ary駒配列, ary盤面, tmp元位置, tmp先位置, tmp駒名, Me.先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'Trueが反則</span><br>
　　End If<br>
　　<br>
　　反則 = False<br>
End Function<br><div class="br2"><br></div>
Private Function 反則二歩(ByRef arg駒配列, _<br>
　　　　　　　　　　　　　ByRef arg盤面() As String, _<br>
　　　　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　ByVal arg駒名 As String, _<br>
　　　　　　　　　　　　　ByVal arg先手 As Boolean, _<br>
　　　　　　　　　　　　　Optional ByVal argMsg As Boolean = True) As Boolean<br>
　　反則二歩 = False<br>
　　If arg元位置.行 &lt;&gt; 0 Then Exit Function<br>
　　If arg駒名 &lt;&gt; &quot;歩&quot; Then Exit Function<br>
　　<br>
　　Dim i As Long<br>
　　For i = LBound(arg盤面, 2) To UBound(arg盤面)<br>
　　　　If arg盤面(i, arg先位置.列) = &quot;歩&quot; &amp; IIf(arg先手, &quot;↑&quot;, &quot;↓&quot;) Then<br>
　　　　　　If argMsg Then MsgBox &quot;二歩はダメ！&quot;<br>
　　　　　　反則二歩 = True <span style="color:#009900;">'Trueが反則</span><br>
　　　　　　Exit Function<br>
　　　　End If<br>
　　Next<br>
End Function<br><div class="br2"><br></div>
Private Function 反則不動駒(ByRef arg駒配列, _<br>
　　　　　　　　　　　　　　ByRef arg盤面() As String, _<br>
　　　　　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　　ByVal arg駒名 As String, _<br>
　　　　　　　　　　　　　　ByVal arg先手 As Boolean, _<br>
　　　　　　　　　　　　　　Optional ByVal argMsg As Boolean = True) As Boolean<br>
　　反則不動駒 = False<br>
　　If arg元位置.行 &lt;&gt; 0 Then Exit Function<br>
　　<br>
　　Select Case arg駒名<br>
　　　　Case &quot;歩&quot;, &quot;香&quot;<br>
　　　　　　If (arg先手 And arg先位置.行 = 1) Or _<br>
　　　　　　　 (Not arg先手 And arg先位置.行 = 9) Then<br>
　　　　　　　　If argMsg Then MsgBox &quot;「&quot; &amp; arg駒名 &amp; &quot;」はそこには打てないよ！&quot;<br>
　　　　　　　　反則不動駒 = True <span style="color:#009900;">'Trueが反則</span><br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　　　Case &quot;桂&quot;<br>
　　　　　　If (arg先手 And arg先位置.行 &lt;= 2) Or _<br>
　　　　　　　 (Not arg先手 And arg先位置.行 &gt;= 8) Then<br>
　　　　　　　　If argMsg Then MsgBox &quot;「&quot; &amp; arg駒名 &amp; &quot;」はそこには打てないよ！&quot;<br>
　　　　　　　　反則不動駒 = True <span style="color:#009900;">'Trueが反則</span><br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　End Select<br>
End Function<br><div class="br2"><br></div>
Private Function 反則王手放置(ByRef arg駒配列, _<br>
　　　　　　　　　　　　　　　ByRef arg盤面() As String, _<br>
　　　　　　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　　　ByVal arg駒名 As String, _<br>
　　　　　　　　　　　　　　　ByVal arg先手 As Boolean) As Boolean<br>
　　反則王手放置 = False<br>
　　<br>
　　Dim ary駒() As cls駒<br>
　　ary駒 = 着手後盤面(arg駒配列, arg元位置, arg先位置, arg駒名, arg先手)<br>
　　If 王手(ary駒, arg先手) Then<br>
　　　　MsgBox &quot;王手は放置しないでね！&quot;<br>
　　　　反則王手放置 = True <span style="color:#009900;">'Trueが反則</span><br>
　　　　Exit Function<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
Private Function 反則打歩詰め(ByRef arg駒配列, _<br>
　　　　　　　　　　　　　　　ByRef arg盤面() As String, _<br>
　　　　　　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　　　ByVal arg駒名 As String, _<br>
　　　　　　　　　　　　　　　ByVal arg先手 As Boolean) As Boolean<br>
　　反則打歩詰め = False<br>
　　If arg駒名 &lt;&gt; &quot;歩&quot; Or arg元位置.行 &lt;&gt; 0 Then Exit Function<br>
　　<br>
　　Dim ary駒() As cls駒<br>
　　ary駒 = 着手後盤面(arg駒配列, arg元位置, arg先位置, arg駒名, arg先手)<br>
　　If 詰み(ary駒, Not arg先手) Then<br>
　　　　MsgBox &quot;打ち歩詰めといって禁じ手だよ！&quot;<br>
　　　　反則打歩詰め = True <span style="color:#009900;">'Trueが反則</span><br>
　　　　Exit Function<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 詰みの判定：現在局面以外でも判定できるように駒配列を受け取る</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function 詰み(ByRef arg駒配列() As cls駒, _<br>
　　　　　　　　　　　ByVal arg先手) As Boolean<br>
　　詰み = False<br>
　　If RunAuto Then Exit Function<br>
　　<br>
　　If Not 王手(arg駒配列, arg先手) Then Exit Function<br>
　　<br>
　　<span style="color:#009900;">'盤上のどの駒をどこに動かしても王手のまま</span><br>
　　If 詰み駒移動回避(arg駒配列, arg先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'詰み回避可能</span><br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'持駒のどの駒をどこに打っても王手のまま</span><br>
　　If 詰み駒打ち回避(arg駒配列, arg先手) Then<br>
　　　　Exit Function <span style="color:#009900;">'詰み回避可能</span><br>
　　End If<br>
　　<br>
　　詰み = True<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'盤上の駒（玉を含む）を移動して王手を回避できるか</span><br>
Private Function 詰み駒移動回避(ByRef arg駒配列() As cls駒, _<br>
　　　　　　　　　　　　　　　　ByVal arg先手) As Boolean<br>
　　詰み駒移動回避 = True <span style="color:#009900;">'Trueが詰み回避可能</span><br>
　　<br>
　　Dim ary次局面() As cls駒<br>
　　Dim tmp次位置 As g位置<br>
　　Dim i As Long, j As Long<br>
　　<br>
　　<span style="color:#009900;">'盤上のどの駒をどこに動かしても王手のまま</span><br>
　　For i = 1 To 9: For j = 1 To 9<br>
　　　　If CompProperty(arg駒配列(i, j), &quot;先手&quot;, arg先手) Then<br>
　　　　　　For Each tmp次位置 In arg駒配列(i, j).駒移動可能位置(arg駒配列)<br>
　　　　　　　　ary次局面 = 着手後盤面(arg駒配列, _<br>
　　　　　　　　　　　　　　　　　　　 arg駒配列(i, j).駒位置, _<br>
　　　　　　　　　　　　　　　　　　　 tmp次位置, _<br>
　　　　　　　　　　　　　　　　　　　 arg駒配列(i, j).表示名称, _<br>
　　　　　　　　　　　　　　　　　　　 arg先手)<br>
　　　　　　　　If Not 王手(ary次局面, arg先手) Then<br>
　　　　　　　　　　Exit Function <span style="color:#009900;">'詰み回避可能</span><br>
　　　　　　　　End If<br>
　　　　　　Next<br>
　　　　End If<br>
　　Next: Next<br>
　　<br>
　　詰み駒移動回避 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'持駒を打つことで王手を回避できるか</span><br>
Private Function 詰み駒打ち回避(ByRef arg駒配列() As cls駒, _<br>
　　　　　　　　　　　　　　　　ByVal arg先手) As Boolean<br>
　　詰み駒打ち回避 = True <span style="color:#009900;">'Trueが詰み回避可能</span><br>
　　<br>
　　Dim ary駒台() As String<br>
　　If arg先手 Then<br>
　　　　ary駒台 = obj先手駒台.駒台一覧(Me.手数 - 1)<br>
　　Else<br>
　　　　ary駒台 = obj後手駒台.駒台一覧(Me.手数 - 1)<br>
　　End If<br>
　　<br>
　　Dim ary盤面() As String<br>
　　ary盤面 = obj将棋盤.現在盤面(Me.手数 - 1)<br>
　　<br>
　　Dim ary次局面() As cls駒<br>
　　Dim tmp次位置 As g位置<br>
　　Dim i As Long, j As Long, k As Long<br>
　　Dim flg禁じ手 As Boolean<br>
　　<br>
　　<span style="color:#009900;">'持駒のどの駒をどこに打っても王手のまま</span><br>
　　For k = 1 To 7<br>
　　　　If ary駒台(k, 2) &lt;&gt; &quot;&quot; Then<br>
　　　　　　For i = 1 To 9: For j = 1 To 9<br>
　　　　　　　　If arg駒配列(i, j) Is Nothing Then<br>
　　　　　　　　　　ary次局面 = 着手後盤面(arg駒配列, _<br>
　　　　　　　　　　　　　　　　　　　　　 g位置(0, 0), _<br>
　　　　　　　　　　　　　　　　　　　　　 g位置(i, j), _<br>
　　　　　　　　　　　　　　　　　　　　　 ary駒台(k, 1), _<br>
　　　　　　　　　　　　　　　　　　　　　 arg先手)<br>
　　　　　　　　　　flg禁じ手 = False<br>
　　　　　　　　　　flg禁じ手 = 反則二歩(arg駒配列, ary盤面, g位置(0, 0), g位置(i, j), ary駒台(k, 1), arg先手, False)<br>
　　　　　　　　　　If Not flg禁じ手 Then<br>
　　　　　　　　　　　　flg禁じ手 = 反則不動駒(arg駒配列, ary盤面, g位置(0, 0), g位置(i, j), ary駒台(k, 1), arg先手, False)<br>
　　　　　　　　　　End If<br>
　　　　　　　　　　If Not flg禁じ手 Then<br>
　　　　　　　　　　　　If Not 王手(ary次局面, arg先手) Then<br>
　　　　　　　　　　　　　　Exit Function <span style="color:#009900;">'詰み回避可能</span><br>
　　　　　　　　　　　　End If<br>
　　　　　　　　　　End If<br>
　　　　　　　　End If<br>
　　　　　　Next: Next<br>
　　　　End If<br>
　　Next<br>
　　<br>
　　詰み駒打ち回避 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 反則・詰みで使う共通関数</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function 着手後盤面(ByRef arg駒配列, _<br>
　　　　　　　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　　ByVal arg駒名 As String, _<br>
　　　　　　　　　　　　　　ByVal arg先手 As Boolean) As cls駒()<br>
　　Dim ary駒配列() As cls駒<br>
　　ary駒配列 = arg駒配列<br>
　　<br>
　　Dim obj駒 As New cls駒<br>
　　Set ary駒配列(arg先位置.行, arg先位置.列) = obj駒.駒作成(arg駒名, arg先手, arg先位置)<br>
　　If arg元位置.行 &lt;&gt; 0 Then<br>
　　　　Set ary駒配列(arg元位置.行, arg元位置.列) = Nothing<br>
　　End If<br>
　　<br>
　　着手後盤面 = ary駒配列<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'arg先手=Trueなら先手に王手がかかっているか判定</span><br>
Private Function 王手(ByRef ary駒() As cls駒, _<br>
　　　　　　　　　　　ByVal arg先手 As Boolean) As Boolean<br>
　　王手 = True<br>
　　<br>
　　Dim tmp位置 As g位置<br>
　　Dim tmp駒 As cls駒<br>
　　Dim i As Long, j As Long<br>
　　<br>
　　For i = 1 To 9: For j = 1 To 9<br>
　　　　If CompProperty(ary駒(i, j), &quot;先手&quot;, arg先手, &quot;&lt;&gt;&quot;) Then<br>
　　　　　　For Each tmp位置 In ary駒(i, j).駒移動可能位置(ary駒)<br>
　　　　　　　　Set tmp駒 = ary駒(tmp位置.行, tmp位置.列)<br>
　　　　　　　　If CompProperty(tmp駒, &quot;表示名称&quot;, &quot;玉&quot;) And _<br>
　　　　　　　　　 CompProperty(tmp駒, &quot;先手&quot;, arg先手) Then<br>
　　　　　　　　　　Exit Function<br>
　　　　　　　　End If<br>
　　　　　　Next<br>
　　　　End If<br>
　　Next: Next<br>
　　<br>
　　王手 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 千日手：連続王手の千日手は着手不可にせずに負けにします</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function 千日手(ByRef arg千日手開始手数 As Long) As Boolean<br>
　　If obj将棋盤.千日手(arg千日手開始手数) And _<br>
　　　 obj先手駒台.千日手() And _<br>
　　　 obj後手駒台.千日手() Then<br>
　　　　千日手 = True<br>
　　Else<br>
　　　　千日手 = False<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
Private Function 連続王手の千日手(ByVal arg千日手開始手数 As Long) As String<br>
　　Dim i As Long<br>
　　<br>
　　Dim flg1 As Boolean: flg1 = True<br>
　　For i = arg千日手開始手数 To Me.手数 - 1 Step 2<br>
　　　　If Not 王手(obj将棋盤.駒配列(i), CBool(i Mod 2 = 0)) Then<br>
　　　　　　flg1 = False<br>
　　　　　　Exit For<br>
　　　　End If<br>
　　Next<br>
　　<br>
　　Dim flg2 As Boolean: flg2 = True<br>
　　For i = arg千日手開始手数 + 1 To Me.手数 - 1 Step 2<br>
　　　　If Not 王手(obj将棋盤.駒配列(i), CBool(i Mod 2 = 0)) Then<br>
　　　　　　flg2 = False<br>
　　　　End If<br>
　　Next<br>
　　<br>
　　連続王手の千日手 = &quot;&quot;<br>
　　If flg1 Then<br>
　　　　連続王手の千日手 = IIf((Me.手数 - 1) Mod 2 = 1, &quot;後手&quot;, &quot;先手&quot;)<br>
　　End If<br>
　　If flg2 Then<br>
　　　　連続王手の千日手 = IIf((Me.手数 - 2) Mod 2 = 1, &quot;後手&quot;, &quot;先手&quot;)<br>
　　End If<br>
End Function<br>
　　　　　　　　　　<br>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド：シート設定（名前定義と書式設定）</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub 新規シート作成(ByVal ws As Worksheet)<br>
　　pWs.Cells.Clear<br>
　　ActiveWindow.DisplayGridlines = False<br>
　　ActiveWindow.Zoom = 100<br>
　　ws.Cells.Locked = True<br>
　　ws.Protect UserInterfaceOnly:=True<br>
　　pWs.Names.Add Name:=&quot;開始駒位置&quot;, RefersToLocal:=pR開始位置<br>
　　Call シート書式設定<br>
End Sub<br><div class="br2"><br></div>
Private Sub シート消去()<br>
　　pR将棋盤.ClearContents<br>
　　pR先手持駒.ClearContents<br>
　　pR後手持駒.ClearContents<br>
　　pR先手時間.ClearContents<br>
　　pR後手時間.ClearContents<br>
　　pR手数.ClearContents<br>
　　pR棋譜.ClearContents<br>
　　pR将棋盤.Interior.Color = cns将棋盤色<br>
　　pR将棋盤.Font.Color = vbBlack<br>
　　pR先手持駒.Interior.Color = cns将棋盤色<br>
　　pR後手持駒.Interior.Color = cns将棋盤色<br>
End Sub<br><div class="br2"><br></div>
Private Sub シート名前定義()<br>
　　With pWs<br>
　　　　.Names.Add Name:=&quot;将棋盤&quot;, RefersToLocal:=pR開始位置.Offset(4, 5).Resize(9, 9)<br>
　　　　.Names.Add Name:=&quot;先手持駒&quot;, RefersToLocal:=pR開始位置.Offset(6, 16).Resize(7, 2)<br>
　　　　.Names.Add Name:=&quot;先手時間&quot;, RefersToLocal:=pR開始位置.Offset(15, 12).Resize(1, 2)<br>
　　　　.Names.Add Name:=&quot;後手持駒&quot;, RefersToLocal:=pR開始位置.Offset(4, 1).Resize(7, 2)<br>
　　　　.Names.Add Name:=&quot;後手時間&quot;, RefersToLocal:=pR開始位置.Offset(1, 6).Resize(1, 2)<br>
　　　　.Names.Add Name:=&quot;手数&quot;, RefersToLocal:=pR開始位置.Offset(15, 5)<br>
　　　　.Names.Add Name:=&quot;棋譜&quot;, RefersToLocal:=pR開始位置.Offset(15, 6).Resize(1, 3)<br>
　　　　.Names.Add Name:=&quot;将棋盤色&quot;, RefersToLocal:=pR開始位置.Offset(0, 18)<br>
　　　　.Names.Add Name:=&quot;駒選択色&quot;, RefersToLocal:=pR開始位置.Offset(1, 18)<br>
　　　　Set pR将棋盤 = .Range(&quot;将棋盤&quot;)<br>
　　　　Set pR先手持駒 = .Range(&quot;先手持駒&quot;)<br>
　　　　Set pR先手時間 = .Range(&quot;先手時間&quot;)<br>
　　　　Set pR後手持駒 = .Range(&quot;後手持駒&quot;)<br>
　　　　Set pR後手時間 = .Range(&quot;後手時間&quot;)<br>
　　　　Set pR手数 = .Range(&quot;手数&quot;)<br>
　　　　Set pR棋譜 = .Range(&quot;棋譜&quot;)<br>
　　　　Set pR将棋盤色 = .Range(&quot;将棋盤色&quot;)<br>
　　　　Set pR駒選択色 = .Range(&quot;駒選択色&quot;)<br>
　　End With<br>
End Sub<br><div class="br2"><br></div>
Private Sub シート書式設定()<br>
　　<span style="color:#009900;">'列幅行高設定()</span><br>
　　With pR開始位置.EntireColumn<br>
　　　　.Offset(, 0).ColumnWidth = 2.4<br>
　　　　.Offset(, 1).ColumnWidth = 2.4<br>
　　　　.Offset(, 2).ColumnWidth = 4<br>
　　　　.Offset(, 3).ColumnWidth = 0.47<br>
　　　　.Offset(, 4).ColumnWidth = 1.6<br>
　　　　.Offset(, 5).Resize(, 9).ColumnWidth = 4<br>
　　　　.Offset(, 14).ColumnWidth = 1.6<br>
　　　　.Offset(, 15).ColumnWidth = 0.47<br>
　　　　.Offset(, 16).ColumnWidth = 4<br>
　　　　.Offset(, 17).ColumnWidth = 2.4<br>
　　　　.Offset(, 18).ColumnWidth = 2.4<br>
　　End With<br>
　　With pR開始位置.EntireRow<br>
　　　　.Offset(0).Resize(17).RowHeight = 18<br>
　　　　.Offset(2).RowHeight = 4.8<br>
　　　　.Offset(3).RowHeight = 13.8<br>
　　　　.Offset(4).Resize(9).RowHeight = 28.2<br>
　　　　.Offset(13).RowHeight = 13.8<br>
　　　　.Offset(14).RowHeight = 4.8<br>
　　End With<br><div class="br2"><br></div>
　　<span style="color:#009900;">'セル結合設定()</span><br>
　　With pWs<br>
　　　　.Range(&quot;後手時間&quot;).Merge<br>
　　　　.Range(&quot;先手時間&quot;).Merge<br>
　　　　.Range(&quot;棋譜&quot;).Merge<br>
　　End With<br><div class="br2"><br></div>
　　<span style="color:#009900;">'セル書式設定()</span><br>
　　With pR将棋盤色<br>
　　　　.Interior.Color = cns将棋盤色<br>
　　　　.BorderAround LineStyle:=xlContinuous<br>
　　End With<br>
　　With pR駒選択色<br>
　　　　.Interior.Color = cns駒選択色<br>
　　　　.BorderAround LineStyle:=xlContinuous<br>
　　End With<br>
　　With pR開始位置<br>
　　　　.Resize(17, 19).BorderAround LineStyle:=xlContinuous<br>
　　End With<br>
　　With pR将棋盤<br>
　　　　.Offset(-1, -1).Resize(11, 11).BorderAround LineStyle:=xlContinuous, Weight:=xlThick<br>
　　　　.Offset(-1, -1).Resize(11, 11).Interior.Color = pR将棋盤色.Interior.Color<br>
　　　　.Borders.LineStyle = xlContinuous<br>
　　　　.Font.Name = cnsFont<br>
　　　　.Font.Size = 20<br>
　　　　.Font.Bold = True<br>
　　　　.HorizontalAlignment = xlCenter<br>
　　　　.Resize(3).Font.Name = &quot;@&quot; &amp; cnsFont <span style="color:#009900;">'後手陣のみ</span><br>
　　　　.Resize(3).Orientation = xlUpward <span style="color:#009900;">'後手陣のみ</span><br>
　　　　.Offset(-1).Resize(1).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(-1).Resize(1).Font.Size = 8<br>
　　　　.Offset(-1).Resize(1).HorizontalAlignment = xlCenter<br>
　　　　.Offset(-1).Resize(1).VerticalAlignment = xlCenter<br>
　　　　.Offset(, 9).Resize(, 1).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(, 9).Resize(, 1).Font.Size = 8<br>
　　　　.Offset(, 9).Resize(, 1).HorizontalAlignment = xlCenter<br>
　　　　.Offset(, 9).Resize(, 1).VerticalAlignment = xlCenter<br>
　　End With<br>
　　With pR先手持駒<br>
　　　　.BorderAround LineStyle:=xlContinuous<br>
　　　　.Interior.Color = pR将棋盤色.Interior.Color<br>
　　　　.Offset(, 0).Resize(, 1).Font.Name = cnsFont<br>
　　　　.Offset(, 0).Resize(, 1).Font.Size = 20<br>
　　　　.Offset(, 0).Resize(, 1).Font.Bold = True<br>
　　　　.Offset(, 0).Resize(, 1).HorizontalAlignment = xlCenter<br>
　　　　.Offset(, 1).Resize(, 1).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(, 1).Resize(, 1).Font.Size = 11<br>
　　　　.Offset(, 1).Resize(, 1).Font.Bold = True<br>
　　　　.Offset(, 1).Resize(, 1).HorizontalAlignment = xlLeft<br>
　　End With<br>
　　With pR後手持駒<br>
　　　　.BorderAround LineStyle:=xlContinuous<br>
　　　　.Interior.Color = pR将棋盤色.Interior.Color<br>
　　　　.Offset(, 1).Resize(, 1).Font.Name = &quot;@&quot; &amp; cnsFont<br>
　　　　.Offset(, 1).Resize(, 1).Orientation = xlUpward<br>
　　　　.Offset(, 1).Resize(, 1).Font.Size = 20<br>
　　　　.Offset(, 1).Resize(, 1).Font.Bold = True<br>
　　　　.Offset(, 1).Resize(, 1).HorizontalAlignment = xlCenter<br>
　　　　.Offset(, 0).Resize(, 1).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(, 0).Resize(, 1).Font.Size = 11<br>
　　　　.Offset(, 0).Resize(, 1).Font.Bold = True<br>
　　　　.Offset(, 0).Resize(, 1).HorizontalAlignment = xlRight<br>
　　End With<br>
　　With pR先手時間<br>
　　　　.Offset(, -1).Resize(, 3).BorderAround LineStyle:=xlContinuous<br>
　　　　.Offset(, -1).Resize(, 3).Interior.Color = vbBlack<br>
　　　　.Offset(, -1).Resize(, 3).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(, -1).Resize(, 3).Font.Size = 11<br>
　　　　.Offset(, -1).Resize(, 3).Font.Bold = True<br>
　　　　.Offset(, -1).Resize(, 3).Font.Color = vbWhite<br>
　　　　.HorizontalAlignment = xlCenter<br>
　　　　.NumberFormatLocal = &quot;h:mm:ss&quot;<br>
　　End With<br>
　　With pR後手時間<br>
　　　　.Offset(, -1).Resize(, 3).BorderAround LineStyle:=xlContinuous<br>
　　　　.Offset(, -1).Resize(, 3).Interior.Color = vbWhite<br>
　　　　.Offset(, -1).Resize(, 3).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Offset(, -1).Resize(, 3).Font.Size = 11<br>
　　　　.Offset(, -1).Resize(, 3).Font.Bold = True<br>
　　　　.HorizontalAlignment = xlCenter<br>
　　　　.NumberFormatLocal = &quot;h:mm:ss&quot;<br>
　　End With<br>
　　With pR手数<br>
　　　　.Resize(, 4).Borders.LineStyle = xlContinuous<br>
　　　　.Resize(, 4).Interior.Color = pR駒選択色.Interior.Color<br>
　　　　.Resize(, 4).Font.Name = &quot;ＭＳ Ｐゴシック&quot;<br>
　　　　.Resize(, 4).Font.Size = 11<br>
　　　　.Resize(, 4).Font.Bold = True<br>
　　End With<br><div class="br2"><br></div>
　　<span style="color:#009900;">'文字設定()</span><br>
　　pR将棋盤.Offset(-1).Resize(1).Value = Array(9, 8, 7, 6, 5, 4, 3, 2, 1)<br>
　　pR将棋盤.Offset(, 9).Resize(, 1).Value = WorksheetFunction.Transpose(Array(&quot;一&quot;, &quot;二&quot;, &quot;三&quot;, &quot;四&quot;, &quot;五&quot;, &quot;六&quot;, &quot;七&quot;, &quot;八&quot;, &quot;九&quot;))<br>
　　pR先手時間.Offset(, -1).Resize(, 1).Value = &quot;先手&quot;<br>
　　pR後手時間.Offset(, -1).Resize(, 1).Value = &quot;後手&quot;<br>
　　pR将棋盤色.Offset(, -2).Value = &quot;将棋盤色&quot;<br>
　　pR駒選択色.Offset(, -2).Value = &quot;駒選択色&quot;<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>将棋盤クラス：cls将棋盤</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private pParent As Object<br>
Private obj棋譜 As cls棋譜<br>
Private pAry駒(1 To 9, 1 To 9) As cls駒<br>
Private pCol盤面 As Collection<br><div class="br2"><br></div>
Private p手数 As Long<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 共通プロパティ：cls将棋盤、cls駒台、cls棋譜</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get Name() As String<br>
　　Name = TypeName(Me)<br>
End Property<br><div class="br2"><br></div>
Public Property Set Parent(ByVal argParent As Object)<br>
　　Set pParent = argParent<br>
End Property<br>
Public Property Get Parent() As Object<br>
　　Set Parent = pParent<br>
End Property<br><div class="br2"><br></div>
Public Property Get 手数() As Long<br>
　　手数 = Me.Parent.手数<br>
End Property<br><div class="br2"><br></div>
Public Property Get 先手() As Boolean<br>
　　先手 = Me.Parent.先手<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開プロパティ</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get 現在盤面(Optional ByVal arg手数 As Long) As String()<br>
　　If arg手数 = 0 Then<br>
　　　　arg手数 = pCol盤面.Count<br>
　　End If<br>
　　<br>
　　Dim ary盤面 As Variant<br>
　　If pCol盤面.Count = 0 Then<br>
　　　　ary盤面 = pAry駒<br>
　　Else<br>
　　　　ary盤面 = pCol盤面(arg手数)<br>
　　End If<br>
　　<br>
　　Dim out盤面() As String<br>
　　ReDim out盤面(LBound(ary盤面, 1) To UBound(ary盤面, 1), _<br>
　　　　　　　　　LBound(ary盤面, 2) To UBound(ary盤面, 2))<br>
　　<br>
　　Dim i As Long, j As Long<br>
　　For i = LBound(ary盤面, 1) To UBound(ary盤面, 1)<br>
　　　　For j = LBound(ary盤面, 2) To UBound(ary盤面, 2)<br>
　　　　　　If ary盤面(i, j) Is Nothing Then<br>
　　　　　　　　out盤面(i, j) = &quot;　　&quot;<br>
　　　　　　Else<br>
　　　　　　　　out盤面(i, j) = ary盤面(i, j).表示名称 &amp; _<br>
　　　　　　　　　　　　　　　　IIf(ary盤面(i, j).先手, &quot;↑&quot;, &quot;↓&quot;)<br>
　　　　　　End If<br>
　　　　Next<br>
　　Next<br>
　　<br>
　　現在盤面 = out盤面<br>
End Property<br><div class="br2"><br></div>
Public Property Get 盤面履歴() As Collection<br>
　　Set 盤面履歴 = pCol盤面<br>
End Property<br><div class="br2"><br></div>
Public Property Get 棋譜履歴() As Collection<br>
　　Set 棋譜履歴 = obj棋譜.棋譜履歴<br>
End Property<br><div class="br2"><br></div>
Public Property Get 棋譜(Optional ByVal arg手数 As Long) As String<br>
　　棋譜 = obj棋譜.棋譜(arg手数)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 棋譜最終() As String<br>
　　棋譜最終 = obj棋譜.棋譜最終<br>
End Property<br><div class="br2"><br></div>
Public Property Get 消費時間(Optional ByVal arg手数 As Long) As String<br>
　　消費時間 = obj棋譜.消費時間(arg手数)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 開始時刻() As Date<br>
　　開始時刻 = obj棋譜.開始時刻<br>
End Property<br><div class="br2"><br></div>
Public Property Get 最終時刻() As Date<br>
　　最終時刻 = obj棋譜.最終時刻<br>
End Property<br><div class="br2"><br></div>
Public Property Set 駒(ByVal arg位置 As g位置, ByVal arg駒 As cls駒)<br>
　　Set pAry駒(arg位置.行, arg位置.列) = arg駒<br>
End Property<br>
Public Property Get 駒(ByVal arg位置 As g位置) As cls駒<br>
　　Set 駒 = pAry駒(arg位置.行, arg位置.列)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 駒配列(Optional ByVal arg手数 As Long) As cls駒()<br>
　　Dim tmp駒() As cls駒<br>
　　If arg手数 = 0 Then<br>
　　　　tmp駒 = pAry駒<br>
　　Else<br>
　　　　tmp駒 = pCol盤面(arg手数)<br>
　　End If<br>
　　<br>
　　Dim ary駒(1 To 9, 1 To 9) As cls駒<br>
　　Dim i As Long, j As Long<br>
　　For i = 1 To 9<br>
　　　　For j = 1 To 9<br>
　　　　　　If Not tmp駒(i, j) Is Nothing Then<br>
　　　　　　　　Set ary駒(i, j) = tmp駒(i, j).Clone<br>
　　　　　　End If<br>
　　　　Next<br>
　　Next<br>
　　駒配列 = ary駒<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' イベント</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub Class_Initialize()<br>
　　Set pCol盤面 = New Collection<br>
　　Set obj棋譜 = New cls棋譜<br>
　　Set obj棋譜.Parent = Me<br>
End Sub<br><div class="br2"><br></div>
Private Sub Class_Terminate()<br>
　　Set pParent = Nothing<br>
　　Set pCol盤面 = Nothing<br>
　　Set obj棋譜 = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'駒が移動できる位置をg位置（行、列）のCollectionで返す</span><br>
Public Function 駒移動可能位置(ByVal arg位置 As g位置) As Collection<br>
　　If Me.駒(arg位置) Is Nothing Then Exit Function<br>
　　Set 駒移動可能位置 = Me.駒(arg位置).駒移動可能位置(pAry駒)<br>
End Function<br><div class="br2"><br></div>
Public Sub 着手(ByVal arg駒名 As String, _<br>
　　　　　　　　ByVal arg元位置 As g位置, _<br>
　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　ByVal arg先手 As Boolean, _<br>
　　　　　　　　Optional ByVal arg成 As Variant, _<br>
　　　　　　　　Optional ByVal arg時間1手 As Date, _<br>
　　　　　　　　Optional ByVal arg時間累計 As Date)<br>
　　<span style="color:#009900;">'元位置：-1,-1は初期配置</span><br>
　　<span style="color:#009900;">'位置：0,0は駒台の出し入れ</span><br>
　　Dim obj駒 As cls駒<br>
　　Dim is成り As Boolean<br>
　　Select Case True<br>
　　　　Case arg元位置 Is Nothing <span style="color:#009900;">'初期配置</span><br>
　　　　　　Set obj駒 = New cls駒<br>
　　　　　　Set Me.駒(arg先位置) = obj駒.駒作成(arg駒名, arg先手, arg先位置)<br>
　　　　　　<span style="color:#009900;">'棋譜は不要</span><br>
　　　　　　Exit Sub<br>
　　　　Case arg先位置.行 = 0 <span style="color:#009900;">'駒台へ</span><br>
　　　　　　Set Me.駒(arg元位置) = Nothing<br>
　　　　　　<span style="color:#009900;">'棋譜は不要</span><br>
　　　　　　Exit Sub<br>
　　　　Case arg元位置.行 = 0 <span style="color:#009900;">'駒台から</span><br>
　　　　　　Set obj駒 = New cls駒<br>
　　　　　　Set Me.駒(arg先位置) = obj駒.駒作成(arg駒名, arg先手, arg先位置)<br>
　　　　Case Else <span style="color:#009900;">'駒移動</span><br>
　　　　　　Set Me.駒(arg先位置) = Me.駒(arg元位置).Clone<br>
　　　　　　Set Me.駒(arg先位置).駒位置 = arg先位置<br>
　　　　　　<span style="color:#009900;">'「is成り」はByRefで今回成ったかの情報が戻される</span><br>
　　　　　　If IsEmpty(arg成) Or IsMissing(arg成) Then<br>
　　　　　　　　Me.駒(arg先位置).成り = 成り判定(arg元位置, arg先位置, is成り)<br>
　　　　　　ElseIf arg成 = &quot;成&quot; Then<br>
　　　　　　　　Me.駒(arg先位置).成り = True<br>
　　　　　　　　is成り = True<br>
　　　　　　End If<br>
　　　　　　Set Me.駒(arg元位置) = Nothing<br>
　　End Select<br>
　　<br>
　　<span style="color:#009900;">'棋譜履歴</span><br>
　　If arg元位置.行 = 0 Then<br>
　　　　Call obj棋譜.棋譜作成(g位置(0, 0), Me.駒(arg先位置), False, _<br>
　　　　　　　　　　　　　　　arg時間1手, arg時間累計)<br>
　　Else<br>
　　　　Call obj棋譜.棋譜作成(arg元位置, Me.駒(arg先位置), is成り, _<br>
　　　　　　　　　　　　　　　arg時間1手, arg時間累計)<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'盤面履歴</span><br>
　　Call 盤面履歴手数戻し <span style="color:#009900;">'手数のカウントアップ</span><br>
　　pCol盤面.Add pAry駒<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'静的配列のpAry駒への代入が出来ない為、一つずつ入れています。</span><br>
Public Sub 特定局面再現(ByVal arg手数 As Long)<br>
　　Dim ary駒() As cls駒<br>
　　ary駒 = Me.盤面履歴(arg手数)<br>
　　<br>
　　Dim i As Long, j As Long<br>
　　For i = 1 To 9<br>
　　　　For j = 1 To 9<br>
　　　　　　Set pAry駒(i, j) = ary駒(i, j)<br>
　　　　Next<br>
　　Next<br>
End Sub<br><div class="br2"><br></div>
Public Sub 棋譜終局追加(ByVal arg文字 As String)<br>
　　Call obj棋譜.棋譜終局追加(arg文字)<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'指定手数の位置と同一局面が4回存在していたらTrueを返す</span><br>
Public Function 千日手(ByRef arg千日手開始手数 As Long, _<br>
　　　　　　　　　　　 Optional ByVal arg手数 As Long) As Boolean<br>
　　If arg手数 = 0 Then arg手数 = pCol盤面.Count<br>
　　If arg手数 &lt; 10 Then Exit Function <span style="color:#009900;">'千日手にはなりえないので</span><br>
　　<br>
　　Dim str盤面 As Variant<br>
　　str盤面 = Me.Parent.Join2DimArray(Me.現在盤面(arg手数))<br>
　　<br>
　　Dim cnt As Long, i As Long<br>
　　For i = arg手数 - 4 To 1 Step -1<br>
　　　　If Me.Parent.Join2DimArray(Me.現在盤面(i)) = str盤面 Then<br>
　　　　　　cnt = cnt + 1<br>
　　　　　　If cnt &gt;= 3 Then<br>
　　　　　　　　arg千日手開始手数 = i<br>
　　　　　　　　千日手 = True<br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　　　End If<br>
　　Next<br>
　　<br>
　　千日手 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function 成り判定(ByRef arg元位置 As g位置, _<br>
　　　　　　　　　　　　　ByVal arg先位置 As g位置, _<br>
　　　　　　　　　　　　　ByRef arg成り As Boolean) As Boolean<br>
　　arg成り = False<br>
　　成り判定 = Me.駒(arg元位置).成り<br>
　　<br>
　　<span style="color:#009900;">'成れない駒</span><br>
　　If Me.駒(arg元位置).成駒名称 = &quot;　&quot; Then Exit Function<br>
　　<span style="color:#009900;">'既に成っている駒</span><br>
　　If 成り判定 Then Exit Function<br>
　　<br>
　　<span style="color:#009900;">'敵陣に入った場合、敵陣内で動いた場合、敵陣から外に出た場合</span><br>
　　Dim can成り As Boolean<br>
　　If Me.先手 Then<br>
　　　　If arg元位置.行 &lt;= 3 Or arg先位置.行 &lt;= 3 Then<br>
　　　　　　can成り = True<br>
　　　　End If<br>
　　Else<br>
　　　　If arg元位置.行 &gt;= 7 Or arg先位置.行 &gt;= 7 Then<br>
　　　　　　can成り = True<br>
　　　　End If<br>
　　End If<br>
　　<span style="color:#009900;">'成れない場合</span><br>
　　If Not can成り Then Exit Function<br>
　　<br>
　　<span style="color:#009900;">'反則 2.動けないところに駒を進めてはいけない</span><br>
　　Select Case Me.駒(arg元位置).表示名称<br>
　　　　Case &quot;歩&quot;, &quot;香&quot;<br>
　　　　　　If (Me.先手 And arg先位置.行 = 1) Or _<br>
　　　　　　　 (Not Me.先手 And arg先位置.行 = 9) Then<br>
　　　　　　　　arg成り = True: 成り判定 = True<br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　　　Case &quot;桂&quot;<br>
　　　　　　If (Me.先手 And arg先位置.行 &lt;= 2) Or _<br>
　　　　　　　 (Not Me.先手 And arg先位置.行 &gt;= 8) Then<br>
　　　　　　　　arg成り = True: 成り判定 = True<br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　End Select<br>
　　<br>
　　<span style="color:#009900;">'成るか成らないかの確認</span><br>
　　If MsgBox(&quot;成りますか?&quot;, vbYesNo, &quot;成り確認&quot;) = vbYes Then<br>
　　　　arg成り = True: 成り判定 = True<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
Private Sub 盤面履歴手数戻し()<br>
　　Dim i As Long<br>
　　For i = pCol盤面.Count To Me.手数 Step -1<br>
　　　　Call pCol盤面.Remove(i)<br>
　　Next<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>駒台クラス：cls駒台</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private pParent As Object<br>
Private pAry駒台(1 To 7) As t駒台<br>
Private pCol駒台 As Collection<br>
Private p手数 As Long<br><div class="br2"><br></div>
Private Type t駒台<br>
　　正式名称 As String<br>
　　表示名称 As String<br>
　　個数 As Integer<br>
End Type<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 共通プロパティ：cls将棋盤、cls駒台、cls棋譜</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get Name() As String<br>
　　Name = TypeName(Me)<br>
End Property<br><div class="br2"><br></div>
Public Property Set Parent(ByVal argParent As Object)<br>
　　Set pParent = argParent<br>
End Property<br>
Public Property Get Parent() As Object<br>
　　Set Parent = pParent<br>
End Property<br><div class="br2"><br></div>
Public Property Get 手数() As Long<br>
　　手数 = Me.Parent.手数<br>
End Property<br><div class="br2"><br></div>
Public Property Get 先手() As Boolean<br>
　　先手 = Me.Parent.先手<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' イベント</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub Class_Initialize()<br>
　　Set pCol駒台 = New Collection<br>
End Sub<br><div class="br2"><br></div>
Private Sub Class_Terminate()<br>
　　Set pParent = Nothing<br>
　　Set pCol駒台 = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Sub 駒追加(ByVal arg駒 As cls駒)<br>
　　If arg駒.表示順 = 0 Then<br>
　　　　MsgBox arg駒.表示名称 &amp; &quot;は取っちゃダメなんだよ&quot; &amp; vbLf &amp; vbLf &amp; _<br>
　　　　　　　 &quot;ゲームオーバー&quot;<br>
　　　　End<br>
　　End If<br>
　　arg駒.成り = False<br>
　　With pAry駒台(arg駒.表示順)<br>
　　　　.正式名称 = arg駒.正式名称<br>
　　　　.表示名称 = arg駒.表示名称<br>
　　　　.個数 = .個数 + 1<br>
　　End With<br>
End Sub<br><div class="br2"><br></div>
Public Sub 駒削除(ByVal arg駒 As Variant)<br>
　　Dim str駒名 As String<br>
　　<br>
　　<span style="color:#009900;">'オブジェクトの指定と文字列指定の両方をサポート</span><br>
　　If IsObject(arg駒) Then <span style="color:#009900;">'Objectはcls駒のみ</span><br>
　　　　str駒名 = arg駒.表示名称<br>
　　Else<br>
　　　　str駒名 = arg駒<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'名称一致で駒台を探す</span><br>
　　Dim i As Long<br>
　　For i = LBound(pAry駒台) To UBound(pAry駒台)<br>
　　　　If pAry駒台(i).正式名称 = str駒名 Or _<br>
　　　　　 pAry駒台(i).表示名称 = str駒名 Then<br>
　　　　　　pAry駒台(i).個数 = pAry駒台(i).個数 - 1<br>
　　　　　　Exit For<br>
　　　　End If<br>
　　Next<br>
End Sub<br><div class="br2"><br></div>
Public Sub 履歴追加()<br>
　　Call 盤面履歴手数戻し<br>
　　pCol駒台.Add ArrayCompress(pAry駒台)<br>
End Sub<br><div class="br2"><br></div>
Public Function 駒台一覧(Optional ByVal arg手数 As Long) As String()<br>
　　If arg手数 = 0 Then<br>
　　　　arg手数 = pCol駒台.Count<br>
　　End If<br>
　　<br>
　　If pCol駒台.Count = 0 Then<br>
　　　　駒台一覧 = ArrayCompress(pAry駒台)<br>
　　Else<br>
　　　　駒台一覧 = pCol駒台(arg手数)<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'静的配列のpAry駒への代入が出来ない為、一つずつ入れています。</span><br>
Public Sub 特定局面再現(ByVal arg手数 As Long)<br>
　　Dim ary駒台() As String<br>
　　ary駒台 = pCol駒台(arg手数)<br>
　　<br>
　　Erase pAry駒台<br>
　　<br>
　　Dim tmp駒 As cls駒<br>
　　Dim i As Long, j As Long<br>
　　For i = 1 To 7<br>
　　　　If ary駒台(i, 1) &lt;&gt; &quot;&quot; Then<br>
　　　　　　For j = 1 To ary駒台(i, 2) <span style="color:#009900;">'個数</span><br>
　　　　　　　　Set tmp駒 = New cls駒<br>
　　　　　　　　Call tmp駒.駒作成(ary駒台(i, 1), Me.先手)<br>
　　　　　　　　Call Me.駒追加(tmp駒)<br>
　　　　　　Next<br>
　　　　End If<br>
　　Next<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'指定手数の位置と同一局面が4回存在していたらTrueを返す</span><br>
Public Function 千日手(Optional ByVal arg手数 As Long) As Boolean<br>
　　If arg手数 = 0 Then arg手数 = pCol駒台.Count<br>
　　If arg手数 &lt; 10 Then Exit Function <span style="color:#009900;">'千日手にはなりえないので</span><br>
　　<br>
　　Dim str盤面 As Variant<br>
　　str盤面 = Me.Parent.Join2DimArray(Me.駒台一覧(arg手数))<br>
　　<br>
　　Dim cnt As Long, i As Long<br>
　　For i = arg手数 - 4 To 1 Step -1<br>
　　　　If Me.Parent.Join2DimArray(Me.駒台一覧(i)) = str盤面 Then<br>
　　　　　　cnt = cnt + 1<br>
　　　　　　If cnt &gt;= 3 Then<br>
　　　　　　　　千日手 = True<br>
　　　　　　　　Exit Function<br>
　　　　　　End If<br>
　　　　End If<br>
　　Next<br>
　　<br>
　　千日手 = False<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'駒台の配列(1 To 7)の使っていない要素を圧縮します</span><br>
Private Function ArrayCompress(ByRef argAry() As t駒台) As String()<br>
　　Dim ary() As String<br>
　　ReDim ary(LBound(argAry) To UBound(argAry), 1 To 2)<br>
　　Dim i1 As Long, i2 As Long<br>
　　For i1 = LBound(argAry) To UBound(argAry)<br>
　　　　If argAry(i1).個数 &gt; 0 Then<br>
　　　　　　i2 = i2 + 1<br>
　　　　　　ary(i2, 1) = argAry(i1).表示名称<br>
　　　　　　ary(i2, 2) = argAry(i1).個数<br>
　　　　End If<br>
　　Next<br>
　　ArrayCompress = ary<br>
End Function<br><div class="br2"><br></div>
Private Sub 盤面履歴手数戻し()<br>
　　Dim i As Long<br>
　　For i = pCol駒台.Count To Me.手数 Step -1<br>
　　　　Call pCol駒台.Remove(i)<br>
　　Next<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>駒クラス：cls駒</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private p正式名称 As String<br>
Private p表示名称 As String<br>
Private p成駒名称 As String<br>
Private p表示順 As Integer<br>
Private p先手 As Boolean<br>
Private p成り As Boolean<br>
Private p駒位置 As g位置<br>
Private p駒移動() As cls移動<br>
Private p成駒移動() As cls移動<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 駒の名称や動きの定義</span><br>
<span style="color:#009900;">'**********************************************************************</span><br>
　　　　　　　　　　　　　　　　　　　　<span style="color:#009900;">'正式名称,表示名称,成駒名称,表示順</span><br>
Private Const cns王将定義　 As String = &quot;王将,玉,　,0&quot;<br>
Private Const cns飛車定義　 As String = &quot;飛車,飛,龍,1&quot;<br>
Private Const cns角行定義　 As String = &quot;角行,角,馬,2&quot;<br>
Private Const cns金将定義　 As String = &quot;金将,金,　,3&quot;<br>
Private Const cns銀将定義　 As String = &quot;銀将,銀,全,4&quot;<br>
Private Const cns桂馬定義　 As String = &quot;桂馬,桂,圭,5&quot;<br>
Private Const cns香車定義　 As String = &quot;香車,香,杏,6&quot;<br>
Private Const cns歩兵定義　 As String = &quot;歩兵,歩,と,7&quot;<br>
　　　　　　　　　　　　　　　　　　　　<span style="color:#009900;">'行,列,回数</span><br>
Private Const cns王将移動　 As String = &quot;-1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 0, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 0, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 1, 1;&quot;<br>
Private Const cns飛車移動　 As String = &quot;-1, 0, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 0, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0, 1, 8;&quot;<br>
Private Const cns龍王移動　 As String = &quot;-1, 0, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 0, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0, 1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 1, 1;&quot;<br>
Private Const cns角行移動　 As String = &quot;-1,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 1, 8;&quot;<br>
Private Const cns龍馬移動　 As String = &quot;-1,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1,-1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 1, 8;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 0, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 0, 1;&quot;<br>
Private Const cns金将移動　 As String = &quot;-1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 0, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 0, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 0, 1;&quot;<br>
Private Const cns銀将移動　 As String = &quot;-1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 0, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-1, 1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot; 1, 1, 1;&quot;<br>
Private Const cns桂馬移動　 As String = &quot;-2,-1, 1;&quot; &amp; _<br>
　　　　　　　　　　　　　　　　　　　　&quot;-2, 1, 1;&quot;<br>
Private Const cns香車移動　 As String = &quot;-1, 0, 8;&quot;<br>
Private Const cns歩兵移動　 As String = &quot;-1, 0, 1;&quot;<br>
　　　　　<br>
Private Sub Class_Initialize()<br>
　　<span style="color:#009900;">'引数省略した場合でも()を付ける必要があります。</span><br>
　　<span style="color:#009900;">'()を付けないと既定のメンバーが呼び出されない</span><br>
　　Set p駒位置 = g位置()<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開プロパティ</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get Name() As String<br>
　　Name = TypeName(Me)<br>
End Property<br><div class="br2"><br></div>
Public Property Let 正式名称(ByVal Value As String)<br>
　　p正式名称 = Value<br>
End Property<br>
Public Property Get 正式名称() As String<br>
　　正式名称 = p正式名称<br>
End Property<br><div class="br2"><br></div>
Public Property Let 表示名称(ByVal Value As String)<br>
　　p表示名称 = Value<br>
End Property<br>
Public Property Get 表示名称() As String<br>
　　表示名称 = IIf(Me.成り, p成駒名称, p表示名称)<br>
End Property<br>
Public Property Get 通常名称() As String<br>
　　通常名称 = p表示名称<br>
End Property<br><div class="br2"><br></div>
Public Property Let 成駒名称(ByVal Value As String)<br>
　　p成駒名称 = Value<br>
End Property<br>
Public Property Get 成駒名称() As String<br>
　　成駒名称 = p成駒名称<br>
End Property<br><div class="br2"><br></div>
Public Property Let 表示順(ByVal Value As String)<br>
　　p表示順 = Value<br>
End Property<br>
Public Property Get 表示順() As String<br>
　　表示順 = p表示順<br>
End Property<br><div class="br2"><br></div>
Public Property Let 駒移動(ByRef arg移動() As cls移動)<br>
　　p駒移動 = arg移動<br>
End Property<br>
Public Property Get 駒移動() As cls移動()<br>
　　駒移動 = p駒移動<br>
End Property<br><div class="br2"><br></div>
Public Property Let 成駒移動(ByRef arg移動() As cls移動)<br>
　　p成駒移動 = arg移動<br>
End Property<br>
Public Property Get 成駒移動() As cls移動()<br>
　　成駒移動 = p成駒移動<br>
End Property<br><div class="br2"><br></div>
Public Property Let 先手(ByVal Value As Boolean)<br>
　　p先手 = Value<br>
End Property<br>
Public Property Get 先手() As Boolean<br>
　　先手 = p先手<br>
End Property<br><div class="br2"><br></div>
Public Property Let 成り(ByVal Value As Boolean)<br>
　　p成り = Value<br>
End Property<br>
Public Property Get 成り() As Boolean<br>
　　成り = p成り<br>
End Property<br><div class="br2"><br></div>
Public Property Set 駒位置(ByVal arg駒位置 As g位置)<br>
　　Set p駒位置 = arg駒位置<br>
End Property<br>
Public Property Get 駒位置() As g位置<br>
　　Set 駒位置 = p駒位置<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'自身を複製する</span><br>
Public Function Clone() As cls駒<br>
　　Set Clone = New cls駒<br>
　　With Clone<br>
　　　　.正式名称 = p正式名称<br>
　　　　.表示名称 = p表示名称<br>
　　　　.成駒名称 = p成駒名称<br>
　　　　.表示順 = p表示順<br>
　　　　.先手 = p先手<br>
　　　　.成り = p成り<br>
　　　　Set .駒位置 = g位置(p駒位置.行, p駒位置.列)<br>
　　　　.駒移動 = p駒移動<br>
　　　　.成駒移動 = p成駒移動<br>
　　End With<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'駒の正式名称を受け取って、その駒特有の情報を設定する</span><br>
Public Function 駒作成(ByVal arg名称 As String, _<br>
　　　　　　　　　　　 ByVal arg先手 As Boolean, _<br>
　　　　　　　　　　　 Optional ByVal arg位置 As g位置 = Nothing _<br>
　　　　　　　　　　　 ) As cls駒<br>
　　Dim tmp定義 As String<br>
　　Dim tmp移動 As String, tmp成移動 As String<br>
　　Select Case arg名称<br>
　　　　Case &quot;王将&quot;, &quot;玉将&quot;, &quot;王&quot;, &quot;玉&quot;<br>
　　　　　　tmp定義 = cns王将定義<br>
　　　　　　tmp移動 = cns王将移動<br>
　　　　　　tmp成移動 = &quot;&quot; <span style="color:#009900;">'成れない</span><br>
　　　　Case &quot;飛車&quot;, &quot;飛&quot;, &quot;龍&quot;<br>
　　　　　　tmp定義 = cns飛車定義<br>
　　　　　　tmp移動 = cns飛車移動<br>
　　　　　　tmp成移動 = cns龍王移動<br>
　　　　Case &quot;角行&quot;, &quot;角&quot;, &quot;馬&quot;<br>
　　　　　　tmp定義 = cns角行定義<br>
　　　　　　tmp移動 = cns角行移動<br>
　　　　　　tmp成移動 = cns龍馬移動<br>
　　　　Case &quot;金将&quot;, &quot;金&quot;<br>
　　　　　　tmp定義 = cns金将定義<br>
　　　　　　tmp移動 = cns金将移動<br>
　　　　　　tmp成移動 = &quot;&quot; <span style="color:#009900;">'成れない</span><br>
　　　　Case &quot;銀将&quot;, &quot;銀&quot;, &quot;全&quot;<br>
　　　　　　tmp定義 = cns銀将定義<br>
　　　　　　tmp移動 = cns銀将移動<br>
　　　　　　tmp成移動 = cns金将移動<br>
　　　　Case &quot;桂馬&quot;, &quot;桂&quot;, &quot;圭&quot;<br>
　　　　　　tmp定義 = cns桂馬定義<br>
　　　　　　tmp移動 = cns桂馬移動<br>
　　　　　　tmp成移動 = cns金将移動<br>
　　　　Case &quot;香車&quot;, &quot;香&quot;, &quot;杏&quot;<br>
　　　　　　tmp定義 = cns香車定義<br>
　　　　　　tmp移動 = cns香車移動<br>
　　　　　　tmp成移動 = cns金将移動<br>
　　　　Case &quot;歩兵&quot;, &quot;歩&quot;, &quot;と&quot;<br>
　　　　　　tmp定義 = cns歩兵定義<br>
　　　　　　tmp移動 = cns歩兵移動<br>
　　　　　　tmp成移動 = cns金将移動<br>
　　　　Case Else<br>
　　　　　　Err.Raise 9999 <span style="color:#009900;">'形式的に記述</span><br>
　　End Select<br>
　　<br>
　　Dim sSplit() As String<br>
　　sSplit = Split(tmp定義, &quot;,&quot;)<br>
　　Me.正式名称 = sSplit(0)<br>
　　Me.表示名称 = sSplit(1)<br>
　　Me.成駒名称 = sSplit(2)<br>
　　Me.表示順 = sSplit(3)<br>
　　Me.駒移動 = 駒移動設定(tmp移動)<br>
　　Me.成駒移動 = 駒移動設定(tmp成移動)<br>
　　Me.先手 = arg先手<br>
　　Set Me.駒位置 = arg位置<br>
　　<br>
　　Set 駒作成 = Me<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'駒が移動できる位置をg位置（行、列）のCollectionで返す</span><br>
Public Function 駒移動可能位置(ByRef ary盤面() As cls駒) As Collection<br>
　　Dim col位置 As New Collection<br>
　　Dim tmp移動 As Variant <span style="color:#009900;">'For Eachで使用する都合でVariant</span><br>
　　Dim tmp位置 As g位置<br>
　　Dim i As Long<br>
　　<br>
　　For Each tmp移動 In IIf(Me.成り, Me.成駒移動, Me.駒移動)<br>
　　　　For i = 1 To tmp移動.回数<br>
　　　　　　Set tmp位置 = g位置() <span style="color:#009900;">'()は省略できない</span><br>
　　　　　　<span style="color:#009900;">'先手後手で進む方向を反転させる</span><br>
　　　　　　tmp位置.行 = Me.駒位置.行 + (tmp移動.行 * i * IIf(Me.先手, 1, -1))<br>
　　　　　　tmp位置.列 = Me.駒位置.列 + (tmp移動.列 * i * IIf(Me.先手, 1, -1))<br>
　　　　　　<span style="color:#009900;">'盤外に出たら内側のForのみ抜ける</span><br>
　　　　　　If tmp位置.行 &lt; LBound(ary盤面, 1) Or _<br>
　　　　　　　 tmp位置.行 &gt; UBound(ary盤面, 1) Or _<br>
　　　　　　　 tmp位置.列 &lt; LBound(ary盤面, 2) Or _<br>
　　　　　　　 tmp位置.列 &gt; UBound(ary盤面, 2) Then<br>
　　　　　　　 Exit For<br>
　　　　　　End If<br>
　　　　　　If ary盤面(tmp位置.行, tmp位置.列) Is Nothing Then<br>
　　　　　　　　<span style="color:#009900;">'駒が無いので駒を置ける</span><br>
　　　　　　　　col位置.Add tmp位置<br>
　　　　　　Else<br>
　　　　　　　　<span style="color:#009900;">'相手の駒なら取れる、自分の駒ならそれ以上進めない</span><br>
　　　　　　　　If ary盤面(tmp位置.行, tmp位置.列).先手 &lt;&gt; Me.先手 Then<br>
　　　　　　　　　　col位置.Add tmp位置<br>
　　　　　　　　End If<br>
　　　　　　　　Exit For<br>
　　　　　　End If<br>
　　　　Next<br>
　　Next<br>
　　Set 駒移動可能位置 = col位置<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'駒の動きを定義したConstより配列を作成する</span><br>
Private Function 駒移動設定(ByVal arg動き As String) As cls移動()<br>
　　Dim ary移動() As cls移動<br>
　　Dim tmp移動 As cls移動<br>
　　Dim sSplit1() As String, sSplit2() As String<br>
　　Dim i As Long, j As Long<br>
　　<br>
　　<span style="color:#009900;">'行,列,回数;行,列,回数;・・・; 最後は;で終わる前提</span><br>
　　sSplit1 = Split(arg動き, &quot;;&quot;)<br>
　　If UBound(sSplit1) &lt; 0 Then Exit Function <span style="color:#009900;">'成らない駒</span><br>
　　ReDim ary移動(LBound(sSplit1) To UBound(sSplit1) - 1)<br>
　　For i = LBound(sSplit1) To UBound(sSplit1) - 1<br>
　　　　sSplit2 = Split(sSplit1(i), &quot;,&quot;)<br>
　　　　Set tmp移動 = New cls移動<br>
　　　　tmp移動.行 = sSplit2(LBound(sSplit2) + 0)<br>
　　　　tmp移動.列 = sSplit2(LBound(sSplit2) + 1)<br>
　　　　tmp移動.回数 = sSplit2(LBound(sSplit2) + 2)<br>
　　　　Set ary移動(i) = tmp移動<br>
　　Next<br>
　　<br>
　　駒移動設定 = ary移動<br>
      End Function</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>棋譜クラス：cls棋譜</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private pParent As Object<br>
Private pCol棋譜 As Collection<br>
Private p先手時間 As Date<br>
Private p後手時間 As Date<br>
Private p開始時刻 As Date<br>
Private p最終時刻 As Date<br><div class="br2"><br></div>
Private p手数 As Long<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 共通プロパティ：cls将棋盤、cls駒台、cls棋譜</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get Name() As String<br>
　　Name = TypeName(Me)<br>
End Property<br><div class="br2"><br></div>
Public Property Set Parent(ByVal argParent As Object)<br>
　　Set pParent = argParent<br>
End Property<br>
Public Property Get Parent() As Object<br>
　　Set Parent = pParent<br>
End Property<br><div class="br2"><br></div>
Public Property Get 手数() As Long<br>
　　手数 = Me.Parent.手数<br>
End Property<br><div class="br2"><br></div>
Public Property Get 先手() As Boolean<br>
　　先手 = Me.Parent.先手<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開プロパティ</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Get 棋譜履歴() As Collection<br>
　　Set 棋譜履歴 = pCol棋譜<br>
End Property<br><div class="br2"><br></div>
Public Property Get 棋譜(Optional ByVal arg手数 As Long) As String<br>
　　On Error Resume Next<br>
　　If pCol棋譜.Count = 0 Then Exit Property<br>
　　If arg手数 = 0 Then<br>
　　　　arg手数 = pCol棋譜.Count<br>
　　End If<br>
　　棋譜 = Split(Trim(pCol棋譜(arg手数)), &quot; &quot;)(1)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 棋譜最終() As String<br>
　　On Error Resume Next<br>
　　棋譜最終 = pCol棋譜(pCol棋譜.Count)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 消費時間(Optional ByVal arg手数 As Long) As String<br>
　　On Error Resume Next<br>
　　If pCol棋譜.Count = 0 Then Exit Property<br>
　　If arg手数 = 0 Then<br>
　　　　arg手数 = pCol棋譜.Count<br>
　　End If<br>
　　消費時間 = Split(pCol棋譜(arg手数), &quot;/&quot;)(1)<br>
　　消費時間 = Replace(消費時間, &quot;)&quot;, &quot;&quot;)<br>
End Property<br><div class="br2"><br></div>
Public Property Get 開始時刻() As Date<br>
　　開始時刻 = p開始時刻<br>
End Property<br><div class="br2"><br></div>
Public Property Get 最終時刻() As Date<br>
　　最終時刻 = p最終時刻<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' イベント</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub Class_Initialize()<br>
　　Set pCol棋譜 = New Collection<br>
　　p先手時間 = 0<br>
　　p後手時間 = 0<br>
　　p開始時刻 = Now()<br>
　　p最終時刻 = Now()<br>
End Sub<br><div class="br2"><br></div>
Private Sub Class_Terminate()<br>
　　Set pParent = Nothing<br>
　　Set pCol棋譜 = Nothing<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'棋譜はKIF形式で作成</span><br>
<span style="color:#009900;">'###1 ５ニ銀成(43) (mm:ss/hh:mm:ss)</span><br>
Public Function 棋譜作成(ByVal arg元位置 As g位置, _<br>
　　　　　　　　　　　　 ByVal arg駒先 As cls駒, _<br>
　　　　　　　　　　　　 ByRef arg成り As Boolean, _<br>
　　　　　　　　　　　　 Optional ByVal arg時間1手 As Date, _<br>
　　　　　　　　　　　　 Optional ByVal arg時間累計 As Date) As String<br>
　　Dim ary(1 To 15) As String<br>
　　Dim n4 As String * 3<br>
　　RSet n4 = Format(Me.手数, &quot;0&quot;)<br>
　　ary(1) = n4<br>
　　ary(2) = &quot; &quot;<br>
　　ary(3) = IIf(Me.先手, &quot;▲&quot;, &quot;△&quot;) &amp; StrConv(10 - arg駒先.駒位置.列, vbWide)<br>
　　ary(4) = WorksheetFunction.Text(arg駒先.駒位置.行, &quot;[DBNum1]0&quot;)<br>
　　ary(5) = IIf(arg成り, arg駒先.通常名称, arg駒先.表示名称)<br>
　　If arg元位置.行 = 0 Then<br>
　　　　ary(6) = &quot;打&quot;<br>
　　　　ary(7) = &quot;&quot;<br>
　　　　ary(8) = &quot;&quot;<br>
　　　　ary(9) = &quot;&quot;<br>
　　　　ary(10) = &quot;　　&quot;<br>
　　Else<br>
　　　　ary(6) = IIf(arg成り, &quot;成&quot;, &quot;&quot;)<br>
　　　　ary(7) = &quot;(&quot;<br>
　　　　ary(8) = 10 - arg元位置.列<br>
　　　　ary(9) = arg元位置.行<br>
　　　　ary(10) = &quot;)&quot; &amp; IIf(ary(6) = &quot;&quot;, &quot;　&quot;, &quot;&quot;)<br>
　　End If<br>
　　ary(11) = &quot; (&quot;<br>
　　If arg時間累計 = 0 Then<br>
　　　　ary(12) = Format(Now() - p最終時刻, &quot;h:mm:ss&quot;)<br>
　　　　ary(13) = &quot;/&quot;<br>
　　　　If Me.先手 Then<br>
　　　　　　p先手時間 = Format(p先手時間 + CDate(ary(12)), &quot;h:mm:ss&quot;)<br>
　　　　　　ary(14) = Format(p先手時間, &quot;h:mm:ss&quot;)<br>
　　　　Else<br>
　　　　　　p後手時間 = Format(p後手時間 + CDate(ary(12)), &quot;h:mm:ss&quot;)<br>
　　　　　　ary(14) = Format(p後手時間, &quot;h:mm:ss&quot;)<br>
　　　　End If<br>
　　Else<br>
　　　　ary(12) = Format(arg時間1手, &quot;h:mm:ss&quot;)<br>
　　　　ary(13) = &quot;/&quot;<br>
　　　　ary(14) = Format(arg時間累計, &quot;h:mm:ss&quot;)<br>
　　End If<br>
　　ary(12) = WorksheetFunction.Text(CDate(ary(12)), &quot;[m]:ss&quot;)<br>
　　　　If ary(12) = &quot;0:00&quot; Then ary(12) = &quot;0:01&quot;<br>
　　　　If Len(ary(12)) = 4 Then ary(12) = &quot; &quot; &amp; ary(12)<br>
　　ary(15) = &quot;)&quot;<br>
　　<br>
　　<span style="color:#009900;">'棋譜履歴</span><br>
　　Call 棋譜履歴手数戻し<br>
　　pCol棋譜.Add Join(ary, &quot;&quot;)<br>
　　p最終時刻 = Now()<br>
End Function<br><div class="br2"><br></div>
Public Sub 棋譜終局追加(ByVal arg文字 As String)<br>
　　Dim n4 As String * 3<br>
　　RSet n4 = Format(Me.手数, &quot;0&quot;)<br>
　　pCol棋譜.Add n4 &amp; &quot; &quot; &amp; arg文字<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 非公開メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Function KIF駒名変換(ByVal arg駒先 As cls駒, _<br>
　　　　　　　　　　　　　　 ByRef arg成り As Boolean) As String<br>
　　Select Case True<br>
　　　　Case arg成り<br>
　　　　　　KIF駒名変換 = arg駒先.通常名称<br>
　　　　Case arg駒先.成り<br>
　　　　　　Select Case arg駒先.表示名称<br>
　　　　　　　　Case &quot;銀&quot;, &quot;桂&quot;, &quot;香&quot;<br>
　　　　　　　　　　KIF駒名変換 = &quot;成&quot; &amp; arg駒先.表示名称<br>
　　　　　　　　Case Else<br>
　　　　　　　　　　KIF駒名変換 = arg駒先.表示名称<br>
　　　　　　End Select<br>
　　　　Case Else<br>
　　　　　　KIF駒名変換 = arg駒先.表示名称<br>
　　End Select<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'棋譜履歴：手数戻しに対応</span><br>
Private Sub 棋譜履歴手数戻し()<br>
　　Dim i As Long<br>
<span style="color:#009900;">'　　Me.手数 = Me.手数 + 1</span><br>
　　For i = pCol棋譜.Count To Me.手数 Step -1<br>
　　　　Call pCol棋譜.Remove(i)<br>
　　Next<br>
      End Sub</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>移動クラス：cls移動</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Public 行 As Integer<br>
Public 列 As Integer<br>
Public 回数 As Integer</td>
    </tr>
  </tbody>
</table></code></div><br>
</div>
</div>
<div class="main-indent">
<h4>位置クラス：g位置</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>VERSION 1.0 CLASS<br>
BEGIN<br>
　MultiUse = -1　<span style="color:#009900;">'True</span><br>
END<br>
Attribute VB_Name = &quot;g位置&quot;<br>
Attribute VB_GlobalNameSpace = False<br>
Attribute VB_Creatable = False<br>
Attribute VB_PredeclaredId = True<br>
Attribute VB_Exposed = False<br>
Option Explicit<br><div class="br2"><br></div>
<span style="color:#009900;">'グメーローバルインスタンスとして、</span><br>
<span style="color:#009900;">'Attribute VB_PredeclaredId = True</span><br><div class="br2"><br></div>
<span style="color:#009900;">'デフォルトメンバーとしてNewPosに、</span><br>
<span style="color:#009900;">'Attribute NewPos.VB_Description = &quot;クラスの既定のメンバー&quot;</span><br>
<span style="color:#009900;">'Attribute NewPos.VB_UserMemId = 0</span><br><div class="br2"><br></div>
Public 行 As Integer<br>
Public 列 As Integer<br><div class="br2"><br></div>
<span style="color:#009900;">'コンストラクタとして使用</span><br>
Function NewPos(Optional ByVal arg行 As Variant, _<br>
　　　　　　　　Optional ByVal arg列 As Variant) As g位置<br>
Attribute NewPos.VB_Description = &quot;クラスの既定のメンバー&quot;<br>
Attribute NewPos.VB_UserMemId = 0<br>
　　Dim obj位置 As New g位置<br>
　　If Not (IsMissing(arg行) Or IsMissing(arg列)) Then<br>
　　　　obj位置.行 = arg行<br>
　　　　obj位置.列 = arg列<br>
　　End If<br>
　　Set NewPos = obj位置<br>
      End Function</td>
    </tr>
  </tbody>
</table></code></div><br>
Attributeを変更しているので。インポート用ソースです。<br>
詳しくは、<strong><a href="EXCELVBA282_6.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_6.html">№6. Excel将棋：位置クラスをデフォルトインスタンスに変更</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、前に作った位置クラスをデフォルトインスタンスに変更します。作成するクラス全体の設計は、№2.Excel将棋：クラスの設計、こちらを参照してください。</div><br>
</div>
</div>
<div class="main-indent">
<h4>棋譜フォーム：frm棋譜</h4>
</div>
<div class="main-indent">
<div class="main-indent">
<form>
<input type="button" value="VBAをコピー" onclick="fncVbaCopy(this)">
</form>
<div class="table-scroll"><code class="vbacode"><table border="1" cellpadding="10">
  <tbody>
    <tr>
      <td>Option Explicit<br><div class="br2"><br></div>
Private pParent As Object<br>
Private EventStop As Boolean<br><div class="br2"><br></div>
Private p開始時刻 As Date<br>
Private p最終時刻 As Date<br><div class="br2"><br></div>
Private Type tKif<br>
　　手数 As Integer<br>
　　筋 As Integer<br>
　　段 As Integer<br>
　　駒 As String<br>
　　成 As String<br>
　　元筋 As Integer<br>
　　元段 As Integer<br>
　　時間1手 As Date<br>
　　時間累計 As Date<br>
End Type<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 公開プロパティ</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Property Set Parent(ByVal argParent As Object)<br>
　　Set pParent = argParent<br>
End Property<br>
Public Property Get Parent() As Object<br>
　　Set Parent = pParent<br>
End Property<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' 棋譜の出力/読込</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
<span style="color:#009900;">'拡張子&quot;.kif&quot;のShift-JISで出力</span><br>
Private Sub btn棋譜出力_Click()<br>
　　If Me.lst棋譜.ListCount = 0 Then Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'保存ファイル選択</span><br>
　　Dim vFile As Variant<br>
　　vFile = Me.Parent.Application.GetSaveAsFilename( _<br>
　　　　　　InitialFileName:=ThisWorkbook.Path &amp; &quot;\ExcelShogi.kif&quot;, _<br>
　　　　　　FileFilter:=&quot;KIFファイル,*.kif&quot;)<br>
　　If vFile = False Then<br>
　　　　Exit Sub<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'KIFファイル保存</span><br>
　　Dim i As Long<br>
　　Dim intFree As Integer<br>
　　intFree = FreeFile<br>
　　Open vFile For Output As #intFree<br>
　　Print #1, &quot;# --- Excel将棋 V1.0.0 棋譜ファイル ---&quot;<br>
　　Print #1, &quot;開始日時：&quot; &amp; Format(p開始時刻, &quot;yyyy/mm/dd(aaa) hh:mm:ss&quot;)<br>
　　Print #1, &quot;終了日時：&quot; &amp; Format(p最終時刻, &quot;yyyy/mm/dd(aaa) hh:mm:ss&quot;)<br>
　　Print #1, &quot;手合割：&quot; &amp; Me.cmb手合割<br>
　　Print #1, &quot;先手：&quot; &amp; Me.txt先手.Value<br>
　　Print #1, &quot;後手：&quot; &amp; Me.txt後手.Value<br>
　　Print #1, &quot;手数----指手---------消費時間--&quot;<br>
　　For i = 0 To Me.lst棋譜.ListCount - 1<br>
　　　　Print #intFree, Replace(Replace(Me.lst棋譜.List(i), &quot;▲&quot;, &quot;&quot;), &quot;△&quot;, &quot;&quot;)<br>
　　Next<br>
　　Close intFree<br>
　　<br>
　　MsgBox &quot;KIFファイルを出力しました。&quot; &amp; vbLf &amp; vbLf &amp; vFile<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'拡張子&quot;.kif&quot;のShift-JISのみ対応</span><br>
Private Sub btn棋譜読込_Click()<br>
　　<span style="color:#009900;">'保存ファイル選択</span><br>
　　Dim vFile As Variant<br>
　　vFile = Me.Parent.Application.GetOpenFilename(FileFilter:=&quot;KIFファイル,*.kif&quot;)<br>
　　If vFile = False Then<br>
　　　　Exit Sub<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'KIFファイルを読み込んで配列に</span><br>
　　Dim aryKif() As String<br>
　　aryKif = readKif(vFile)<br>
　　<br>
　　If Not KIF棋譜読込(aryKif) Then<br>
　　　　MsgBox &quot;指定されたKIFファイルは処理できませんでした。&quot;<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'KIF形式ファイルからの棋譜の配列を読み盤面を再現する</span><br>
Public Function KIF棋譜読込(ByRef aryKif() As String) As Boolean<br>
　　Dim ary棋譜() As tKif<br>
　　Dim s手合割 As String, s先手 As String, s後手 As String<br>
　　Dim sSplit() As String<br>
　　Dim i As Long, j As Long<br>
　　<br>
　　j = 1<br>
　　For i = LBound(aryKif) To UBound(aryKif)<br>
　　　　Select Case True<br>
　　　　　　Case Left(aryKif(i), 1) = &quot;#&quot;, Left(aryKif(i), 1) = &quot;*&quot;<br>
　　　　　　　　<span style="color:#009900;">'コメント</span><br>
　　　　　　Case Left(aryKif(i), 3) = &quot;先手：&quot;<br>
　　　　　　　　s先手 = Trim(Mid(aryKif(i), 4))<br>
　　　　　　Case Left(aryKif(i), 3) = &quot;後手：&quot;<br>
　　　　　　　　s後手 = Trim(Mid(aryKif(i), 4))<br>
　　　　　　Case Left(aryKif(i), 4) = &quot;手合割：&quot;<br>
　　　　　　　　s手合割 = Trim(Mid(aryKif(i), 5))<br>
　　　　　　Case InStr(aryKif(i), &quot; &quot;) = 0<br>
　　　　　　　　<span style="color:#009900;">'無視</span><br>
　　　　　　Case Else<br>
　　　　　　　　sSplit = Split(Trim(aryKif(i)), &quot; &quot;)<br>
　　　　　　　　If IsNumeric(sSplit(0)) Then<br>
　　　　　　　　　　ReDim Preserve ary棋譜(1 To j)<br>
　　　　　　　　　　ary棋譜(j) = parseKif(aryKif(i))<br>
　　　　　　　　　　If ary棋譜(j).手数 &lt; 0 Then<br>
　　　　　　　　　　　　KIF棋譜読込 = False<br>
　　　　　　　　　　　　Exit Function<br>
　　　　　　　　　　End If<br>
　　　　　　　　　　j = j + 1<br>
　　　　　　　　End If<br>
　　　　End Select<br>
　　Next<br>
　　<br>
　　Me.txt先手.Value = s先手<br>
　　Me.txt後手.Value = s後手<br>
　　Me.cmb手合割.Value = s手合割<br>
　　<br>
　　Call ControlsEnable(False) <span style="color:#009900;">'全コントロールを使用不可</span><br>
　　<br>
　　If Me.Parent.ゲーム開始(s手合割, False) Then<br>
　　　　Call KIF棋譜再現(ary棋譜)<br>
　　End If<br>
　　Call ControlsEnable(True) <span style="color:#009900;">'全コントロールを使用可</span><br>
　　<br>
　　KIF棋譜読込 = True<br>
End Function<br><div class="br2"><br></div>
Private Sub KIF棋譜再現(ByRef ary棋譜() As tKif)<br>
　　On Error GoTo ErrExit<br>
　　Dim i先行 As Integer, i元行 As Integer<br>
　　Dim i先列 As Integer, i元列 As Integer<br>
　　Dim 先位置 As g位置, 元位置 As g位置<br>
　　Dim i As Long<br>
　　<br>
　　For i = LBound(ary棋譜) To UBound(ary棋譜)<br>
　　　　If ary棋譜(i).駒 &lt;&gt; &quot;&quot; And ary棋譜(i).筋 &gt; 0 Then<br>
　　　　　　Set 先位置 = Me.Parent.棋譜位置(ary棋譜(i).筋, ary棋譜(i).段)<br>
　　　　　　Set 元位置 = Me.Parent.棋譜位置(ary棋譜(i).元筋, ary棋譜(i).元段)<br>
　　　　　　Call Me.Parent.自動着手(ary棋譜(i).駒, _<br>
　　　　　　　　　　　　　　　　　　元位置, 先位置, ary棋譜(i).成, _<br>
　　　　　　　　　　　　　　　　　　ary棋譜(i).時間1手, ary棋譜(i).時間累計, _<br>
　　　　　　　　　　　　　　　　　　50) <span style="color:#009900;">'最後は再生スピード（ミリセカンド）</span><br>
　　　　　　If Me.lst棋譜.ListCount &lt;&gt; i Then<br>
　　　　　　　　Stop <span style="color:#009900;">'KIF解析不足なので確認用</span><br>
　　　　　　End If<br>
　　　　Else<br>
　　　　　　Me.lst棋譜.AddItem Right(&quot;　 &quot; &amp; ary棋譜(i).手数, 3) &amp; &quot; &quot; &amp; ary棋譜(i).駒<br>
　　　　　　Me.lst棋譜.ListIndex = Me.lst棋譜.ListCount - 1<br>
　　　　　　Me.Caption = ary棋譜(i).駒<br>
　　　　End If<br>
　　Next<br>
　　Exit Sub<br>
　　<br>
ErrExit:<br>
　　MsgBox &quot;棋譜の再現に失敗しました。&quot;<br>
End Sub<br><div class="br2"><br></div>
Private Function parseKif(ByVal argKif As String) As tKif<br>
　　On Error GoTo ErrExit<br>
　　Const cns漢数字 = &quot;一二三四五六七八九&quot;<br>
　　Dim sSplit() As String<br>
　　argKif = Replace(argKif, &quot;(&quot;, &quot; &quot;)<br>
　　argKif = Replace(argKif, &quot;)&quot;, &quot; &quot;)<br>
　　argKif = Replace(argKif, &quot;/&quot;, &quot; &quot;)<br>
　　argKif = WorksheetFunction.Trim(argKif)<br>
　　sSplit = Split(argKif, &quot; &quot;)<br>
　　<br>
　　parseKif.手数 = sSplit(0)<br>
　　If Not IsNumeric(sSplit(0)) Or _<br>
　　　 Left(sSplit(1), 1) &lt; &quot;１&quot; Or Left(sSplit(1), 1) &gt; &quot;９&quot; Then<br>
　　　 parseKif.駒 = sSplit(1)<br>
　　　　Exit Function<br>
　　End If<br>
　　<br>
　　parseKif.筋 = StrConv(Left(sSplit(1), 1), vbNarrow)<br>
　　parseKif.段 = InStr(cns漢数字, Mid(sSplit(1), 2, 1))<br>
　　If Mid(sSplit(1), 3, 1) = &quot;成&quot; Then<br>
　　　　parseKif.駒 = Mid(sSplit(1), 4, 1)<br>
　　Else<br>
　　　　parseKif.駒 = Mid(sSplit(1), 3, 1)<br>
　　End If<br>
　　If Right(sSplit(1), 1) = &quot;成&quot; Then<br>
　　　　parseKif.成 = &quot;成&quot;<br>
　　End If<br>
　　<br>
　　Select Case UBound(sSplit)<br>
　　　　Case 3<br>
　　　　　　parseKif.時間1手 = mmss2hhmmss(sSplit(2))<br>
　　　　　　parseKif.時間累計 = CDate(sSplit(3))<br>
　　　　Case Is &gt;= 4<br>
　　　　　　parseKif.元筋 = Left(sSplit(2), 1)<br>
　　　　　　parseKif.元段 = Right(sSplit(2), 1)<br>
　　　　　　parseKif.時間1手 = mmss2hhmmss(sSplit(3))<br>
　　　　　　parseKif.時間累計 = CDate(sSplit(4))<br>
　　　　Case Else<br>
　　　　　　parseKif.手数 = -1<br>
　　　　　　Exit Function<br>
　　End Select<br>
　　Exit Function<br>
　　<br>
ErrExit:<br>
　　parseKif.手数 = -1<br>
End Function<br><div class="br2"><br></div>
Private Function mmss2hhmmss(ByVal mmss As String) As Date<br>
　　If Len(mmss) = Len(Replace(mmss, &quot;:&quot;, &quot;&quot;)) + 1 Then<br>
　　　　mmss = &quot;0:&quot; &amp; mmss<br>
　　End If<br>
　　If IsDate(mmss) Then<br>
　　　　mmss2hhmmss = CDate(mmss)<br>
　　Else<br>
　　　　mmss2hhmmss = 0<br>
　　End If<br>
End Function<br><div class="br2"><br></div>
Private Function readKif(ByVal argFile As String, _<br>
　　　　　　　　　　　　 Optional ByVal CharSet As String = &quot;SHIFT-JIS&quot;) As String()<br>
　　Dim strRec As String<br>
　　Dim aryRec() As String<br>
　　<br>
　　<span style="color:#009900;">'SHIFT-JISで読んで&quot;先手：&quot;が無ければUTF-8で読み直す</span><br>
　　strRec = readStream(argFile, CharSet)<br>
　　If UCase(CharSet) = &quot;SHIFT-JIS&quot; And InStr(strRec, &quot;先手：&quot;) = 0 Then<br>
　　　　strRec = readStream(argFile, &quot;UTF-8&quot;)<br>
　　End If<br>
　　<br>
　　readKif = Split(Replace(strRec, vbCrLf, vbLf), vbLf)<br>
End Function<br><div class="br2"><br></div>
Private Function readStream(ByVal argFile As String, _<br>
　　　　　　　　　　　　　　ByVal CharSet As String) As String<br>
　　With CreateObject(&quot;ADODB.Stream&quot;)<br>
　　　　.CharSet = CharSet<br>
　　　　.Open<br>
　　　　.LoadFromFile argFile<br>
　　　　readStream = .ReadText<br>
　　　　.Close<br>
　　End With<br>
End Function<br><div class="br2"><br></div>
<span style="color:#009900;">'Me.Enabledでは、VBA終了時にフォームが戻らない場合があったので対応</span><br>
Private Sub ControlsEnable(ByVal argEnabled As Boolean)<br>
　　Dim ctl As Control<br>
　　For Each ctl In Me.Controls<br>
　　　　ctl.Enabled = argEnabled<br>
　　Next<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' イベント：棋譜以外</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Private Sub UserForm_Initialize()<br>
　　With Me.cmb手合割<br>
　　　　.Clear<br>
　　　　.AddItem &quot;平手&quot;<br>
　　　　.AddItem &quot;香落ち&quot;<br>
　　　　.AddItem &quot;角落ち&quot;<br>
　　　　.AddItem &quot;飛車落ち&quot;<br>
　　　　.AddItem &quot;飛車香落ち&quot;<br>
　　　　.AddItem &quot;二枚落ち&quot;<br>
　　　　.AddItem &quot;四枚落ち&quot;<br>
　　　　.AddItem &quot;六枚落ち&quot;<br>
　　　　.AddItem &quot;八枚落ち&quot;<br>
　　　　.AddItem &quot;十枚落ち&quot;<br>
　　　　.ListIndex = 0<br>
　　End With<br>
　　Me.chk大橋流.Value = False<br>
　　EventStop = False<br>
End Sub<br><div class="br2"><br></div>
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)<br>
　　If MsgBox(&quot;Excel将棋を終了しますか?&quot;, vbYesNo, &quot;終局確認&quot;) = vbNo Then<br>
　　　　Cancel = True<br>
　　　　Exit Sub<br>
　　End If<br>
End Sub<br><div class="br2"><br></div>
Private Sub UserForm_Terminate()<br>
　　On Error Resume Next<br>
　　Call Me.Parent.ゲーム終了<br>
End Sub<br><div class="br2"><br></div>
Private Sub btn対局開始_Click()<br>
　　If 親オブジェク喪失() Then Exit Sub<br>
　　Me.lst棋譜.Clear<br>
　　Call Me.Parent.ゲーム開始(Me.cmb手合割.Value, Me.chk大橋流.Value)<br>
　　Call 先手後手表示<br>
End Sub<br><div class="br2"><br></div>
Private Sub lst棋譜_Change()<br>
　　If 親オブジェク喪失() Then Exit Sub<br>
　　If EventStop Then Exit Sub<br>
　　<br>
　　<span style="color:#009900;">'詰み、投了</span><br>
　　If Me.lst棋譜.ListIndex &gt; 0 Then<br>
　　　　If Len(Me.lst棋譜.List(Me.lst棋譜.ListIndex)) &lt; 10 Then<br>
　　　　　　Call Me.Parent.特定局面再現(Me.lst棋譜.ListIndex)<br>
　　　　　　Me.Caption = Me.lst棋譜.List(Me.lst棋譜.ListIndex)<br>
　　　　　　Exit Sub<br>
　　　　End If<br>
　　End If<br>
　　<br>
　　<span style="color:#009900;">'指定手数の局面を再現</span><br>
　　Call Me.Parent.特定局面再現(Me.lst棋譜.ListIndex + 1)<br>
　　Call 先手後手表示<br>
End Sub<br><div class="br2"><br></div>
Public Sub 棋譜追加(ByVal arg棋譜 As String)<br>
　　EventStop = True<br>
　　Me.lst棋譜.AddItem arg棋譜<br>
　　Me.lst棋譜.ListIndex = Me.lst棋譜.ListCount - 1<br>
　　Call 先手後手表示<br>
　　EventStop = False<br>
End Sub<br><div class="br2"><br></div>
<span style="color:#009900;">'**********************************************************************</span><br>
<span style="color:#009900;">' メソッド</span><br>
<span style="color:#009900;">'**********************************************************************</span><br><div class="br2"><br></div>
Public Sub 棋譜表示(ByVal arg棋譜 As Collection, _<br>
　　　　　　　　　　ByVal arg開始時刻 As Date, _<br>
　　　　　　　　　　ByVal arg最終時刻)<br>
　　EventStop = True<br>
　　p開始時刻 = arg開始時刻<br>
　　p最終時刻 = arg最終時刻<br>
　　<br>
　　Dim vItem As Variant<br>
　　Me.lst棋譜.Clear<br>
　　For Each vItem In arg棋譜<br>
　　　　Me.lst棋譜.AddItem vItem<br>
　　Next<br>
　　Me.lst棋譜.ListIndex = Me.lst棋譜.ListCount - 1<br>
　　<br>
　　Call 先手後手表示<br>
　　EventStop = False<br>
End Sub<br><div class="br2"><br></div>
Private Sub 先手後手表示()<br>
　　Me.Caption = IIf(Me.lst棋譜.ListIndex Mod 2, &quot;▲先手番です&quot;, &quot;△後手番です&quot;)<br>
End Sub<br><div class="br2"><br></div>
Private Function 親オブジェク喪失() As Boolean<br>
　　If TypeName(Me.Parent) Like &quot;cls将棋*&quot; Then<br>
　　　　Exit Function<br>
　　End If<br>
　　MsgBox &quot;オブジェクトが破棄されています。&quot;<br>
　　親オブジェク喪失 = True<br>
　　Unload Me<br>
End Function<br>
</td>
    </tr>
  </tbody>
</table></code></div><br>
フォームのレイアウトやコントロール名は以下を参照してください、<br>
<strong><a href="EXCELVBA282_12.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_12.html">№12. Excel将棋：棋譜をユーザーフォームに表示する</a></strong><div class="details">Excelで将棋を作ってみましょう。人vs人で動かしてゲームとして成立するところまでが当面の目標です。今回は、ユーザーフォームを作成し、初手からの棋譜を表示できるようにします。シート操作ができるように、ユーザーフォームはモードレスで表示します。</div><br>
</div>
</div>

          
<HR>
<div class="ads1">
<center>
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yama3 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="8239480723"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="6847508570"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</center>
</div>
          <section>
          
          </section>
          <section id="new">
<br><h3><A name="new">新着記事<span class="newicon">NEW</span> </a>・・・<A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧を見る</A></h3><p><A href="../vba100/VBA100_100.html" tppabs="https://excel-ubara.com/vba100/VBA100_100.html">VBA100本ノック 100本目：WEBから100本ノックのリストを取得｜VBA練習問題</A>（3月3日）<br>
<A href="../vba100/VBA100_099.html" tppabs="https://excel-ubara.com/vba100/VBA100_099.html">VBA100本ノック 99本目：自動席替え（行列と前後左右が全て違うように）｜VBA練習問題</A>（3月2日）<br>
<A href="../vba100/VBA100_098.html" tppabs="https://excel-ubara.com/vba100/VBA100_098.html">VBA100本ノック 98本目：席替えルールが守られているか確認｜VBA練習問題</A>（3月1日）<br>
<A href="../vba100/VBA100_097.html" tppabs="https://excel-ubara.com/vba100/VBA100_097.html">VBA100本ノック 97本目：Accessデータを取得（グループ集計）｜VBA練習問題</A>（2月27日）<br>
<A href="../vba100/VBA100_096.html" tppabs="https://excel-ubara.com/vba100/VBA100_096.html">VBA100本ノック 96本目：Accessデータを取得（マスタ結合&amp;抽出）｜VBA練習問題</A>（2月26日）<br>
<A href="../vba100/VBA100_095.html" tppabs="https://excel-ubara.com/vba100/VBA100_095.html">VBA100本ノック 95本目：図形のテキストを検索するフォーム作成｜VBA練習問題</A>（2月24日）<br>
<A href="../vba100/VBA100_094.html" tppabs="https://excel-ubara.com/vba100/VBA100_094.html">VBA100本ノック 94本目：表範囲からHTMLのtableタグを作成｜VBA練習問題</A>（2月23日）<br>
<A href="../vba100/VBA100_093.html" tppabs="https://excel-ubara.com/vba100/VBA100_093.html">VBA100本ノック 93本目：複数ブックを連結して再分割｜VBA練習問題</A>（2月22日）<br>
<A href="../vba100/VBA100_092.html" tppabs="https://excel-ubara.com/vba100/VBA100_092.html">VBA100本ノック 92本目：セルの色を16進で返す関数｜VBA練習問題</A>（2月20日）<br>
<A href="../vba100/VBA100_091.html" tppabs="https://excel-ubara.com/vba100/VBA100_091.html">VBA100本ノック 91本目：時間計算（残業時間の月間合計）｜VBA練習問題</A>（2月19日）<br></p>

          </section>
          <section id="rank">
<br><h3><A name="rank">アクセスランキング </a>・・・ <A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">ランキング一覧を見る</A></h3><p>1.<A href="../excelvba1/EXCELVBA318.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA318.html">最終行の取得（End,Rows.Count）｜VBA入門</A><br>2.<A href="../excelvba1/EXCELVBA311.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA311.html">RangeとCellsの使い方｜VBA入門</A><br>3.<A href="../excelvba1/EXCELVBA312.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA312.html">変数宣言のDimとデータ型｜VBA入門</A><br>4.<A href="../excelvba1/EXCELVBA301.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA301.html">マクロって何？VBAって何？｜VBA入門</A><br>5.<A href="../excelvba1/EXCELVBA310.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA310.html">Range以外の指定方法（Cells,Rows,Columns）｜VBA入門</A><br>6.<A href="../excelvba1/EXCELVBA341.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA341.html">セルのコピー&amp;値の貼り付け（PasteSpecial）｜VBA入門</A><br>7.<A href="../excelvba1/EXCELVBA316.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA316.html">繰り返し処理（For Next)｜VBA入門</A><br>8.<A href="../excelvba1/EXCELVBA308.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA308.html">セルに文字を入れるとは（Range,Value）｜VBA入門</A><br>9.<A href="../excelvba1/EXCELVBA304.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA304.html">マクロはどこに書くの（VBEの起動）｜VBA入門</A><br>10.<A href="../excelvba1/EXCELVBA306.html" tppabs="https://excel-ubara.com/excelvba1/EXCELVBA306.html">とにかく書いてみよう（Sub,End Sub）｜VBA入門</A><br></p>
          </section>
<br>
          <HR>
          <div><ul>
<li><a href="../index.htm" tppabs="https://excel-ubara.com/">ホーム</a></li>
<li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編</a></li>
<li><a href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</a></li>
<li><span class="strrev2"><strong>Excel将棋：ひとまず完成、これまでとこれから(№18)</strong></span></li>
</ul></div><br>
          <strong>このサイトがお役に立ちましたら「シェア」「Bookmark」をお願いいたします。</strong><br>
          <div class="ninja_onebutton">
            <script type="text/javascript">
              //<![CDATA[
              (function(d){
              if(typeof(window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2)=='undefined'){
                  document.write("<sc"+"ript type='text\/javascript' src='\/\/omt.shinobi.jp\/b\/dbb4ddbe09aac6bed0b2564afb27c6f2'><\/sc"+"ript>");
              }else{
                  window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2.ONETAGButton_Load();}
              })(document);
              //]]>
            </script><span class="ninja_onebutton_hidden" style="display:none;"></span><span style="display:none;" class="ninja_onebutton_hidden"></span>
          </div>
<br>
          <script>
            (function() {
              var cx = 'partner-pub-6511020045004282:1071452572';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:searchbox-only></gcse:searchbox-only>
<br>
          記述には細心の注意をしたつもりですが、<br>
          間違いやご指摘がありましたら、<A href="../query.html" tppabs="https://excel-ubara.com/query.html" target="_blank">「お問い合わせ」</A>からお知らせいただけると幸いです。<br>
          掲載のVBAコードは動作を保証するものではなく、あくまでVBA学習のサンプルとして掲載しています。<br>
          掲載のVBAコードは自己責任でご使用ください。万一データ破損等の損害が発生しても責任は負いません。
        </section>
      </div> <!--/#main-->

      <div id="sub">
        <nav>
          <h2>エクセル全般</h2>
          <ul class="submenu">
            <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
            <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
            <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
            <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
            <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
            <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
          </ul>
          <h2>マクロVBA入門編</h2>
          <ul class="submenu">
            <li><A href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</A></li>
            <li><A href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</A></li>
            <li><A href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</A></li>
            <li><A href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</A></li>
            <li><A href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</A></li>
            <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
            <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
          </ul>
          <h2>マクロVBA応用編</h2>
          <ul class="submenu">
            <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
            <li><A href="../vba_class/index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
            <li><A href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
            <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
            <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
            <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
          </ul>
          <h2>その他（Excel以外）</h2>
          <ul class="submenu">
            <li><a href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">SQL入門</a></li>
            <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">スプレッドシート入門</A></li>
            <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">GAS入門</A></li>
            <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">Python入門</A></li>
          </ul>
          <h2>サイト案内</h2>
          <ul class="submenu">
            <li><A href="../EXCELNEW.html" tppabs="https://excel-ubara.com/EXCELNEW.html">新着記事一覧</A></li>
            <li><A href="../EXCELRANK.html" tppabs="https://excel-ubara.com/EXCELRANK.html">アクセスランキング</A></li>
            <li><A href="../sitemap.html" tppabs="https://excel-ubara.com/sitemap.html">サイトマップ</A></li>
            <li><a href="../business/index.htm" tppabs="https://excel-ubara.com/business/">事業案内</a></li>
            <li><A href="../query.html" tppabs="https://excel-ubara.com/query.html">お問い合わせ&nbsp&nbsp</A></li>
          </ul>
        </nav>

        <section>
          
<HR>
<div class="ads1">
<CENTER>
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yama22 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="9686142173"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</CENTER>
</div>
          

          

          <HR>
          <div><ul>
<li><a href="../index.htm" tppabs="https://excel-ubara.com/">ホーム</a></li>
<li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">マクロVBA応用編</a></li>
<li><a href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</a></li>
<li><span class="strrev2"><strong>Excel将棋：ひとまず完成、これまでとこれから(№18)</strong></span></li>
</ul></div><br>
          このサイトがお役に立ちましたら「シェア」「Bookmark」をお願いいたします。<br>

          <div class="ninja_onebutton">
            <script type="text/javascript">
              //<![CDATA[
              (function(d){
              if(typeof(window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2)=='undefined'){
                  document.write("<sc"+"ript type='text\/javascript' src='\/\/omt.shinobi.jp\/b\/dbb4ddbe09aac6bed0b2564afb27c6f2'><\/sc"+"ript>");
              }else{
                  window.NINJA_CO_JP_ONETAG_BUTTON_dbb4ddbe09aac6bed0b2564afb27c6f2.ONETAGButton_Load();}
              })(document);
              //]]>
            </script><span class="ninja_onebutton_hidden" style="display:none;"></span><span style="display:none;" class="ninja_onebutton_hidden"></span>
          </div>
          本文下部へ<br>
          <div class="main-indent">
            <strong><A href="#same">同じテーマの記事</A></strong><br>
            <strong><A href="#new">新着記事</A></strong><br>
            <strong><A href="#rank">アクセスランク</A></strong><br>
          </div>
          <div class="ads2">
            <script>
              (function() {
                var cx = 'partner-pub-6511020045004282:1071452572';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:searchbox-only></gcse:searchbox-only>
          </div>
<br><nav><h2>おすすめ関連記事</h2><ul class="submenu"><li><a href="EXCELVBA282.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282.html">№1. Excel将棋：マクロVBAの学習用</a></li><li><a href="EXCELVBA282_2.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_2.html">№2. Excel将棋：クラスの設計</a></li><li><a href="EXCELVBA282_3.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_3.html">№3. Excel将棋：駒クラスの作成</a></li><li><a href="EXCELVBA282_4.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_4.html">№4. Excel将棋：駒クラスの単体テスト</a></li><li><a href="EXCELVBA282_5.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_5.html">№5. Excel将棋：駒台クラスの作成&amp;単体テスト</a></li><li><a href="EXCELVBA282_6.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_6.html">№6. Excel将棋：位置クラスをデフォルトインスタンスに変更</a></li><li><a href="EXCELVBA282_7.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_7.html">№7. Excel将棋：将棋盤クラスの作成&amp;単体テスト</a></li><li><a href="EXCELVBA282_8.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_8.html">№8. Excel将棋：将棋進行クラスの作成</a></li><li><a href="EXCELVBA282_9.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_9.html">№9. Excel将棋：駒を動かす</a></li><li><a href="EXCELVBA282_10.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_10.html">№10. Excel将棋：相手の駒を取る、持ち駒を打つ</a></li><li><a href="EXCELVBA282_11.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_11.html">№11. Excel将棋：駒を成る</a></li><li><a href="EXCELVBA282_12.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_12.html">№12. Excel将棋：棋譜をユーザーフォームに表示する</a></li><li><a href="EXCELVBA282_13.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_13.html">№13. Excel将棋：棋譜選択でその時点の盤面に戻す</a></li><li><a href="EXCELVBA282_14.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_14.html">№14. Excel将棋：棋譜ファイルの出力と読込自動再生</a></li><li><a href="EXCELVBA282_15.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_15.html">№15. Excel将棋：反則<br>(禁じ手)判定</a></li><li><a href="EXCELVBA282_16.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_16.html">№16. Excel将棋：終局<br></a></li><li><a href="EXCELVBA282_17.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_17.html">№17. Excel将棋：千日手と連続王手の千日手</a></li><li><a href="EXCELVBA282_18.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_18.html">№18 Excel将棋：ひとまず完成、これまでとこれから</a></li><li><a href="EXCELVBA282_19.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA282_19.html">№19 Excel将棋：棋譜ファイルから対局一覧作成</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_09.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_09.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_09.zip" target="_blank">shogi_09.zip</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_09.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_09.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_09.xlsm" target="_blank">shogi_09.xlsm</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_10.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_10.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_10.zip" target="_blank">shogi_10.zip</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_10.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_10.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_10.xlsm" target="_blank">shogi_10.xlsm</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_11.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_11.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_11.zip" target="_blank">shogi_11.zip</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_11.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_11.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_11.xlsm" target="_blank">shogi_11.xlsm</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_12.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_12.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_12.zip" target="_blank">shogi_12.zip</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_12.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_12.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_12.xlsm" target="_blank">shogi_12.xlsm</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_13.zip  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_13.zip'" tppabs="https://excel-ubara.com/excelvba5/shogi_13.zip" target="_blank">shogi_13.zip</a></li><li><a href="javascript:if(confirm('https://excel-ubara.com/excelvba5/shogi_13.xlsm  \n\nļ޷ Teleport Ultra , Ϊ ļδҵ  \n\nڷϴ?'))window.location='https://excel-ubara.com/excelvba5/shogi_13.xlsm'" tppabs="https://excel-ubara.com/excelvba5/shogi_13.xlsm" target="_blank">shogi_13.xlsm</a></li><li><a href="../excelsample/shogi_14.zip" tppabs="https://excel-ubara.com/excelsample/shogi_14.zip" target="_blank">shogi_14.zip</a></li><li><a href="../excelsample/shogi_14.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_14.xlsm" target="_blank">shogi_14.xlsm</a></li><li><a href="../excelsample/shogi_15.zip" tppabs="https://excel-ubara.com/excelsample/shogi_15.zip" target="_blank">shogi_15.zip</a></li><li><a href="../excelsample/shogi_15.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_15.xlsm" target="_blank">shogi_15.xlsm</a></li><li><a href="../excelsample/shogi_16.zip" tppabs="https://excel-ubara.com/excelsample/shogi_16.zip" target="_blank">shogi_16.zip</a></li><li><a href="../excelsample/shogi_16.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_16.xlsm" target="_blank">shogi_16.xlsm</a></li><li><a href="../excelsample/shogi_17.zip" tppabs="https://excel-ubara.com/excelsample/shogi_17.zip" target="_blank">shogi_17.zip</a></li><li><a href="../excelsample/shogi_17.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_17.xlsm" target="_blank">shogi_17.xlsm</a></li><li><a href="../excelsample/shogi_19.zip" tppabs="https://excel-ubara.com/excelsample/shogi_19.zip" target="_blank">shogi_19.zip</a></li><li><a href="../excelsample/shogi_19.xlsm" tppabs="https://excel-ubara.com/excelsample/shogi_19.xlsm" target="_blank">shogi_19.xlsm</a></li><li><a href="../excel_download.html" tppabs="https://excel-ubara.com/excel_download.html" target="_blank">エクセルのサンプルダウンロード</a></li><li><a href="EXCELVBA269.html" tppabs="https://excel-ubara.com/excelvba5/EXCELVBA269.html" target="_blank">VBAコードの全プロシージャー・プロパティ一覧を取得</a></li></ul></nav>
          

          
<HR>
<div class="ads2">
<script async src="../../pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" tppabs="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 新サイド下 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6511020045004282"
     data-ad-slot="1968934163"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div><br>
        </section>
      </div> <!--/#sub-->
    </div> <!--/#contents-in-->
  </div> <!--/#contents-->

  <footer>
    <div id="footermenu" class="inner">
      <ul>
        <li><a href="../excel_index.html" tppabs="https://excel-ubara.com/excel_index.html">■Excel全般</a></li>
        <li><A href="../excel1/index.htm" tppabs="https://excel-ubara.com/excel1/">エクセル入門</A></li>
        <li><A href="../excel2/index.htm" tppabs="https://excel-ubara.com/excel2/">エクセル基本操作</A></li>
        <li><A href="../excel3/index.htm" tppabs="https://excel-ubara.com/excel3/">エクセル関数応用</A></li>
        <li><A href="../excel4/index.htm" tppabs="https://excel-ubara.com/excel4/">エクセル挑戦問題</A></li>
        <li><A href="../EXCEL/excel_reference.html" tppabs="https://excel-ubara.com/EXCEL/excel_reference.html">Excelリファレンス</A></li>
        <li><A href="../excel5/index.htm" tppabs="https://excel-ubara.com/excel5/">エクセル雑感</A></li>
      </ul>
      <ul>
        <li><a href="../excel_vba1.html" tppabs="https://excel-ubara.com/excel_vba1.html">■マクロVBA入門編</a></li>
        <li><A href="../excelvba1/index.htm" tppabs="https://excel-ubara.com/excelvba1/">マクロVBA入門</A></li>
        <li><A href="../excelvba1r/index.htm" tppabs="https://excel-ubara.com/excelvba1r/">マクロVBA再入門</A></li>
        <li><A href="../excelvba2/index.htm" tppabs="https://excel-ubara.com/excelvba2/">マクロ記録でVBA</A></li>
        <li><A href="../excelvba9/index.htm" tppabs="https://excel-ubara.com/excelvba9/">マクロVBA練習問題</A></li>
        <li><A href="../MOS_VBA/index.htm" tppabs="https://excel-ubara.com/MOS_VBA/">VBAエキスパート対策</A></li>
        <li><A href="../excelvba8/index.htm" tppabs="https://excel-ubara.com/excelvba8/">マクロVBA関数</A></li>
        <li><A href="../vba100/index.htm" tppabs="https://excel-ubara.com/vba100/">VBA100本ノック</A></li>
      </ul>
      <ul>
        <li><a href="../excel_vba2.html" tppabs="https://excel-ubara.com/excel_vba2.html">■マクロVBA応用編</a></li>
        <li><A href="../excelvba3/index.htm" tppabs="https://excel-ubara.com/excelvba3/">ユーザーフォーム入門</A></li>
        <li><A href="../vba_class/index.htm" tppabs="https://excel-ubara.com/vba_class/">VBAクラス入門</A></li>
        <li><A href="index.htm" tppabs="https://excel-ubara.com/excelvba5/">マクロVBAサンプル集</A></li>
        <li><A href="../excelvba4/index.htm" tppabs="https://excel-ubara.com/excelvba4/">マクロVBA技術解説</A></li>
        <li><A href="../excelvba7/index.htm" tppabs="https://excel-ubara.com/excelvba7/">エクセル顧客管理</A></li>
        <li><A href="../EXCEL/vba_reference.html" tppabs="https://excel-ubara.com/EXCEL/vba_reference.html">VBAリファレンス</A></li>
      </ul>
      <ul>
        <li><A href="../python/index.htm" tppabs="https://excel-ubara.com/python/">■Python入門</A></li>
        <li><a href="../vba_sql/index.htm" tppabs="https://excel-ubara.com/vba_sql/">■SQL入門</a></li>
        <li><A href="../spreadsheet1/index.htm" tppabs="https://excel-ubara.com/spreadsheet1/">■スプレッドシート入門</A></li>
        <li><A href="../apps_script1/index.htm" tppabs="https://excel-ubara.com/apps_script1/">■Google Apps Script入門</A></li>
        <li><A href="../excel_course/index.htm" tppabs="https://excel-ubara.com/excel_course/">■エクセル講座セミナー</A></li>
        <li><A href="../business/index.htm" tppabs="https://excel-ubara.com/business/">■事業案内</A></li>
        <li><A href="../business/sitemap.html" tppabs="https://excel-ubara.com/business/sitemap.html">■サイトマップ</A></li>
      </ul>
    </div> <!--/footermenu-->
    <div id="copyright">
      <small>エクセルの神髄 ｜ Copyright&copy; 2010 <A href="../index.htm" tppabs="https://excel-ubara.com/">鵜原パソコンソフト研究所</A></small>
    </div>
  </footer>

  <p class="nav-fix-pos-pagetop"><a href="#">↑</a></p>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37178461-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
<!--License20150309TPg-->
</body>
</html>
